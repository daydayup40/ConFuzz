

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vtrace.platforms.win32 &mdash; Visi Debugger  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Visi Debugger  documentation" href="../../../index.html" />
    <link rel="up" title="vtrace" href="../../vtrace.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../vtrace.html" accesskey="U">vtrace</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for vtrace.platforms.win32</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Win32 Platform Module</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># Copyright (C) 2007 Invisigoth - See LICENSE file for details</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="kn">import</span> <span class="nn">PE</span>

<span class="kn">import</span> <span class="nn">vstruct</span>
<span class="kn">import</span> <span class="nn">vstruct.builder</span> <span class="kn">as</span> <span class="nn">vs_builder</span>
<span class="kn">import</span> <span class="nn">vstruct.defs.win32</span> <span class="kn">as</span> <span class="nn">vs_win32</span>
<span class="kn">import</span> <span class="nn">vstruct.defs.windows</span> <span class="kn">as</span> <span class="nn">vs_windows</span>

<span class="kn">import</span> <span class="nn">vtrace</span>
<span class="kn">import</span> <span class="nn">vtrace.archs.i386</span> <span class="kn">as</span> <span class="nn">v_i386</span>
<span class="kn">import</span> <span class="nn">vtrace.archs.amd64</span> <span class="kn">as</span> <span class="nn">v_amd64</span>
<span class="kn">import</span> <span class="nn">vtrace.platforms.base</span> <span class="kn">as</span> <span class="nn">v_base</span>

<span class="kn">import</span> <span class="nn">envi</span>
<span class="kn">import</span> <span class="nn">envi.bits</span> <span class="kn">as</span> <span class="nn">e_bits</span>
<span class="kn">import</span> <span class="nn">envi.memory</span> <span class="kn">as</span> <span class="nn">e_mem</span>
<span class="kn">import</span> <span class="nn">envi.resolver</span> <span class="kn">as</span> <span class="nn">e_resolv</span>
<span class="kn">import</span> <span class="nn">envi.archs.i386</span> <span class="kn">as</span> <span class="nn">e_i386</span>
<span class="kn">import</span> <span class="nn">envi.archs.amd64</span> <span class="kn">as</span> <span class="nn">e_amd64</span>

<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c">#from ctypes.wintypes import *</span>

<span class="n">platdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">dbghelp</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">psapi</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">ntdll</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">advapi32</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">IsWow64Process</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Setup some ctypes helpers:</span>
<span class="c"># NOTE: we don&#39;t use LPVOID because it can return None.</span>
<span class="c">#       c_size_t is the designated platform word width int.</span>
<span class="n">LPVOID</span> <span class="o">=</span> <span class="n">c_size_t</span>
<span class="n">HANDLE</span>  <span class="o">=</span> <span class="n">LPVOID</span>
<span class="n">SIZE_T</span>  <span class="o">=</span> <span class="n">LPVOID</span>
<span class="n">QWORD</span>   <span class="o">=</span> <span class="n">c_ulonglong</span>
<span class="n">DWORD</span>   <span class="o">=</span> <span class="n">c_ulong</span>
<span class="n">WORD</span>    <span class="o">=</span> <span class="n">c_ushort</span>
<span class="n">BOOL</span>    <span class="o">=</span> <span class="n">c_ulong</span>
<span class="n">BYTE</span>    <span class="o">=</span> <span class="n">c_ubyte</span>
<span class="n">NULL</span>    <span class="o">=</span> <span class="mi">0</span>

<span class="n">INFINITE</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
<span class="n">EXCEPTION_MAXIMUM_PARAMETERS</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c"># Debug Event Types</span>
<span class="n">EXCEPTION_DEBUG_EVENT</span>       <span class="o">=</span><span class="mi">1</span>
<span class="n">CREATE_THREAD_DEBUG_EVENT</span>   <span class="o">=</span><span class="mi">2</span>
<span class="n">CREATE_PROCESS_DEBUG_EVENT</span>  <span class="o">=</span><span class="mi">3</span>
<span class="n">EXIT_THREAD_DEBUG_EVENT</span>     <span class="o">=</span><span class="mi">4</span>
<span class="n">EXIT_PROCESS_DEBUG_EVENT</span>    <span class="o">=</span><span class="mi">5</span>
<span class="n">LOAD_DLL_DEBUG_EVENT</span>        <span class="o">=</span><span class="mi">6</span>
<span class="n">UNLOAD_DLL_DEBUG_EVENT</span>      <span class="o">=</span><span class="mi">7</span>
<span class="n">OUTPUT_DEBUG_STRING_EVENT</span>   <span class="o">=</span><span class="mi">8</span>
<span class="n">RIP_EVENT</span>                   <span class="o">=</span><span class="mi">9</span>

<span class="c"># Symbol Flags</span>
<span class="n">SYMFLAG_VALUEPRESENT</span>     <span class="o">=</span> <span class="mh">0x00000001</span>
<span class="n">SYMFLAG_REGISTER</span>         <span class="o">=</span> <span class="mh">0x00000008</span>
<span class="n">SYMFLAG_REGREL</span>           <span class="o">=</span> <span class="mh">0x00000010</span>
<span class="n">SYMFLAG_FRAMEREL</span>         <span class="o">=</span> <span class="mh">0x00000020</span>
<span class="n">SYMFLAG_PARAMETER</span>        <span class="o">=</span> <span class="mh">0x00000040</span>
<span class="n">SYMFLAG_LOCAL</span>            <span class="o">=</span> <span class="mh">0x00000080</span>
<span class="n">SYMFLAG_CONSTANT</span>         <span class="o">=</span> <span class="mh">0x00000100</span>
<span class="n">SYMFLAG_EXPORT</span>           <span class="o">=</span> <span class="mh">0x00000200</span>
<span class="n">SYMFLAG_FORWARDER</span>        <span class="o">=</span> <span class="mh">0x00000400</span>
<span class="n">SYMFLAG_FUNCTION</span>         <span class="o">=</span> <span class="mh">0x00000800</span>
<span class="n">SYMFLAG_VIRTUAL</span>          <span class="o">=</span> <span class="mh">0x00001000</span>
<span class="n">SYMFLAG_THUNK</span>            <span class="o">=</span> <span class="mh">0x00002000</span>
<span class="n">SYMFLAG_TLSREL</span>           <span class="o">=</span> <span class="mh">0x00004000</span>

<span class="c"># Symbol Resolution Options</span>
<span class="n">SYMOPT_CASE_INSENSITIVE</span>         <span class="o">=</span> <span class="mh">0x00000001</span>
<span class="n">SYMOPT_UNDNAME</span>                  <span class="o">=</span> <span class="mh">0x00000002</span>
<span class="n">SYMOPT_DEFERRED_LOADS</span>           <span class="o">=</span> <span class="mh">0x00000004</span>
<span class="n">SYMOPT_NO_CPP</span>                   <span class="o">=</span> <span class="mh">0x00000008</span>
<span class="n">SYMOPT_LOAD_LINES</span>               <span class="o">=</span> <span class="mh">0x00000010</span>
<span class="n">SYMOPT_OMAP_FIND_NEAREST</span>        <span class="o">=</span> <span class="mh">0x00000020</span>
<span class="n">SYMOPT_LOAD_ANYTHING</span>            <span class="o">=</span> <span class="mh">0x00000040</span>
<span class="n">SYMOPT_IGNORE_CVREC</span>             <span class="o">=</span> <span class="mh">0x00000080</span>
<span class="n">SYMOPT_NO_UNQUALIFIED_LOADS</span>     <span class="o">=</span> <span class="mh">0x00000100</span>
<span class="n">SYMOPT_FAIL_CRITICAL_ERRORS</span>     <span class="o">=</span> <span class="mh">0x00000200</span>
<span class="n">SYMOPT_EXACT_SYMBOLS</span>            <span class="o">=</span> <span class="mh">0x00000400</span>
<span class="n">SYMOPT_ALLOW_ABSOLUTE_SYMBOLS</span>   <span class="o">=</span> <span class="mh">0x00000800</span>
<span class="n">SYMOPT_IGNORE_NT_SYMPATH</span>        <span class="o">=</span> <span class="mh">0x00001000</span>
<span class="n">SYMOPT_INCLUDE_32BIT_MODULES</span>    <span class="o">=</span> <span class="mh">0x00002000</span>
<span class="n">SYMOPT_PUBLICS_ONLY</span>             <span class="o">=</span> <span class="mh">0x00004000</span>
<span class="n">SYMOPT_NO_PUBLICS</span>               <span class="o">=</span> <span class="mh">0x00008000</span>
<span class="n">SYMOPT_AUTO_PUBLICS</span>             <span class="o">=</span> <span class="mh">0x00010000</span>
<span class="n">SYMOPT_NO_IMAGE_SEARCH</span>          <span class="o">=</span> <span class="mh">0x00020000</span>
<span class="n">SYMOPT_SECURE</span>                   <span class="o">=</span> <span class="mh">0x00040000</span>
<span class="n">SYMOPT_NO_PROMPTS</span>               <span class="o">=</span> <span class="mh">0x00080000</span>
<span class="n">SYMOPT_OVERWRITE</span>                <span class="o">=</span> <span class="mh">0x00100000</span>
<span class="n">SYMOPT_DEBUG</span>                    <span class="o">=</span> <span class="mh">0x80000000</span>

<span class="c"># Exception Types</span>
<span class="n">EXCEPTION_WAIT_0</span>                     <span class="o">=</span> <span class="mh">0x00000000</span><span class="n">L</span>    
<span class="n">EXCEPTION_ABANDONED_WAIT_0</span>           <span class="o">=</span> <span class="mh">0x00000080</span><span class="n">L</span>    
<span class="n">EXCEPTION_USER_APC</span>                   <span class="o">=</span> <span class="mh">0x000000C0</span><span class="n">L</span>    
<span class="n">EXCEPTION_TIMEOUT</span>                    <span class="o">=</span> <span class="mh">0x00000102</span><span class="n">L</span>    
<span class="n">EXCEPTION_PENDING</span>                    <span class="o">=</span> <span class="mh">0x00000103</span><span class="n">L</span>    
<span class="n">DBG_EXCEPTION_HANDLED</span>             <span class="o">=</span> <span class="mh">0x00010001</span><span class="n">L</span>    
<span class="n">DBG_CONTINUE</span>                      <span class="o">=</span> <span class="mh">0x00010002</span><span class="n">L</span>    
<span class="n">EXCEPTION_SEGMENT_NOTIFICATION</span>       <span class="o">=</span> <span class="mh">0x40000005</span><span class="n">L</span>    
<span class="n">DBG_TERMINATE_THREAD</span>              <span class="o">=</span> <span class="mh">0x40010003</span><span class="n">L</span>    
<span class="n">DBG_TERMINATE_PROCESS</span>             <span class="o">=</span> <span class="mh">0x40010004</span><span class="n">L</span>    
<span class="n">DBG_CONTROL_C</span>                     <span class="o">=</span> <span class="mh">0x40010005</span><span class="n">L</span>    
<span class="n">DBG_CONTROL_BREAK</span>                 <span class="o">=</span> <span class="mh">0x40010008</span><span class="n">L</span>    
<span class="n">DBG_COMMAND_EXCEPTION</span>             <span class="o">=</span> <span class="mh">0x40010009</span><span class="n">L</span>    
<span class="n">EXCEPTION_GUARD_PAGE_VIOLATION</span>       <span class="o">=</span> <span class="mh">0x80000001</span><span class="n">L</span>    
<span class="n">EXCEPTION_DATATYPE_MISALIGNMENT</span>      <span class="o">=</span> <span class="mh">0x80000002</span><span class="n">L</span>    
<span class="n">EXCEPTION_BREAKPOINT</span>                 <span class="o">=</span> <span class="mh">0x80000003</span><span class="n">L</span>    
<span class="n">EXCEPTION_SINGLE_STEP</span>                <span class="o">=</span> <span class="mh">0x80000004</span><span class="n">L</span>    
<span class="n">DBG_EXCEPTION_NOT_HANDLED</span>         <span class="o">=</span> <span class="mh">0x80010001</span><span class="n">L</span>    
<span class="n">EXCEPTION_ACCESS_VIOLATION</span>           <span class="o">=</span> <span class="mh">0xC0000005</span><span class="n">L</span>    
<span class="n">EXCEPTION_IN_PAGE_ERROR</span>              <span class="o">=</span> <span class="mh">0xC0000006</span><span class="n">L</span>    
<span class="n">EXCEPTION_INVALID_HANDLE</span>             <span class="o">=</span> <span class="mh">0xC0000008</span><span class="n">L</span>    
<span class="n">EXCEPTION_NO_MEMORY</span>                  <span class="o">=</span> <span class="mh">0xC0000017</span><span class="n">L</span>    
<span class="n">EXCEPTION_ILLEGAL_INSTRUCTION</span>        <span class="o">=</span> <span class="mh">0xC000001D</span><span class="n">L</span>    
<span class="n">EXCEPTION_NONCONTINUABLE_EXCEPTION</span>   <span class="o">=</span> <span class="mh">0xC0000025</span><span class="n">L</span>    
<span class="n">EXCEPTION_INVALID_DISPOSITION</span>        <span class="o">=</span> <span class="mh">0xC0000026</span><span class="n">L</span>    
<span class="n">EXCEPTION_ARRAY_BOUNDS_EXCEEDED</span>      <span class="o">=</span> <span class="mh">0xC000008C</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_DENORMAL_OPERAND</span>     <span class="o">=</span> <span class="mh">0xC000008D</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_DIVIDE_BY_ZERO</span>       <span class="o">=</span> <span class="mh">0xC000008E</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_INEXACT_RESULT</span>       <span class="o">=</span> <span class="mh">0xC000008F</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_INVALID_OPERATION</span>    <span class="o">=</span> <span class="mh">0xC0000090</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_OVERFLOW</span>             <span class="o">=</span> <span class="mh">0xC0000091</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_STACK_CHECK</span>          <span class="o">=</span> <span class="mh">0xC0000092</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_UNDERFLOW</span>            <span class="o">=</span> <span class="mh">0xC0000093</span><span class="n">L</span>    
<span class="n">EXCEPTION_INTEGER_DIVIDE_BY_ZERO</span>     <span class="o">=</span> <span class="mh">0xC0000094</span><span class="n">L</span>    
<span class="n">EXCEPTION_INTEGER_OVERFLOW</span>           <span class="o">=</span> <span class="mh">0xC0000095</span><span class="n">L</span>    
<span class="n">EXCEPTION_PRIVILEGED_INSTRUCTION</span>     <span class="o">=</span> <span class="mh">0xC0000096</span><span class="n">L</span>    
<span class="n">EXCEPTION_STACK_OVERFLOW</span>             <span class="o">=</span> <span class="mh">0xC00000FD</span><span class="n">L</span>    
<span class="n">EXCEPTION_CONTROL_C_EXIT</span>             <span class="o">=</span> <span class="mh">0xC000013A</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_MULTIPLE_FAULTS</span>      <span class="o">=</span> <span class="mh">0xC00002B4</span><span class="n">L</span>    
<span class="n">EXCEPTION_FLOAT_MULTIPLE_TRAPS</span>       <span class="o">=</span> <span class="mh">0xC00002B5</span><span class="n">L</span>    
<span class="n">EXCEPTION_REG_NAT_CONSUMPTION</span>        <span class="o">=</span> <span class="mh">0xC00002C9</span><span class="n">L</span>    

<span class="c"># Context Info</span>
<span class="n">CONTEXT_i386</span>    <span class="o">=</span> <span class="mh">0x00010000</span>    <span class="c"># this assumes that i386 and</span>
<span class="n">CONTEXT_i486</span>    <span class="o">=</span> <span class="mh">0x00010000</span>    <span class="c"># i486 have identical context records</span>
<span class="n">CONTEXT_AMD64</span>   <span class="o">=</span> <span class="mh">0x00100000</span>    <span class="c"># For amd x64...</span>

<span class="n">CONTEXT_CONTROL</span>         <span class="o">=</span> <span class="mh">0x00000001</span><span class="n">L</span> <span class="c"># SS:SP, CS:IP, FLAGS, BP</span>
<span class="n">CONTEXT_INTEGER</span>         <span class="o">=</span> <span class="mh">0x00000002</span><span class="n">L</span> <span class="c"># AX, BX, CX, DX, SI, DI</span>
<span class="n">CONTEXT_SEGMENTS</span>        <span class="o">=</span> <span class="mh">0x00000004</span><span class="n">L</span> <span class="c"># DS, ES, FS, GS</span>
<span class="n">CONTEXT_FLOATING_POINT</span>  <span class="o">=</span> <span class="mh">0x00000008</span><span class="n">L</span> <span class="c"># 387 state</span>
<span class="n">CONTEXT_DEBUG_REGISTERS</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="n">L</span> <span class="c"># DB 0-3,6,7</span>
<span class="n">CONTEXT_EXTENDED_REGISTERS</span>  <span class="o">=</span> <span class="mh">0x00000020</span><span class="n">L</span> <span class="c"># cpu specific extensions</span>
<span class="n">CONTEXT_FULL</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTEXT_CONTROL</span> <span class="o">|</span> <span class="n">CONTEXT_INTEGER</span> <span class="o">|</span> <span class="n">CONTEXT_SEGMENTS</span><span class="p">)</span>
<span class="n">CONTEXT_ALL</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTEXT_CONTROL</span> <span class="o">|</span> <span class="n">CONTEXT_INTEGER</span> <span class="o">|</span> <span class="n">CONTEXT_SEGMENTS</span> <span class="o">|</span> <span class="n">CONTEXT_FLOATING_POINT</span> <span class="o">|</span> <span class="n">CONTEXT_DEBUG_REGISTERS</span> <span class="o">|</span> <span class="n">CONTEXT_EXTENDED_REGISTERS</span><span class="p">)</span>


<span class="c"># Thread Permissions</span>
<span class="n">THREAD_ALL_ACCESS</span> <span class="o">=</span> <span class="mh">0x001f03ff</span>
<span class="n">PROCESS_ALL_ACCESS</span> <span class="o">=</span> <span class="mh">0x001f0fff</span>

<span class="c"># Memory Permissions</span>
<span class="n">PAGE_NOACCESS</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">PAGE_READONLY</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">PAGE_READWRITE</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">PAGE_WRITECOPY</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">PAGE_EXECUTE</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">PAGE_EXECUTE_READ</span> <span class="o">=</span> <span class="mh">0x20</span>
<span class="n">PAGE_EXECUTE_READWRITE</span> <span class="o">=</span> <span class="mh">0x40</span>
<span class="n">PAGE_EXECUTE_WRITECOPY</span> <span class="o">=</span> <span class="mh">0x80</span>
<span class="n">PAGE_GUARD</span> <span class="o">=</span> <span class="mh">0x100</span>
<span class="n">PAGE_NOCACHE</span> <span class="o">=</span> <span class="mh">0x200</span>
<span class="n">PAGE_WRITECOMBINE</span> <span class="o">=</span> <span class="mh">0x400</span>

<span class="c"># Map win32 permissions to envi permissions</span>
<span class="n">perm_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PAGE_NOACCESS</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">PAGE_READONLY</span><span class="p">:</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="p">,</span>
    <span class="n">PAGE_READWRITE</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">,</span>
    <span class="n">PAGE_WRITECOPY</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">,</span>
    <span class="n">PAGE_EXECUTE</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span><span class="p">,</span>
    <span class="n">PAGE_EXECUTE_READ</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="p">,</span>
    <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">,</span>
    <span class="n">PAGE_EXECUTE_WRITECOPY</span><span class="p">:</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span> <span class="o">|</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># To get win32 permssions from envi permissions</span>
<span class="n">perm_rev_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span><span class="n">PAGE_NOACCESS</span><span class="p">,</span>
    <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="p">:</span><span class="n">PAGE_READONLY</span><span class="p">,</span>
    <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="o">|</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">:</span><span class="n">PAGE_READWRITE</span><span class="p">,</span>
    <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span><span class="p">:</span><span class="n">PAGE_EXECUTE</span><span class="p">,</span>
    <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span><span class="o">|</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="p">:</span><span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span>
    <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span><span class="o">|</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="o">|</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">:</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># Memory States</span>
<span class="n">MEM_COMMIT</span> <span class="o">=</span> <span class="mh">0x1000</span>
<span class="n">MEM_FREE</span> <span class="o">=</span> <span class="mh">0x10000</span>
<span class="n">MEM_RESERVE</span> <span class="o">=</span> <span class="mh">0x2000</span>

<span class="c"># Memory Types</span>
<span class="n">MEM_IMAGE</span> <span class="o">=</span> <span class="mh">0x1000000</span>
<span class="n">MEM_MAPPED</span> <span class="o">=</span> <span class="mh">0x40000</span>
<span class="n">MEM_PRIVATE</span> <span class="o">=</span> <span class="mh">0x20000</span>

<span class="c"># Process Creation Flags</span>
<span class="n">DEBUG_ONLY_THIS_PROCESS</span> <span class="o">=</span> <span class="mh">0x02</span>

<span class="n">MAX_PATH</span><span class="o">=</span><span class="mi">260</span>

<div class="viewcode-block" id="MSR"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.MSR">[docs]</a><span class="k">class</span> <span class="nc">MSR</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;msr&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c"># The enum of NtSystemDebugControl operations</span></div>
<span class="n">SysDbgQueryModuleInformation</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SysDbgQueryTraceInformation</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SysDbgSetTracepoint</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SysDbgSetSpecialCall</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">SysDbgClearSpecialCalls</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">SysDbgQuerySpecialCalls</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">SysDbgBreakPoint</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">SysDbgQueryVersion</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">SysDbgReadVirtual</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">SysDbgWriteVirtual</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">SysDbgReadPhysical</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">SysDbgWritePhysical</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">SysDbgReadControlSpace</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">SysDbgWriteControlSpace</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">SysDbgReadIoSpace</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">SysDbgWriteIoSpace</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">SysDbgReadMsr</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">SysDbgWriteMsr</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">SysDbgReadBusData</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">SysDbgWriteBusData</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">SysDbgCheckLowMemory</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SysDbgEnableKernelDebugger</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">SysDbgDisableKernelDebugger</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">SysDbgGetAutoKdEnable</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">SysDbgSetAutoKdEnable</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">SysDbgGetPrintBufferSize</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">SysDbgSetPrintBufferSize</span> <span class="o">=</span> <span class="mi">26</span>
<span class="n">SysDbgGetKdUmExceptionEnable</span> <span class="o">=</span> <span class="mi">27</span>
<span class="n">SysDbgSetKdUmExceptionEnable</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">SysDbgGetTriageDump</span> <span class="o">=</span> <span class="mi">29</span>
<span class="n">SysDbgGetKdBlockEnable</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">SysDbgSetKdBlockEnable</span> <span class="o">=</span> <span class="mi">31</span>
<span class="n">SysDbgRegisterForUmBreakInfo</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">SysDbgGetUmBreakPid</span> <span class="o">=</span> <span class="mi">33</span>
<span class="n">SysDbgClearUmBreakPid</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">SysDbgGetUmAttachPid</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">SysDbgClearUmAttachPid</span> <span class="o">=</span> <span class="mi">36</span>

<div class="viewcode-block" id="wrmsr"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.wrmsr">[docs]</a><span class="k">def</span> <span class="nf">wrmsr</span><span class="p">(</span><span class="n">msrid</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MSR</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msrid</span>
    <span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">mptr</span> <span class="o">=</span> <span class="n">addressof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ntdll</span><span class="o">.</span><span class="n">NtSystemDebugControl</span><span class="p">(</span><span class="n">SysDbgWriteMsr</span><span class="p">,</span> <span class="n">mptr</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">PlatformException</span><span class="p">(</span><span class="s">&#39;NtSystemDebugControl Failed: 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">())</span>
    <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="rdmsr"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.rdmsr">[docs]</a><span class="k">def</span> <span class="nf">rdmsr</span><span class="p">(</span><span class="n">msrid</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MSR</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msrid</span>
    <span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mptr</span> <span class="o">=</span> <span class="n">addressof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">ntdll</span><span class="o">.</span><span class="n">NtSystemDebugControl</span><span class="p">(</span><span class="n">SysDbgReadMsr</span><span class="p">,</span> <span class="n">mptr</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mptr</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">PlatformException</span><span class="p">(</span><span class="s">&#39;NtSystemDebugControl Failed: 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">value</span>
</div>
<span class="n">SC_MANAGER_ALL_ACCESS</span>           <span class="o">=</span> <span class="mh">0xF003F</span>
<span class="n">SC_MANAGER_CREATE_SERVICE</span>       <span class="o">=</span> <span class="mh">0x0002</span>
<span class="n">SC_MANAGER_CONNECT</span>              <span class="o">=</span> <span class="mh">0x0001</span>
<span class="n">SC_MANAGER_ENUMERATE_SERVICE</span>    <span class="o">=</span> <span class="mh">0x0004</span>
<span class="n">SC_MANAGER_LOCK</span>                 <span class="o">=</span> <span class="mh">0x0008</span>
<span class="n">SC_MANAGER_MODIFY_BOOT_CONFIG</span>   <span class="o">=</span> <span class="mh">0x0020</span>
<span class="n">SC_MANAGER_QUERY_LOCK_STATUS</span>    <span class="o">=</span> <span class="mh">0x0010</span>

<span class="n">SC_ENUM_PROCESS_INFO</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">SERVICE_WIN32</span>       <span class="o">=</span> <span class="mh">0x30</span>

<span class="n">SERVICE_ACTIVE</span>      <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">SERVICE_INNACTIVE</span>   <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">SERVICE_STATE_ALL</span>   <span class="o">=</span> <span class="mh">0x03</span>

<div class="viewcode-block" id="SERVICE_STATUS_PROCESS"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.SERVICE_STATUS_PROCESS">[docs]</a><span class="k">class</span> <span class="nc">SERVICE_STATUS_PROCESS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;dwServiceType&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwCurrentState&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwControlsAccepted&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwWin32ExitCode&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwServiceSpecificExitCode&#39;</span><span class="p">,</span><span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwCheckPoint&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwWaitHint&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwProcessId&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;dwServiceFlags&#39;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">)</span>
    <span class="p">]</span>
            </div>
<div class="viewcode-block" id="ENUM_SERVICE_STATUS_PROCESS"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.ENUM_SERVICE_STATUS_PROCESS">[docs]</a><span class="k">class</span> <span class="nc">ENUM_SERVICE_STATUS_PROCESS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;lpServiceName&#39;</span><span class="p">,</span> <span class="n">c_wchar_p</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;lpDisplayName&#39;</span><span class="p">,</span> <span class="n">c_wchar_p</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;ServiceStatusProcess&#39;</span><span class="p">,</span> <span class="n">SERVICE_STATUS_PROCESS</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<div class="viewcode-block" id="EXCEPTION_RECORD"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.EXCEPTION_RECORD">[docs]</a><span class="k">class</span> <span class="nc">EXCEPTION_RECORD</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;ExceptionCode&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ExceptionFlags&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ExceptionRecord&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ExceptionAddress&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;NumberParameters&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ExceptionInformation&quot;</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="o">*</span> <span class="n">EXCEPTION_MAXIMUM_PARAMETERS</span><span class="p">)</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="EXCEPTION_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.EXCEPTION_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">EXCEPTION_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;ExceptionRecord&quot;</span><span class="p">,</span> <span class="n">EXCEPTION_RECORD</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;FirstChance&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">)</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="CREATE_THREAD_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CREATE_THREAD_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">CREATE_THREAD_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;Thread&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ThreadLocalBase&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;StartAddress&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">)</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="CREATE_PROCESS_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CREATE_PROCESS_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">CREATE_PROCESS_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;File&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Process&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Thread&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;BaseOfImage&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DebugInfoFileOffset&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DebugInfoSize&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ThreadLocalBase&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;StartAddress&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ImageName&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Unicode&quot;</span><span class="p">,</span> <span class="n">c_short</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="EXIT_THREAD_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.EXIT_THREAD_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">EXIT_THREAD_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;ExitCode&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),]</span>
</div>
<div class="viewcode-block" id="EXIT_PROCESS_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.EXIT_PROCESS_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">EXIT_PROCESS_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;ExitCode&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),]</span>
</div>
<div class="viewcode-block" id="LOAD_DLL_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.LOAD_DLL_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">LOAD_DLL_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;File&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;BaseOfDll&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DebugInfoFileOffset&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DebugInfoSize&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ImageName&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Unicode&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">]</span></div>
<div class="viewcode-block" id="UNLOAD_DLL_DEBUG_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.UNLOAD_DLL_DEBUG_INFO">[docs]</a><span class="k">class</span> <span class="nc">UNLOAD_DLL_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;BaseOfDll&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">]</span></div>
<div class="viewcode-block" id="OUTPUT_DEBUG_STRING_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.OUTPUT_DEBUG_STRING_INFO">[docs]</a><span class="k">class</span> <span class="nc">OUTPUT_DEBUG_STRING_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;DebugStringData&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Unicode&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DebugStringLength&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">]</span></div>
<div class="viewcode-block" id="RIP_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.RIP_INFO">[docs]</a><span class="k">class</span> <span class="nc">RIP_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;Error&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Type&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="DBG_EVENT_UNION"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.DBG_EVENT_UNION">[docs]</a><span class="k">class</span> <span class="nc">DBG_EVENT_UNION</span><span class="p">(</span><span class="n">Union</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s">&quot;Exception&quot;</span><span class="p">,</span><span class="n">EXCEPTION_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;CreateThread&quot;</span><span class="p">,</span> <span class="n">CREATE_THREAD_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;CreateProcessInfo&quot;</span><span class="p">,</span> <span class="n">CREATE_PROCESS_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;ExitThread&quot;</span><span class="p">,</span> <span class="n">EXIT_THREAD_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;ExitProcess&quot;</span><span class="p">,</span> <span class="n">EXIT_PROCESS_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;LoadDll&quot;</span><span class="p">,</span> <span class="n">LOAD_DLL_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;UnloadDll&quot;</span><span class="p">,</span> <span class="n">UNLOAD_DLL_DEBUG_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;DebugString&quot;</span><span class="p">,</span> <span class="n">OUTPUT_DEBUG_STRING_INFO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">&quot;RipInfo&quot;</span><span class="p">,</span> <span class="n">RIP_INFO</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="DEBUG_EVENT"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.DEBUG_EVENT">[docs]</a><span class="k">class</span> <span class="nc">DEBUG_EVENT</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;DebugEventCode&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ProcessId&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ThreadId&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="n">DBG_EVENT_UNION</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="FloatSavex86"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.FloatSavex86">[docs]</a><span class="k">class</span> <span class="nc">FloatSavex86</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;ControlWord&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;StatusWord&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;TagWord&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;ErrorOffset&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;ErrorSelector&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;DataOffset&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;DataSelector&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;RegisterSave&quot;</span><span class="p">,</span> <span class="n">c_byte</span><span class="o">*</span><span class="mi">80</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&quot;Cr0NpxState&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                  <span class="p">]</span>
</div>
<div class="viewcode-block" id="CONTEXTx64"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CONTEXTx64">[docs]</a><span class="k">class</span> <span class="nc">CONTEXTx64</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>

        <span class="p">(</span><span class="s">&quot;P1Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;P2Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;P3Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;P4Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;P5Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;P6Home&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>

        <span class="p">(</span><span class="s">&quot;ContextFlags&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;MxCsr&quot;</span><span class="p">,</span><span class="n">DWORD</span><span class="p">),</span>

        <span class="p">(</span><span class="s">&quot;cs&quot;</span><span class="p">,</span><span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;ds&quot;</span><span class="p">,</span><span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;es&quot;</span><span class="p">,</span><span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;gs&quot;</span><span class="p">,</span><span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;ss&quot;</span><span class="p">,</span><span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;eflags&quot;</span><span class="p">,</span><span class="n">DWORD</span><span class="p">),</span>

        <span class="p">(</span><span class="s">&quot;debug0&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;debug1&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;debug2&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;debug3&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;debug6&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;debug7&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>

        <span class="p">(</span><span class="s">&quot;rax&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rcx&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rdx&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rbx&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rsp&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rbp&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rsi&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rdi&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r8&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r9&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r10&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r11&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r12&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r13&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r14&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;r15&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;rip&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="p">),</span>

        <span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">c_ulonglong</span><span class="o">*</span><span class="mi">200</span><span class="p">),</span>

        <span class="c">#union {</span>
            <span class="c">#XMM_SAVE_AREA32 FltSave,</span>
            <span class="c">#struct {</span>
                <span class="c">#M128A Header[2],</span>
                <span class="c">#M128A Legacy[8],</span>
                <span class="c">#M128A Xmm0,</span>
                <span class="c">#M128A Xmm1,</span>
                <span class="c">#M128A Xmm2,</span>
                <span class="c">#M128A Xmm3,</span>
                <span class="c">#M128A Xmm4,</span>
                <span class="c">#M128A Xmm5,</span>
                <span class="c">#M128A Xmm6,</span>
                <span class="c">#M128A Xmm7,</span>
                <span class="c">#M128A Xmm8,</span>
                <span class="c">#M128A Xmm9,</span>
                <span class="c">#M128A Xmm10,</span>
                <span class="c">#M128A Xmm11,</span>
                <span class="c">#M128A Xmm12,</span>
                <span class="c">#M128A Xmm13,</span>
                <span class="c">#M128A Xmm14,</span>
                <span class="c">#M128A Xmm15,</span>
            <span class="c">#},</span>
        <span class="c">#},</span>

        <span class="c">#M128A VectorRegister[26],</span>
        <span class="c">#(VectorControl,c_ulonglong),</span>

        <span class="c">#(DebugControl,c_ulonglong),</span>
        <span class="c">#(LastBranchToRip,c_ulonglong),</span>
        <span class="c">#(LastBranchFromRip,c_ulonglong),</span>
        <span class="c">#(LastExceptionToRip,c_ulonglong),</span>
        <span class="c">#(LastExceptionFromRip,c_ulonglong),</span>
    <span class="p">]</span>

<div class="viewcode-block" id="CONTEXTx64.regPostProcess"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CONTEXTx64.regPostProcess">[docs]</a>    <span class="k">def</span> <span class="nf">regPostProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="c"># Used for xmm registers</span></div></div>
<div class="viewcode-block" id="M128A"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.M128A">[docs]</a><span class="k">class</span> <span class="nc">M128A</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Low&#39;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;High&#39;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<div class="viewcode-block" id="ExtendedXmmx86"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.ExtendedXmmx86">[docs]</a><span class="k">class</span> <span class="nc">ExtendedXmmx86</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Header&#39;</span><span class="p">,</span> <span class="n">M128A</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Legacy&#39;</span><span class="p">,</span> <span class="n">M128A</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm0&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm1&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm2&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm3&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm4&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm5&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm6&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_xmm7&#39;</span><span class="p">,</span>   <span class="n">M128A</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Pad&quot;</span><span class="p">,</span> <span class="n">c_byte</span> <span class="o">*</span> <span class="mi">224</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<div class="viewcode-block" id="CONTEXTx86"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CONTEXTx86">[docs]</a><span class="k">class</span> <span class="nc">CONTEXTx86</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>   <span class="p">(</span><span class="s">&quot;ContextFlags&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug0&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug1&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug2&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug3&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug6&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;debug7&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;FloatSave&quot;</span><span class="p">,</span> <span class="n">FloatSavex86</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;gs&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;es&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;ds&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;edi&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;esi&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;ebx&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;edx&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;ecx&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;eax&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;ebp&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;eip&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;cs&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;eflags&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;esp&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&quot;ss&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>

                   <span class="c">#(&quot;Extension&quot;, c_byte * 512),</span>
                   <span class="p">(</span><span class="s">&#39;Extension&#39;</span><span class="p">,</span> <span class="n">ExtendedXmmx86</span><span class="p">),</span>

                    <span class="c">#M128A Header[2],</span>
                    <span class="c">#M128A Legacy[8],</span>
                    <span class="c">#M128A Xmm0,</span>
                    <span class="c">#M128A Xmm1,</span>
                    <span class="c">#M128A Xmm2,</span>
                    <span class="c">#M128A Xmm3,</span>
                    <span class="c">#M128A Xmm4,</span>
                    <span class="c">#M128A Xmm5,</span>
                    <span class="c">#M128A Xmm6,</span>
                    <span class="c">#M128A Xmm7,</span>
                   <span class="p">]</span>

<div class="viewcode-block" id="CONTEXTx86.regPostProcess"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.CONTEXTx86.regPostProcess">[docs]</a>    <span class="k">def</span> <span class="nf">regPostProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm0</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm0</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm1</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm1</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm2</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm2</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm3</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm3</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm3</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm4</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm4</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm4</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm5</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm5</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm5</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm6</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm6</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm6</span><span class="o">.</span><span class="n">Low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmm7</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm7</span><span class="o">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extension</span><span class="o">.</span><span class="n">_xmm7</span><span class="o">.</span><span class="n">Low</span>
</div></div>
<div class="viewcode-block" id="MEMORY_BASIC_INFORMATION"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.MEMORY_BASIC_INFORMATION">[docs]</a><span class="k">class</span> <span class="nc">MEMORY_BASIC_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&quot;BaseAddress&quot;</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;AllocationBase&quot;</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;AllocationProtect&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;RegionSize&quot;</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;State&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;Protect&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;Type&quot;</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">]</span>
</div>
<div class="viewcode-block" id="STARTUPINFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.STARTUPINFO">[docs]</a><span class="k">class</span> <span class="nc">STARTUPINFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Passed into CreateProcess</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Reserved&quot;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Desktop&quot;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Title&quot;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;XSize&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;YSize&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;XCountChars&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;YCountChars&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;FillAttribute&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Flags&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ShowWindow&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Reserved2&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Reserved3&quot;</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;StdInput&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;StdOutput&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;StdError&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="PROCESS_INFORMATION"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.PROCESS_INFORMATION">[docs]</a><span class="k">class</span> <span class="nc">PROCESS_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;Process&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Thread&quot;</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ProcessId&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ThreadId&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="SYMBOL_INFO"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.SYMBOL_INFO">[docs]</a><span class="k">class</span> <span class="nc">SYMBOL_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&quot;SizeOfStruct&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;TypeIndex&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Reserved1&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Reserved2&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Size&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;ModBase&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Flags&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Value&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Address&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Register&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Scope&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Tag&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;NameLen&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;MaxNameLen&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&quot;Name&quot;</span><span class="p">,</span> <span class="n">c_char</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">),</span> <span class="c"># MAX_SYM_NAME</span>
                <span class="p">]</span>
</div>
<div class="viewcode-block" id="IMAGEHLP_MODULE64"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.IMAGEHLP_MODULE64">[docs]</a><span class="k">class</span> <span class="nc">IMAGEHLP_MODULE64</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;SizeOfStruct&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;BaseOfImage&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ImageSize&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;TimeDateStamp&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;CheckSum&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;NumSyms&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;SymType&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ModuleName&quot;</span><span class="p">,</span> <span class="n">c_char</span><span class="o">*</span><span class="mi">32</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;ImageName&quot;</span><span class="p">,</span> <span class="n">c_char</span><span class="o">*</span><span class="mi">256</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LoadedImageName&quot;</span><span class="p">,</span> <span class="n">c_char</span><span class="o">*</span><span class="mi">256</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LoadedPdbName&quot;</span><span class="p">,</span> <span class="n">c_char</span><span class="o">*</span><span class="mi">256</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;CvSig&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;CvData&quot;</span><span class="p">,</span> <span class="n">c_char</span><span class="o">*</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&quot;PdbSig&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;PdbSig70&quot;</span><span class="p">,</span> <span class="n">c_char</span> <span class="o">*</span> <span class="mi">16</span><span class="p">),</span> <span class="c">#GUID</span>
            <span class="p">(</span><span class="s">&quot;PdbAge&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;PdbUnmatched&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DbgUnmatched&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LineNumbers&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;GlobalSymbols&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;TypeInfo&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="IMAGEHLP_STACK_FRAME"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.IMAGEHLP_STACK_FRAME">[docs]</a><span class="k">class</span> <span class="nc">IMAGEHLP_STACK_FRAME</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;InstructionOffset&#39;</span><span class="p">,</span>     <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ReturnOffset&#39;</span><span class="p">,</span>          <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;FrameOffset&#39;</span><span class="p">,</span>           <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;StackOffset&#39;</span><span class="p">,</span>           <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;BackingStoreOffset&#39;</span><span class="p">,</span>    <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;FuncTableEntry&#39;</span><span class="p">,</span>        <span class="n">QWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;Params&#39;</span><span class="p">,</span>                <span class="n">QWORD</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;Reserved&#39;</span><span class="p">,</span>              <span class="n">QWORD</span><span class="o">*</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">,</span>               <span class="n">BOOL</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;Reserved2&#39;</span><span class="p">,</span>             <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<span class="n">IMAGE_DIRECTORY_ENTRY_EXPORT</span>          <span class="o">=</span><span class="mi">0</span>   <span class="c"># Export Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_IMPORT</span>          <span class="o">=</span><span class="mi">1</span>   <span class="c"># Import Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_RESOURCE</span>        <span class="o">=</span><span class="mi">2</span>   <span class="c"># Resource Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_EXCEPTION</span>       <span class="o">=</span><span class="mi">3</span>   <span class="c"># Exception Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_SECURITY</span>        <span class="o">=</span><span class="mi">4</span>   <span class="c"># Security Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC</span>       <span class="o">=</span><span class="mi">5</span>   <span class="c"># Base Relocation Table</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_DEBUG</span>           <span class="o">=</span><span class="mi">6</span>   <span class="c"># Debug Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_COPYRIGHT</span>       <span class="o">=</span><span class="mi">7</span>   <span class="c"># (X86 usage)</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_ARCHITECTURE</span>    <span class="o">=</span><span class="mi">7</span>   <span class="c"># Architecture Specific Data</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_GLOBALPTR</span>       <span class="o">=</span><span class="mi">8</span>   <span class="c"># RVA of GP</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_TLS</span>             <span class="o">=</span><span class="mi">9</span>   <span class="c"># TLS Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG</span>    <span class="o">=</span><span class="mi">10</span>   <span class="c"># Load Configuration Directory</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</span>   <span class="o">=</span><span class="mi">11</span>   <span class="c"># Bound Import Directory in headers</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_IAT</span>            <span class="o">=</span><span class="mi">12</span>   <span class="c"># Import Address Table</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT</span>   <span class="o">=</span><span class="mi">13</span>   <span class="c"># Delay Load Import Descriptors</span>
<span class="n">IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR</span> <span class="o">=</span><span class="mi">14</span>   <span class="c"># COM Runtime descriptor</span>

<span class="n">IMAGE_DEBUG_TYPE_UNKNOWN</span>          <span class="o">=</span><span class="mi">0</span>
<span class="n">IMAGE_DEBUG_TYPE_COFF</span>             <span class="o">=</span><span class="mi">1</span>
<span class="n">IMAGE_DEBUG_TYPE_CODEVIEW</span>         <span class="o">=</span><span class="mi">2</span>
<span class="n">IMAGE_DEBUG_TYPE_FPO</span>              <span class="o">=</span><span class="mi">3</span>
<span class="n">IMAGE_DEBUG_TYPE_MISC</span>             <span class="o">=</span><span class="mi">4</span>
<span class="n">IMAGE_DEBUG_TYPE_EXCEPTION</span>        <span class="o">=</span><span class="mi">5</span>
<span class="n">IMAGE_DEBUG_TYPE_FIXUP</span>            <span class="o">=</span><span class="mi">6</span>
<span class="n">IMAGE_DEBUG_TYPE_OMAP_TO_SRC</span>      <span class="o">=</span><span class="mi">7</span>
<span class="n">IMAGE_DEBUG_TYPE_OMAP_FROM_SRC</span>    <span class="o">=</span><span class="mi">8</span>
<span class="n">IMAGE_DEBUG_TYPE_BORLAND</span>          <span class="o">=</span><span class="mi">9</span>
<span class="n">IMAGE_DEBUG_TYPE_RESERVED10</span>       <span class="o">=</span><span class="mi">10</span>
<span class="n">IMAGE_DEBUG_TYPE_CLSID</span>            <span class="o">=</span><span class="mi">11</span>

<span class="n">SSRVOPT_CALLBACK</span>            <span class="o">=</span> <span class="mh">0x0001</span>
<span class="n">SSRVOPT_DWORD</span>               <span class="o">=</span> <span class="mh">0x0002</span>
<span class="n">SSRVOPT_DWORDPTR</span>            <span class="o">=</span> <span class="mh">0x0004</span>
<span class="n">SSRVOPT_GUIDPTR</span>             <span class="o">=</span> <span class="mh">0x0008</span>
<span class="n">SSRVOPT_OLDGUIDPTR</span>          <span class="o">=</span> <span class="mh">0x0010</span>
<span class="n">SSRVOPT_UNATTENDED</span>          <span class="o">=</span> <span class="mh">0x0020</span>
<span class="n">SSRVOPT_NOCOPY</span>              <span class="o">=</span> <span class="mh">0x0040</span>
<span class="n">SSRVOPT_PARENTWIN</span>           <span class="o">=</span> <span class="mh">0x0080</span>
<span class="n">SSRVOPT_PARAMTYPE</span>           <span class="o">=</span> <span class="mh">0x0100</span>
<span class="n">SSRVOPT_SECURE</span>              <span class="o">=</span> <span class="mh">0x0200</span>
<span class="n">SSRVOPT_TRACE</span>               <span class="o">=</span> <span class="mh">0x0400</span>
<span class="n">SSRVOPT_SETCONTEXT</span>          <span class="o">=</span> <span class="mh">0x0800</span>
<span class="n">SSRVOPT_PROXY</span>               <span class="o">=</span> <span class="mh">0x1000</span>
<span class="n">SSRVOPT_DOWNSTREAM_STORE</span>    <span class="o">=</span> <span class="mh">0x2000</span>

<span class="n">TI_GET_SYMTAG</span>                   <span class="o">=</span> <span class="mi">0</span>
<span class="n">TI_GET_SYMNAME</span>                  <span class="o">=</span> <span class="mi">1</span>
<span class="n">TI_GET_LENGTH</span>                   <span class="o">=</span> <span class="mi">2</span>
<span class="n">TI_GET_TYPE</span>                     <span class="o">=</span> <span class="mi">3</span>
<span class="n">TI_GET_TYPEID</span>                   <span class="o">=</span> <span class="mi">4</span>
<span class="n">TI_GET_BASETYPE</span>                 <span class="o">=</span> <span class="mi">5</span>
<span class="n">TI_GET_ARRAYINDEXTYPEID</span>         <span class="o">=</span> <span class="mi">6</span>
<span class="n">TI_FINDCHILDREN</span>                 <span class="o">=</span> <span class="mi">7</span>
<span class="n">TI_GET_DATAKIND</span>                 <span class="o">=</span> <span class="mi">8</span>
<span class="n">TI_GET_ADDRESSOFFSET</span>            <span class="o">=</span> <span class="mi">9</span>
<span class="n">TI_GET_OFFSET</span>                   <span class="o">=</span> <span class="mi">10</span>
<span class="n">TI_GET_VALUE</span>                    <span class="o">=</span> <span class="mi">11</span>
<span class="n">TI_GET_COUNT</span>                    <span class="o">=</span> <span class="mi">12</span>
<span class="n">TI_GET_CHILDRENCOUNT</span>            <span class="o">=</span> <span class="mi">13</span>
<span class="n">TI_GET_BITPOSITION</span>              <span class="o">=</span> <span class="mi">14</span>
<span class="n">TI_GET_VIRTUALBASECLASS</span>         <span class="o">=</span> <span class="mi">15</span>
<span class="n">TI_GET_VIRTUALTABLESHAPEID</span>      <span class="o">=</span> <span class="mi">16</span>
<span class="n">TI_GET_VIRTUALBASEPOINTEROFFSET</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">TI_GET_CLASSPARENTID</span>            <span class="o">=</span> <span class="mi">18</span>
<span class="n">TI_GET_NESTED</span>                   <span class="o">=</span> <span class="mi">19</span>
<span class="n">TI_GET_SYMINDEX</span>                 <span class="o">=</span> <span class="mi">20</span>
<span class="n">TI_GET_LEXICALPARENT</span>            <span class="o">=</span> <span class="mi">21</span>
<span class="n">TI_GET_ADDRESS</span>                  <span class="o">=</span> <span class="mi">22</span>
<span class="n">TI_GET_THISADJUST</span>               <span class="o">=</span> <span class="mi">23</span>
<span class="n">TI_GET_UDTKIND</span>                  <span class="o">=</span> <span class="mi">24</span>
<span class="n">TI_IS_EQUIV_TO</span>                  <span class="o">=</span> <span class="mi">25</span>
<span class="n">TI_GET_CALLING_CONVENTION</span>       <span class="o">=</span> <span class="mi">26</span>

<span class="n">SymTagNull</span>              <span class="o">=</span> <span class="mi">0</span>
<span class="n">SymTagExe</span>               <span class="o">=</span> <span class="mi">1</span>
<span class="n">SymTagCompiland</span>         <span class="o">=</span> <span class="mi">2</span>
<span class="n">SymTagCompilandDetails</span>  <span class="o">=</span> <span class="mi">3</span>
<span class="n">SymTagCompilandEnv</span>      <span class="o">=</span> <span class="mi">4</span>
<span class="n">SymTagFunction</span>          <span class="o">=</span> <span class="mi">5</span>
<span class="n">SymTagBlock</span>             <span class="o">=</span> <span class="mi">6</span>
<span class="n">SymTagData</span>              <span class="o">=</span> <span class="mi">7</span>
<span class="n">SymTagAnnotation</span>        <span class="o">=</span> <span class="mi">8</span>
<span class="n">SymTagLabel</span>             <span class="o">=</span> <span class="mi">9</span>
<span class="n">SymTagPublicSymbol</span>      <span class="o">=</span> <span class="mi">10</span>
<span class="n">SymTagUDT</span>               <span class="o">=</span> <span class="mi">11</span>
<span class="n">SymTagEnum</span>              <span class="o">=</span> <span class="mi">12</span>
<span class="n">SymTagFunctionType</span>      <span class="o">=</span> <span class="mi">13</span>
<span class="n">SymTagPointerType</span>       <span class="o">=</span> <span class="mi">14</span>
<span class="n">SymTagArrayType</span>         <span class="o">=</span> <span class="mi">15</span>
<span class="n">SymTagBaseType</span>          <span class="o">=</span> <span class="mi">16</span>
<span class="n">SymTagTypedef</span>           <span class="o">=</span> <span class="mi">17</span>
<span class="n">SymTagBaseClass</span>         <span class="o">=</span> <span class="mi">18</span>
<span class="n">SymTagFriend</span>            <span class="o">=</span> <span class="mi">19</span>
<span class="n">SymTagFunctionArgType</span>   <span class="o">=</span> <span class="mi">20</span>
<span class="n">SymTagFuncDebugStart</span>    <span class="o">=</span> <span class="mi">21</span>
<span class="n">SymTagFuncDebugEnd</span>      <span class="o">=</span> <span class="mi">22</span>
<span class="n">SymTagUsingNamespace</span>    <span class="o">=</span> <span class="mi">23</span>
<span class="n">SymTagVTableShape</span>       <span class="o">=</span> <span class="mi">24</span>
<span class="n">SymTagVTable</span>            <span class="o">=</span> <span class="mi">25</span>
<span class="n">SymTagCustom</span>            <span class="o">=</span> <span class="mi">26</span>
<span class="n">SymTagThunk</span>             <span class="o">=</span> <span class="mi">27</span>
<span class="n">SymTagCustomType</span>        <span class="o">=</span> <span class="mi">28</span>
<span class="n">SymTagManagedType</span>       <span class="o">=</span> <span class="mi">29</span>
<span class="n">SymTagDimension</span>         <span class="o">=</span> <span class="mi">30</span>
<span class="n">SymTagMax</span>               <span class="o">=</span> <span class="mi">31</span>

<div class="viewcode-block" id="IMAGE_DEBUG_DIRECTORY"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.IMAGE_DEBUG_DIRECTORY">[docs]</a><span class="k">class</span> <span class="nc">IMAGE_DEBUG_DIRECTORY</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;Characteristics&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;TimeDateStamp&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;MajorVersion&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;MinorVersion&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Type&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;SizeOfData&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;AddressOfRawData&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;PointerToRawData&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
            <span class="p">]</span>
</div>
<span class="n">NT_LIST_HANDLES</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">ACCESS_MASK</span> <span class="o">=</span> <span class="n">DWORD</span>
<div class="viewcode-block" id="SYSTEM_HANDLE"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.SYSTEM_HANDLE">[docs]</a><span class="k">class</span> <span class="nc">SYSTEM_HANDLE</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&#39;ProcessID&#39;</span>        <span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;HandleType&#39;</span>       <span class="p">,</span> <span class="n">c_byte</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;Flags&#39;</span>            <span class="p">,</span> <span class="n">c_byte</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;HandleNumber&#39;</span> <span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;KernelAddress&#39;</span>    <span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&#39;GrantedAccess&#39;</span>    <span class="p">,</span> <span class="n">ACCESS_MASK</span><span class="p">),</span>
    <span class="p">]</span></div>
<span class="n">PSYSTEM_HANDLE</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">SYSTEM_HANDLE</span><span class="p">)</span>

<span class="c"># OBJECT_INFORMATION_CLASS</span>
<span class="n">ObjectBasicInformation</span>      <span class="o">=</span> <span class="mi">0</span>
<span class="n">ObjectNameInformation</span>       <span class="o">=</span> <span class="mi">1</span>
<span class="n">ObjectTypeInformation</span>       <span class="o">=</span> <span class="mi">2</span>
<span class="n">ObjectAllTypesInformation</span>   <span class="o">=</span> <span class="mi">3</span>
<span class="n">ObjectHandleInformation</span>     <span class="o">=</span> <span class="mi">4</span>

<span class="c"># ProcessInformationClass</span>
<span class="n">ProcessBasicInformation</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># Get pointer to PEB</span>
<span class="n">ProcessDebugPort</span>        <span class="o">=</span> <span class="mi">7</span>  <span class="c"># Get DWORD_PTR to debug port number</span>
<span class="n">ProcessWow64Information</span> <span class="o">=</span> <span class="mi">26</span> <span class="c"># Get WOW64 status</span>
<span class="c"># FIXME may be more reliable to use this! \|/</span>
<span class="n">ProcessImageFileName</span>    <span class="o">=</span> <span class="mi">27</span> <span class="c"># Get a UNICODE_STRING of the filename</span>
<span class="n">ProcessExecuteFlags</span>     <span class="o">=</span> <span class="mi">34</span> <span class="c"># Get DWORD of execute status (including DEP) (bug: your process only)</span>

<div class="viewcode-block" id="UNICODE_STRING"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.UNICODE_STRING">[docs]</a><span class="k">class</span> <span class="nc">UNICODE_STRING</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;Length&quot;</span><span class="p">,</span><span class="n">c_ushort</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;MaximumLength&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;Buffer&quot;</span><span class="p">,</span> <span class="n">c_wchar_p</span><span class="p">)</span>
    <span class="p">)</span></div>
<span class="n">PUNICODE_STRING</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">UNICODE_STRING</span><span class="p">)</span>

<div class="viewcode-block" id="OBJECT_TYPE_INFORMATION"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.OBJECT_TYPE_INFORMATION">[docs]</a><span class="k">class</span> <span class="nc">OBJECT_TYPE_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;String&quot;</span><span class="p">,</span><span class="n">UNICODE_STRING</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;reserved&quot;</span><span class="p">,</span> <span class="n">c_uint</span> <span class="o">*</span> <span class="mi">22</span><span class="p">)</span>
    <span class="p">)</span>
</div>
<span class="n">object_type_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;File&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_FILE</span><span class="p">,</span>
    <span class="s">&quot;Directory&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_FILE</span><span class="p">,</span>
    <span class="s">&quot;Event&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_EVENT</span><span class="p">,</span>
    <span class="s">&quot;KeyedEvent&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_EVENT</span><span class="p">,</span>
    <span class="s">&quot;Mutant&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_LOCK</span><span class="p">,</span>
    <span class="s">&quot;Semaphore&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_LOCK</span><span class="p">,</span>
    <span class="s">&quot;Key&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_REGKEY</span><span class="p">,</span>
    <span class="s">&quot;Port&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">,</span>
    <span class="s">&quot;Section&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">,</span>
    <span class="s">&quot;IoCompletion&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">,</span>
    <span class="s">&quot;Desktop&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">,</span>
    <span class="s">&quot;WindowStation&quot;</span><span class="p">:</span><span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="LUID"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.LUID">[docs]</a><span class="k">class</span> <span class="nc">LUID</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;LowPart&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;HighPart&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">)</span>
    <span class="p">)</span>
</div>
<div class="viewcode-block" id="TOKEN_PRIVILEGES"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.TOKEN_PRIVILEGES">[docs]</a><span class="k">class</span> <span class="nc">TOKEN_PRIVILEGES</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="c"># This isn&#39;t really universal, more just for one priv use</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;PrivilegeCount&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span> <span class="c"># Always one</span>
        <span class="p">(</span><span class="s">&quot;Privilege&quot;</span><span class="p">,</span> <span class="n">LUID</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;PrivilegeAttribute&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c"># All platforms must be able to import this module (for exceptions etc..)</span>
<span class="c"># (do this stuff *after* we define some types...)</span></div>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>

    <span class="n">kernel32</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>
    <span class="c"># We need to inform some of the APIs about their args</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">OpenProcess</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DWORD</span><span class="p">,</span> <span class="n">BOOL</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">OpenProcess</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">HANDLE</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">CreateProcessA</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">LPVOID</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">c_uint</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">ReadProcessMemory</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">WriteProcessMemory</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">GetThreadContext</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">SetThreadContext</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">CreateRemoteThread</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">SuspendThread</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">ResumeThread</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualQueryEx</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">DebugBreakProcess</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLogicalDriveStringsA</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">TerminateProcess</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualProtectEx</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAllocEx</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualFreeEx</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">DuplicateHandle</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">SetEvent</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="p">]</span>

    <span class="n">IsWow64Process</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kernel32</span><span class="p">,</span> <span class="s">&#39;IsWow64Process&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IsWow64Process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">IsWow64Process</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>



    <span class="n">psapi</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">psapi</span>
    <span class="n">psapi</span><span class="o">.</span><span class="n">GetModuleFileNameExW</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
    <span class="n">psapi</span><span class="o">.</span><span class="n">GetMappedFileNameW</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>

    <span class="n">ntdll</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">ntdll</span>
    <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQuerySystemInformation</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQueryObject</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQueryInformationProcess</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">ntdll</span><span class="o">.</span><span class="n">NtSystemDebugControl</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">SIZE_T</span>


    <span class="k">try</span><span class="p">:</span>

        <span class="n">SYMCALLBACK</span> <span class="o">=</span> <span class="n">WINFUNCTYPE</span><span class="p">(</span><span class="n">BOOL</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">SYMBOL_INFO</span><span class="p">),</span> <span class="n">c_ulong</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">)</span>
        <span class="n">PDBCALLBACK</span> <span class="o">=</span> <span class="n">WINFUNCTYPE</span><span class="p">(</span><span class="n">BOOL</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">)</span>

        <span class="n">arch_name</span> <span class="o">=</span> <span class="n">envi</span><span class="o">.</span><span class="n">getCurrentArch</span><span class="p">()</span>
        <span class="n">symsrv</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">platdir</span><span class="p">,</span> <span class="s">&quot;windll&quot;</span><span class="p">,</span> <span class="n">arch_name</span><span class="p">,</span> <span class="s">&quot;symsrv.dll&quot;</span><span class="p">))</span>
        <span class="n">dbghelp</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">platdir</span><span class="p">,</span> <span class="s">&quot;windll&quot;</span><span class="p">,</span> <span class="n">arch_name</span><span class="p">,</span> <span class="s">&quot;dbghelp.dll&quot;</span><span class="p">))</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymInitialize</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">BOOL</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymInitialize</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetOptions</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DWORD</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetOptions</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">DWORD</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymCleanup</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymCleanup</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymLoadModule64</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymLoadModule64</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">QWORD</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymGetModuleInfo64</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">IMAGEHLP_MODULE64</span><span class="p">)]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetContext</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetContext</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">IMAGEHLP_STACK_FRAME</span><span class="p">),</span> <span class="n">LPVOID</span> <span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymGetModuleInfo64</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumSymbols</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">SYMCALLBACK</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumSymbols</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumTypes</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">SYMCALLBACK</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumTypes</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymGetTypeInfo</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">]</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymGetTypeInfo</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymFromAddr</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">QWORD</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">QWORD</span><span class="p">),</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">SYMBOL_INFO</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;WARNING: Failed to import dbghelp/symsrv: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>

    <span class="n">advapi32</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">advapi32</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">LookupPrivilegeValueA</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">LPVOID</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenProcessToken</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">AdjustTokenPrivileges</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenSCManagerA</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span> <span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenSCManagerA</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">HANDLE</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">EnumServicesStatusExW</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="n">HANDLE</span><span class="p">,</span>
                                                <span class="n">LPVOID</span><span class="p">,</span>
                                                <span class="n">DWORD</span><span class="p">,</span>
                                                <span class="n">DWORD</span><span class="p">,</span>
                                                <span class="n">LPVOID</span><span class="p">,</span>
                                                <span class="n">DWORD</span><span class="p">,</span>
                                                <span class="n">LPVOID</span><span class="p">,</span>
                                                <span class="n">LPVOID</span><span class="p">,</span>
                                                <span class="n">LPVOID</span><span class="p">,</span>
                                                <span class="n">LPVOID</span> <span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">EnumServicesStatusExW</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">CloseServiceHandle</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">CloseServiceHandle</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">GetTokenInformation</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">]</span>
    <span class="n">advapi32</span><span class="o">.</span><span class="n">GetTokenInformation</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">BOOL</span>


<div class="viewcode-block" id="getServicesList"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.getServicesList">[docs]</a><span class="k">def</span> <span class="nf">getServicesList</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a list of (pid, servicename, displayname) tuples for the</span>
<span class="sd">    currently running services.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scmh</span> <span class="o">=</span> <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenSCManagerA</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">SC_MANAGER_ENUMERATE_SERVICE</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dwSvcSize</span>  <span class="o">=</span> <span class="n">DWORD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dwSvcCount</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">advapi32</span><span class="o">.</span><span class="n">EnumServicesStatusExW</span><span class="p">(</span> <span class="n">scmh</span><span class="p">,</span>
                                        <span class="n">SC_ENUM_PROCESS_INFO</span><span class="p">,</span>
                                        <span class="n">SERVICE_WIN32</span><span class="p">,</span>
                                        <span class="n">SERVICE_ACTIVE</span><span class="p">,</span>
                                        <span class="n">NULL</span><span class="p">,</span>
                                        <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">addressof</span><span class="p">(</span><span class="n">dwSvcSize</span><span class="p">),</span>
                                        <span class="n">addressof</span><span class="p">(</span><span class="n">dwSvcCount</span><span class="p">),</span>
                                        <span class="n">NULL</span><span class="p">,</span>
                                        <span class="n">NULL</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">dwSvcSize</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c">#print &#39;NEEDED&#39;,dwSvcSize</span>
        <span class="c">#print &#39;COUNT&#39;,dwSvcCount</span>

        <span class="n">advapi32</span><span class="o">.</span><span class="n">EnumServicesStatusExW</span><span class="p">(</span> <span class="n">scmh</span><span class="p">,</span>
                                        <span class="n">SC_ENUM_PROCESS_INFO</span><span class="p">,</span>
                                        <span class="n">SERVICE_WIN32</span><span class="p">,</span>
                                        <span class="n">SERVICE_ACTIVE</span><span class="p">,</span>
                                        <span class="n">addressof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
                                        <span class="n">dwSvcSize</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">addressof</span><span class="p">(</span><span class="n">dwSvcSize</span><span class="p">),</span>
                                        <span class="n">addressof</span><span class="p">(</span><span class="n">dwSvcCount</span><span class="p">),</span>
                                        <span class="n">NULL</span><span class="p">,</span>
                                        <span class="n">NULL</span><span class="p">)</span>

        <span class="c">#p = POINTER(ENUM_SERVICE_STATUS_PROCESS)(addressof(buf))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">ENUM_SERVICE_STATUS_PROCESS</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">dwSvcCount</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ServiceStatusProcess</span><span class="o">.</span><span class="n">dwProcessId</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lpServiceName</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lpDisplayName</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">descr</span><span class="p">))</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">advapi32</span><span class="o">.</span><span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">scmh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</div>
<span class="n">x</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">BOOL WINAPI EnumServicesStatusEx(</span>
<span class="s">  __in         SC_HANDLE hSCManager,</span>
<span class="s">  __in         SC_ENUM_TYPE InfoLevel,</span>
<span class="s">  __in         DWORD dwServiceType,</span>
<span class="s">  __in         DWORD dwServiceState,</span>
<span class="s">  __out_opt    LPBYTE lpServices,</span>
<span class="s">  __in         DWORD cbBufSize,</span>
<span class="s">  __out        LPDWORD pcbBytesNeeded,</span>
<span class="s">  __out        LPDWORD lpServicesReturned,</span>
<span class="s">  __inout_opt  LPDWORD lpResumeHandle,</span>
<span class="s">  __in_opt     LPCTSTR pszGroupName</span>
<span class="s">);</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">SE_PRIVILEGE_ENABLED</span>    <span class="o">=</span> <span class="mh">0x00000002</span>
<span class="n">TOKEN_ADJUST_PRIVILEGES</span> <span class="o">=</span> <span class="mh">0x00000020</span>
<span class="n">TOKEN_QUERY</span>             <span class="o">=</span> <span class="mh">0x00000008</span>
<span class="n">dbgprivdone</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># TOKEN_INFORMATION_CLASS</span>
<span class="n">TokenUser</span>                   <span class="o">=</span> <span class="mi">1</span>
<span class="n">TokenGroups</span>                 <span class="o">=</span> <span class="mi">2</span>
<span class="n">TokenPrivileges</span>             <span class="o">=</span> <span class="mi">3</span>
<span class="n">TokenOwner</span>                  <span class="o">=</span> <span class="mi">4</span>
<span class="n">TokenPrimaryGroup</span>           <span class="o">=</span> <span class="mi">5</span>
<span class="n">TokenDefaultDacl</span>            <span class="o">=</span> <span class="mi">6</span>
<span class="n">TokenSource</span>                 <span class="o">=</span> <span class="mi">7</span>
<span class="n">TokenType</span>                   <span class="o">=</span> <span class="mi">8</span>
<span class="n">TokenImpersonationLevel</span>     <span class="o">=</span> <span class="mi">9</span>
<span class="n">TokenStatistics</span>             <span class="o">=</span> <span class="mi">10</span>
<span class="n">TokenRestrictedSids</span>         <span class="o">=</span> <span class="mi">11</span>
<span class="n">TokenSessionId</span>              <span class="o">=</span> <span class="mi">12</span>
<span class="n">TokenGroupsAndPrivileges</span>    <span class="o">=</span> <span class="mi">13</span>
<span class="n">TokenSessionReference</span>       <span class="o">=</span> <span class="mi">14</span>
<span class="n">TokenSandBoxInert</span>           <span class="o">=</span> <span class="mi">15</span>
<span class="n">TokenAuditPolicy</span>            <span class="o">=</span> <span class="mi">16</span>
<span class="n">TokenOrigin</span>                 <span class="o">=</span> <span class="mi">17</span>
<span class="n">TokenElevationType</span>          <span class="o">=</span> <span class="mi">18</span>
<span class="n">TokenLinkedToken</span>            <span class="o">=</span> <span class="mi">19</span>
<span class="n">TokenElevation</span>              <span class="o">=</span> <span class="mi">20</span>
<span class="n">TokenHasRestrictions</span>        <span class="o">=</span> <span class="mi">21</span>
<span class="n">TokenAccessInformation</span>      <span class="o">=</span> <span class="mi">22</span>
<span class="n">TokenVirtualizationAllowed</span>  <span class="o">=</span> <span class="mi">23</span>
<span class="n">TokenVirtualizationEnabled</span>  <span class="o">=</span> <span class="mi">24</span>
<span class="n">TokenIntegrityLevel</span>         <span class="o">=</span> <span class="mi">25</span>
<span class="n">TokenUIAccess</span>               <span class="o">=</span> <span class="mi">26</span>
<span class="n">TokenMandatoryPolicy</span>        <span class="o">=</span> <span class="mi">27</span>
<span class="n">TokenLogonSid</span>               <span class="o">=</span> <span class="mi">28</span>
<span class="n">MaxTokenInfoClass</span>           <span class="o">=</span> <span class="mi">29</span>

<span class="c"># TOKEN_ELEVATION_TYPE</span>
<span class="n">TokenElevationTypeDefault</span>   <span class="o">=</span> <span class="mi">1</span>
<span class="n">TokenElevationTypeFull</span>      <span class="o">=</span> <span class="mi">2</span>
<span class="n">TokenElevationTypeLimited</span>   <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="getTokenElevationType"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.getTokenElevationType">[docs]</a><span class="k">def</span> <span class="nf">getTokenElevationType</span><span class="p">(</span><span class="n">handle</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outsize</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenProcessToken</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">TOKEN_QUERY</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">token</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid Process Handle: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">handle</span><span class="p">)</span>

    <span class="n">advapi32</span><span class="o">.</span><span class="n">GetTokenInformation</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">TokenElevationType</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">etype</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">outsize</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">etype</span><span class="o">.</span><span class="n">value</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">getTokenElevationType</span><span class="p">()</span>

<div class="viewcode-block" id="getDebugPrivileges"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.getDebugPrivileges">[docs]</a><span class="k">def</span> <span class="nf">getDebugPrivileges</span><span class="p">():</span>
    <span class="n">tokprivs</span> <span class="o">=</span> <span class="n">TOKEN_PRIVILEGES</span><span class="p">()</span>
    <span class="n">dbgluid</span> <span class="o">=</span> <span class="n">LUID</span><span class="p">()</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">HANDLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">advapi32</span><span class="o">.</span><span class="n">LookupPrivilegeValueA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;seDebugPrivilege&quot;</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">dbgluid</span><span class="p">)):</span>
        <span class="k">print</span> <span class="s">&quot;LookupPrivilegeValue Failed: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">advapi32</span><span class="o">.</span><span class="n">OpenProcessToken</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">TOKEN_ADJUST_PRIVILEGES</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">token</span><span class="p">)):</span>
        <span class="k">print</span> <span class="s">&quot;kernel32.OpenProcessToken Failed: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">tokprivs</span><span class="o">.</span><span class="n">PrivilegeCount</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">tokprivs</span><span class="o">.</span><span class="n">Privilege</span> <span class="o">=</span> <span class="n">dbgluid</span>
    <span class="n">tokprivs</span><span class="o">.</span><span class="n">PrivilegeAttribute</span> <span class="o">=</span> <span class="n">SE_PRIVILEGE_ENABLED</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">advapi32</span><span class="o">.</span><span class="n">AdjustTokenPrivileges</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">tokprivs</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;AdjustTokenPrivileges Failed: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="buildSystemHandleInformation"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.buildSystemHandleInformation">[docs]</a><span class="k">def</span> <span class="nf">buildSystemHandleInformation</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dynamically build the structure definition for the</span>
<span class="sd">    handle info list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">SYSTEM_HANDLE_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s">&#39;Count&#39;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;Handles&#39;</span><span class="p">,</span> <span class="n">SYSTEM_HANDLE</span> <span class="o">*</span> <span class="n">count</span><span class="p">),</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">SYSTEM_HANDLE_INFORMATION</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="buildFindChildrenParams"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.buildFindChildrenParams">[docs]</a><span class="k">def</span> <span class="nf">buildFindChildrenParams</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TI_FINDCHILDREN_PARAMS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s">&#39;Count&#39;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;Start&#39;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;Children&quot;</span><span class="p">,</span><span class="n">c_ulong</span> <span class="o">*</span> <span class="n">count</span><span class="p">),]</span>
    <span class="n">tif</span> <span class="o">=</span> <span class="n">TI_FINDCHILDREN_PARAMS</span><span class="p">()</span>
    <span class="n">tif</span><span class="o">.</span><span class="n">Count</span> <span class="o">=</span> <span class="n">count</span>
    <span class="k">return</span> <span class="n">tif</span>
</div>
<div class="viewcode-block" id="raiseWin32Error"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.raiseWin32Error">[docs]</a><span class="k">def</span> <span class="nf">raiseWin32Error</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">PlatformException</span><span class="p">(</span><span class="s">&quot;Win32 Error </span><span class="si">%s</span><span class="s"> failed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="GetModuleFileNameEx"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.GetModuleFileNameEx">[docs]</a><span class="k">def</span> <span class="nf">GetModuleFileNameEx</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="n">mhandle</span><span class="p">):</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">create_unicode_buffer</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">psapi</span><span class="o">.</span><span class="n">GetModuleFileNameExW</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="n">mhandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
</div>
<span class="n">av_einfo_perms</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_READ</span><span class="p">,</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_WRITE</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">MM_EXEC</span><span class="p">]</span>

<div class="viewcode-block" id="WindowsMixin"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin">[docs]</a><span class="k">class</span> <span class="nc">WindowsMixin</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A mixin to handle all non-arch specific win32 stuff.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">casesens</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phandle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thandles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win32threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dosdevs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushcache</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faultaddr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">global</span> <span class="n">dbgprivdone</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbgprivdone</span><span class="p">:</span>
            <span class="n">dbgprivdone</span> <span class="o">=</span> <span class="n">getDebugPrivileges</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_wow64</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># 64 bit trace uses this...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># Threads we have suspended for single stepping</span>

        <span class="c"># Skip the attach event and plow through to the first</span>
        <span class="c"># injected breakpoint (cause libs are loaded by then)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableAutoContinue</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_ATTACH</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setupDosDeviceMaps</span><span class="p">()</span>

        <span class="c"># Setup our binary format meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;Format&#39;</span><span class="p">,</span><span class="s">&#39;pe&#39;</span><span class="p">)</span>

        <span class="c"># Setup some win32_ver info in metadata</span>
        <span class="n">rel</span><span class="p">,</span><span class="n">ver</span><span class="p">,</span><span class="n">csd</span><span class="p">,</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">win32_ver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;WindowsRelease&quot;</span><span class="p">,</span><span class="n">rel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;WindowsVersion&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;WindowsCsd&quot;</span><span class="p">,</span> <span class="n">csd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;WindowsProcessorType&quot;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span>

        <span class="c"># Setup modes which only apply to windows systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initMode</span><span class="p">(</span><span class="s">&#39;BlockStep&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;Single step to branch entry points&#39;</span><span class="p">)</span>

        <span class="c"># If possible, get a default set of struct definitions</span>
        <span class="c"># for ntdll...</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">vs_windows</span><span class="o">.</span><span class="n">getCurrentDef</span><span class="p">(</span><span class="s">&#39;ntdll&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nt</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsbuilder</span><span class="o">.</span><span class="n">addVStructNamespace</span><span class="p">(</span><span class="s">&#39;ntdll&#39;</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>

        <span class="c"># Either way, add the fallback &quot;win32&quot; namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsbuilder</span><span class="o">.</span><span class="n">addVStructNamespace</span><span class="p">(</span><span class="s">&#39;win32&#39;</span><span class="p">,</span> <span class="n">vs_win32</span><span class="p">)</span>

        <span class="c"># We need thread proxying for a few calls...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fireTracerThread</span><span class="p">()</span>

<div class="viewcode-block" id="WindowsMixin.platformGetFds"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformGetFds">[docs]</a>    <span class="k">def</span> <span class="nf">platformGetFds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandles</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hinfo</span><span class="o">.</span><span class="n">Count</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">hinfo</span><span class="o">.</span><span class="n">Handles</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">ProcessID</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">hand</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">.</span><span class="n">Handles</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">HandleNumber</span>
            <span class="n">myhand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dupHandle</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
            <span class="n">typestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandleInfo</span><span class="p">(</span><span class="n">myhand</span><span class="p">,</span> <span class="n">ObjectTypeInformation</span><span class="p">)</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">typestr</span> <span class="o">==</span> <span class="s">&quot;File&quot;</span><span class="p">:</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandleInfo</span><span class="p">(</span><span class="n">myhand</span><span class="p">,</span> <span class="n">ObjectNameInformation</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">myhand</span><span class="p">)</span>
            <span class="n">htype</span> <span class="o">=</span> <span class="n">object_type_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typestr</span><span class="p">,</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">FD_UNKNOWN</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">hand</span><span class="p">,</span> <span class="n">htype</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typestr</span><span class="p">,</span><span class="n">namestr</span><span class="p">))</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
    <span class="k">def</span> <span class="nf">_winJitEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">SetEvent</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<div class="viewcode-block" id="WindowsMixin.dupHandle"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.dupHandle">[docs]</a>    <span class="k">def</span> <span class="nf">dupHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Duplicate the handle (who&#39;s id is in the currently attached</span>
<span class="sd">        target process) and return our own copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hret</span> <span class="o">=</span> <span class="n">c_uint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">DuplicateHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
                                 <span class="n">kernel32</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="n">addressof</span><span class="p">(</span><span class="n">hret</span><span class="p">),</span>
                                 <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c"># DUPLICATE_SAME_ACCESS</span>
        <span class="k">return</span> <span class="n">hret</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="WindowsMixin.getHandleInfo"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.getHandleInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getHandleInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="n">ObjectTypeInformation</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">retSiz</span> <span class="o">=</span> <span class="n">c_uint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

        <span class="c"># Some NtQueryObject calls will hang, lets figgure out which...</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXCEPTION_TIMEOUT</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;_TIMEOUT_&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQueryObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">itype</span><span class="p">,</span>
                <span class="n">buf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">addressof</span><span class="p">(</span><span class="n">retSiz</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;Error 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e_bits</span><span class="o">.</span><span class="n">unsigned</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">))</span>

        <span class="n">realbuf</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="n">retSiz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQueryObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">itype</span><span class="p">,</span>
                <span class="n">realbuf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">realbuf</span><span class="p">),</span> <span class="n">addressof</span><span class="p">(</span><span class="n">retSiz</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">uString</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">realbuf</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span><span class="p">)</span><span class="o">.</span><span class="n">contents</span>
            <span class="k">return</span> <span class="n">uString</span><span class="o">.</span><span class="n">Buffer</span>
        <span class="k">return</span> <span class="s">&quot;Unknown&quot;</span>
</div>
<div class="viewcode-block" id="WindowsMixin.getHandles"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.getHandles">[docs]</a>    <span class="k">def</span> <span class="nf">getHandles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">hinfo</span> <span class="o">=</span> <span class="n">buildSystemHandleInformation</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hsize</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">hinfo</span><span class="p">))</span>

        <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">NT_LIST_HANDLES</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">hinfo</span><span class="p">),</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">hsize</span><span class="p">))</span>

        <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsize</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">SYSTEM_HANDLE</span><span class="p">)</span>
        <span class="n">hinfo</span> <span class="o">=</span> <span class="n">buildSystemHandleInformation</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">hsize</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">hinfo</span><span class="p">))</span>

        <span class="n">ntdll</span><span class="o">.</span><span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">NT_LIST_HANDLES</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">hinfo</span><span class="p">),</span> <span class="n">hsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hinfo</span>

</div>
<div class="viewcode-block" id="WindowsMixin.setupDosDeviceMaps"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.setupDosDeviceMaps">[docs]</a>    <span class="k">def</span> <span class="nf">setupDosDeviceMaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dosdevs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_char</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetLogicalDriveStringsA</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">dname</span><span class="p">))</span>
        <span class="n">devs</span> <span class="o">=</span> <span class="n">dname</span><span class="o">.</span><span class="n">raw</span><span class="p">[:</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">devs</span><span class="p">:</span>
            <span class="n">dosname</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">QueryDosDeviceA</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pointer</span><span class="p">(</span><span class="n">dname</span><span class="p">),</span> <span class="mi">512</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dosdevs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">dosname</span><span class="p">,</span> <span class="n">dname</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformKill"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformKill">[docs]</a>    <span class="k">def</span> <span class="nf">platformKill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">TerminateProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformExec"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformExec">[docs]</a>    <span class="k">def</span> <span class="nf">platformExec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">):</span>
        <span class="n">sinfo</span> <span class="o">=</span> <span class="n">STARTUPINFO</span><span class="p">()</span>
        <span class="n">pinfo</span> <span class="o">=</span> <span class="n">PROCESS_INFORMATION</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">CreateProcessA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">DEBUG_ONLY_THIS_PROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">sinfo</span><span class="p">),</span> <span class="n">addressof</span><span class="p">(</span><span class="n">pinfo</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;CreateProcess failed!&quot;</span><span class="p">)</span>

        <span class="c"># When launching an app, we&#39;re guaranteed to get a breakpoint</span>
        <span class="c"># Unless we want to fail checkBreakpoints, we&#39;ll need to set ShouldBreak</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;ShouldBreak&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">pinfo</span><span class="o">.</span><span class="n">Process</span><span class="p">)</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">pinfo</span><span class="o">.</span><span class="n">Thread</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pinfo</span><span class="o">.</span><span class="n">ProcessId</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformInjectSo"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformInjectSo">[docs]</a>    <span class="k">def</span> <span class="nf">platformInjectSo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">c_uint32</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="s">&#39;kernel32.LoadLibraryA&#39;</span><span class="p">)</span>
        <span class="n">memaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocateMemory</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeMemory</span><span class="p">(</span><span class="n">memaddr</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span>  <span class="n">kernel32</span><span class="o">.</span><span class="n">CreateRemoteThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">memaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">tid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joinThread</span><span class="p">(</span><span class="n">tid</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualFreeEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">memaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="c"># MEM_RELEASE 0x8000  MEM_DECOMMIT 0x4000</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformAttach"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformAttach">[docs]</a>    <span class="k">def</span> <span class="nf">platformAttach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">DebugActiveProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;DebugActiveProcess&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformDetach"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformDetach">[docs]</a>    <span class="k">def</span> <span class="nf">platformDetach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Do the crazy &quot;can&#39;t supress exceptions from detach&quot; dance.</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exited</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentBreakpoint</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanupBreakpoints</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platformContinue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platformSendBreak</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platformWait</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">DebugActiveProcessStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;DebugActiveProcessStop&quot;</span><span class="p">)</span>
        <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phandle</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformProtectMemory"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformProtectMemory">[docs]</a>    <span class="k">def</span> <span class="nf">platformProtectMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="p">):</span>
        <span class="n">pret</span> <span class="o">=</span> <span class="n">c_uint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">perm_rev_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualProtectEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">pret</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.VirtualProtectEx&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformAllocateMemory"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformAllocateMemory">[docs]</a>    <span class="k">def</span> <span class="nf">platformAllocateMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="o">=</span><span class="n">e_mem</span><span class="o">.</span><span class="n">MM_RWX</span><span class="p">,</span> <span class="n">suggestaddr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">perm_rev_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAllocEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span>
                <span class="n">suggestaddr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.VirtualAllocEx&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformReadMemory"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformReadMemory">[docs]</a>    <span class="k">def</span> <span class="nf">platformReadMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="n">c_char</span> <span class="o">*</span> <span class="n">size</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">btype</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">ReadProcessMemory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">ret</span><span class="p">)):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.ReadProcessMemory </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">raw</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformContinue"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformContinue">[docs]</a>    <span class="k">def</span> <span class="nf">platformContinue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># If there is anything in _step_suspends, un-suspend them</span>
        <span class="k">for</span> <span class="n">thrid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span><span class="p">:</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_continueDebugEvent</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_continueDebugEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">magic</span> <span class="o">=</span> <span class="n">DBG_CONTINUE</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentSignal</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">magic</span> <span class="o">=</span> <span class="n">DBG_EXCEPTION_NOT_HANDLED</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushcache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flushcache</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">FlushInstructionCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">ContinueDebugEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;StoppedThreadId&quot;</span><span class="p">),</span> <span class="n">magic</span><span class="p">):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;ContinueDebugEvent&quot;</span><span class="p">)</span>

    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformStepi"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformStepi">[docs]</a>    <span class="k">def</span> <span class="nf">platformStepi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># We have some flag fields broken out as meta regs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRegisterByName</span><span class="p">(</span><span class="s">&quot;TF&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMode</span><span class="p">(</span><span class="s">&#39;BlockStep&#39;</span><span class="p">):</span>
            <span class="n">wrmsr</span><span class="p">(</span><span class="n">e_i386</span><span class="o">.</span><span class="n">MSR_DEBUGCTL</span><span class="p">,</span> <span class="n">e_i386</span><span class="o">.</span><span class="n">MSR_DEBUGCTL_BTF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_syncRegs</span><span class="p">()</span>

        <span class="c"># For single step, suspend all the threads except the current</span>
        <span class="k">for</span> <span class="n">thrid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getThreads</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c"># If this thread is the &quot;current thread&quot; don&#39;t suspend it</span>
            <span class="k">if</span> <span class="n">thrid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentThread</span><span class="p">():</span>
                <span class="c"># If it was suspended because of stepping another thread</span>
                <span class="c"># resume it.</span>
                <span class="k">if</span> <span class="n">thrid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span><span class="p">:</span>
                    <span class="n">kernel32</span><span class="o">.</span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># Check for &quot;already suspended&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus_threads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">thrid</span> <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c"># Check if we&#39;re returning in a step loop</span>
            <span class="k">if</span> <span class="n">thrid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c"># Call suspend thread directly for speed</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">SuspendThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_suspends</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">thrid</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_continueDebugEvent</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformWriteMemory"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformWriteMemory">[docs]</a>    <span class="k">def</span> <span class="nf">platformWriteMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">addressof</span><span class="p">(</span><span class="n">ret</span><span class="p">)):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.WriteProcessMemory&quot;</span><span class="p">)</span>
        <span class="c"># If we wrote memory, flush the instruction cache...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushcache</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformSendBreak"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformSendBreak">[docs]</a>    <span class="k">def</span> <span class="nf">platformSendBreak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#FIXME make this support windows 2000</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">DebugBreakProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.DebugBreakProcess&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformPs"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformPs">[docs]</a>    <span class="k">def</span> <span class="nf">platformPs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pcount</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_int</span> <span class="o">*</span> <span class="n">pcount</span><span class="p">)()</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hmodule</span> <span class="o">=</span> <span class="n">HANDLE</span><span class="p">()</span>

        <span class="n">psapi</span><span class="o">.</span><span class="n">EnumProcesses</span><span class="p">(</span><span class="n">addressof</span><span class="p">(</span><span class="n">pids</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="n">pcount</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">needed</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">needed</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">pcount</span><span class="p">:</span>
            <span class="c"># If the array was too small, lets up the size to needed + 128</span>
            <span class="n">pcount</span> <span class="o">=</span> <span class="n">needed</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">128</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_int</span> <span class="o">*</span> <span class="n">pcount</span><span class="p">)()</span>
            <span class="n">psapi</span><span class="o">.</span><span class="n">EnumProcesses</span><span class="p">(</span><span class="n">addressof</span><span class="p">(</span><span class="n">pids</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="n">pcount</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">needed</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">needed</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_wchar</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)()</span>
            <span class="n">phandle</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phandle</span><span class="p">:</span> <span class="c"># If we get 0, we failed to open it (perms)</span>
                <span class="k">continue</span>
            <span class="n">psapi</span><span class="o">.</span><span class="n">EnumProcessModules</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">hmodule</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">needed</span><span class="p">))</span>
            <span class="n">psapi</span><span class="o">.</span><span class="n">GetModuleBaseNameW</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="n">hmodule</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">pids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fname</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">phandle</span><span class="p">)</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">hmodule</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformWait"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformWait">[docs]</a>    <span class="k">def</span> <span class="nf">platformWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">DEBUG_EVENT</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForDebugEvent</span><span class="p">(</span><span class="n">addressof</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">INFINITE</span><span class="p">):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;WaitForDebugEvent&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">event</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformGetMemFault"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformGetMemFault">[docs]</a>    <span class="k">def</span> <span class="nf">platformGetMemFault</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">faultaddr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">faultperm</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformProcessEvent"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformProcessEvent">[docs]</a>    <span class="k">def</span> <span class="nf">platformProcessEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">faultaddr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faultperm</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ProcessId</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;event.ProcessId != self.pid (</span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ProcessId</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>

        <span class="n">ThreadId</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ThreadId</span>
        <span class="n">eventdict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Each handler fills this in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;Win32Event&quot;</span><span class="p">,</span> <span class="n">eventdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;StoppedThreadId&quot;</span><span class="p">,</span> <span class="n">ThreadId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;ThreadId&quot;</span><span class="p">,</span> <span class="n">ThreadId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">CREATE_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateProcessInfo</span><span class="o">.</span><span class="n">Process</span>
           <span class="n">baseaddr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateProcessInfo</span><span class="o">.</span><span class="n">BaseOfImage</span>
           <span class="n">ImageName</span> <span class="o">=</span> <span class="n">GetModuleFileNameEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="n">ImageName</span><span class="p">:</span>
               <span class="c"># If it fails, fall back on getMappedFileName</span>
               <span class="n">ImageName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMappedFileName</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;ExeName&quot;</span><span class="p">,</span> <span class="n">ImageName</span><span class="p">)</span>

           <span class="n">teb</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateProcessInfo</span><span class="o">.</span><span class="n">ThreadLocalBase</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">win32threads</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">]</span> <span class="o">=</span> <span class="n">teb</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">thandles</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateProcessInfo</span><span class="o">.</span><span class="n">Thread</span>

           <span class="n">tobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStruct</span><span class="p">(</span><span class="s">&quot;ntdll.TEB&quot;</span><span class="p">,</span> <span class="n">teb</span><span class="p">)</span>
           <span class="n">peb</span> <span class="o">=</span> <span class="n">tobj</span><span class="o">.</span><span class="n">ProcessEnvironmentBlock</span>

           <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&quot;PEB&quot;</span><span class="p">,</span> <span class="n">peb</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="s">&quot;peb&quot;</span><span class="p">,</span> <span class="n">peb</span><span class="p">)</span>

           <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ImageName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageName</span>
           <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;StartAddress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateProcessInfo</span><span class="o">.</span><span class="n">StartAddress</span>
           <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ThreadLocalBase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teb</span>

           <span class="bp">self</span><span class="o">.</span><span class="n">_is_wow64</span> <span class="o">=</span> <span class="bp">False</span>
           <span class="k">if</span> <span class="n">IsWow64Process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">b</span> <span class="o">=</span> <span class="n">BOOL</span><span class="p">()</span>
               <span class="n">IsWow64Process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
               <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_is_wow64</span> <span class="o">=</span> <span class="bp">True</span>

           <span class="bp">self</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;IsWow64&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_wow64</span><span class="p">)</span>

           <span class="bp">self</span><span class="o">.</span><span class="n">fireNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_ATTACH</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">addLibraryBase</span><span class="p">(</span><span class="n">ImageName</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">CREATE_THREAD_DEBUG_EVENT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thandles</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateThread</span><span class="o">.</span><span class="n">Thread</span>
            <span class="n">teb</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateThread</span><span class="o">.</span><span class="n">ThreadLocalBase</span>
            <span class="n">startaddr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">CreateThread</span><span class="o">.</span><span class="n">StartAddress</span>
            <span class="c"># Setup the event dictionary for notifiers</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ThreadLocalBase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teb</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;StartAddress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startaddr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win32threads</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">]</span> <span class="o">=</span> <span class="n">teb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fireNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_CREATE_THREAD</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">EXCEPTION_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">excode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">ExceptionRecord</span><span class="o">.</span><span class="n">ExceptionCode</span>
            <span class="n">exflags</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">ExceptionRecord</span><span class="o">.</span><span class="n">ExceptionFlags</span>
            <span class="n">exaddr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">ExceptionRecord</span><span class="o">.</span><span class="n">ExceptionAddress</span>
            <span class="n">exparam</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">ExceptionRecord</span><span class="o">.</span><span class="n">NumberParameters</span>
            <span class="n">firstChance</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">FirstChance</span>

            <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">exparam</span><span class="p">):</span>
                <span class="n">plist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">long</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">Exception</span><span class="o">.</span><span class="n">ExceptionRecord</span><span class="o">.</span><span class="n">ExceptionInformation</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExceptionCode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">excode</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExceptionFlags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exflags</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExceptionAddress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exaddr</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;NumberParameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exparam</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;FirstChance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">firstChance</span><span class="p">)</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExceptionInformation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plist</span>

            <span class="k">if</span> <span class="n">firstChance</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">excode</span> <span class="o">==</span> <span class="n">EXCEPTION_BREAKPOINT</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkBreakpoints</span><span class="p">():</span>
                        <span class="c"># On first attach, all the library load</span>
                        <span class="c"># events occur, then we hit a CC.  So,</span>
                        <span class="c"># if we don&#39;t find a breakpoint, notify</span>
                        <span class="c"># break anyay....</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fireNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_BREAK</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">excode</span> <span class="o">==</span> <span class="n">EXCEPTION_SINGLE_STEP</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkWatchpoints</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fireStep</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">excode</span> <span class="o">==</span> <span class="mh">0xc0000005</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">faultaddr</span> <span class="o">=</span> <span class="n">plist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">faultperm</span> <span class="o">=</span> <span class="n">av_einfo_perms</span><span class="p">[</span><span class="n">plist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="c"># First we check for PageWatchpoint faults</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPageWatchpoints</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fireSignal</span><span class="p">(</span><span class="n">excode</span><span class="p">,</span> <span class="n">siginfo</span><span class="o">=</span><span class="n">plist</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fireSignal</span><span class="p">(</span><span class="n">excode</span><span class="p">,</span> <span class="n">siginfo</span><span class="o">=</span><span class="n">plist</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">EXIT_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ExitProcess</span><span class="o">.</span><span class="n">ExitCode</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExitCode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fireExit</span><span class="p">(</span><span class="n">ecode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platformDetach</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">EXIT_THREAD_DEBUG_EVENT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win32threads</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ThreadId</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ExitThread</span><span class="o">.</span><span class="n">ExitCode</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;ExitCode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fireExitThread</span><span class="p">(</span><span class="n">ThreadId</span><span class="p">,</span> <span class="n">ecode</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">LOAD_DLL_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">baseaddr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">LoadDll</span><span class="o">.</span><span class="n">BaseOfDll</span>
            <span class="n">ImageName</span> <span class="o">=</span> <span class="n">GetModuleFileNameEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ImageName</span><span class="p">:</span>
                <span class="c"># If it fails, fall back on getMappedFileName</span>
                <span class="n">ImageName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMappedFileName</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addLibraryBase</span><span class="p">(</span><span class="n">ImageName</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">)</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">LoadDll</span><span class="o">.</span><span class="n">File</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">UNLOAD_DLL_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">baseaddr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">UnloadDll</span><span class="o">.</span><span class="n">BaseOfDll</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;BaseOfDll&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseaddr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delLibraryBase</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">DebugEventCode</span> <span class="o">==</span> <span class="n">OUTPUT_DEBUG_STRING_EVENT</span><span class="p">:</span>
            <span class="c"># Gotta have a way to continue these...</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">DebugString</span>
            <span class="n">sdata</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">DebugStringData</span>
            <span class="n">ssize</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">DebugStringLength</span>

            <span class="c"># FIXME possibly make a gofast option that</span>
            <span class="c"># doesn&#39;t get the string</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ssize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">Unicode</span><span class="p">:</span>
                <span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-16-le&quot;</span><span class="p">)</span>
            <span class="n">eventdict</span><span class="p">[</span><span class="s">&quot;DebugString&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fireNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_DEBUG_PRINT</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Currently unhandled event&quot;</span><span class="p">,</span><span class="n">code</span>

        <span class="c"># NOTE: Not everbody falls through to here</span>

</div>
<div class="viewcode-block" id="WindowsMixin.getMappedFileName"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.getMappedFileName">[docs]</a>    <span class="k">def</span> <span class="nf">getMappedFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_wchar</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">psapi</span><span class="o">.</span><span class="n">GetMappedFileNameW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="mi">512</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">value</span>
        <span class="k">for</span> <span class="n">dosname</span><span class="p">,</span> <span class="n">devname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dosdevs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">devname</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">dosname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformGetMaps"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformGetMaps">[docs]</a>    <span class="k">def</span> <span class="nf">platformGetMaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">mbi</span> <span class="o">=</span> <span class="n">MEMORY_BASIC_INFORMATION</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualQueryEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">mbi</span><span class="p">),</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">mbi</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mbi</span><span class="o">.</span><span class="n">State</span> <span class="o">==</span> <span class="n">MEM_COMMIT</span><span class="p">:</span>
                <span class="n">prot</span> <span class="o">=</span> <span class="n">mbi</span><span class="o">.</span><span class="n">Protect</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="n">perm</span> <span class="o">=</span> <span class="n">perm_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">mbi</span><span class="o">.</span><span class="n">BaseAddress</span>
                <span class="n">mname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMappedFileName</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="c"># If it fails, fall back on getmodulefilename</span>
                <span class="k">if</span> <span class="n">mname</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">mname</span> <span class="o">=</span> <span class="n">GetModuleFileNameEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mbi</span><span class="o">.</span><span class="n">RegionSize</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">mname</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">base</span> <span class="o">+=</span> <span class="n">mbi</span><span class="o">.</span><span class="n">RegionSize</span>

        <span class="k">return</span> <span class="n">ret</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformGetThreads"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformGetThreads">[docs]</a>    <span class="k">def</span> <span class="nf">platformGetThreads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">win32threads</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformSuspendThread"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformSuspendThread">[docs]</a>    <span class="k">def</span> <span class="nf">platformSuspendThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thrid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">SuspendThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">:</span>
            <span class="n">raiseWin32Error</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformResumeThread"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformResumeThread">[docs]</a>    <span class="k">def</span> <span class="nf">platformResumeThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thrid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">:</span>
            <span class="n">raiseWin32Error</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="WindowsMixin.platformParseBinary"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformParseBinary">[docs]</a>    <span class="k">def</span> <span class="nf">platformParseBinary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">normname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dbghelp</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parseWithDbgHelp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">normname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parseWithPE</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">normname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WindowsMixin.parseWithDbgHelp"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.parseWithDbgHelp">[docs]</a>    <span class="k">def</span> <span class="nf">parseWithDbgHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">normname</span><span class="p">):</span>
        <span class="n">funcflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">SYMFLAG_FUNCTION</span> <span class="o">|</span> <span class="n">SYMFLAG_EXPORT</span><span class="p">)</span>

        <span class="n">sympath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;NtSymbolPath&#39;</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">Win32SymbolParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">sympath</span><span class="o">=</span><span class="n">sympath</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">loadSymsIntoTrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WindowsMixin.parseWithPE"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.parseWithPE">[docs]</a>    <span class="k">def</span> <span class="nf">parseWithPE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="n">normname</span><span class="p">):</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">PE</span><span class="o">.</span><span class="n">peFromMemoryObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rva</span><span class="p">,</span> <span class="nb">ord</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">getExports</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSymbol</span><span class="p">(</span><span class="n">e_resolv</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">baseaddr</span><span class="o">+</span><span class="n">rva</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">normname</span><span class="p">))</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformGetRegCtx"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformGetRegCtx">[docs]</a>    <span class="k">def</span> <span class="nf">platformGetRegCtx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadid</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archGetRegCtx</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_winGetRegStruct</span><span class="p">()</span>

        <span class="n">thandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thandles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">threadid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thandle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Getting registers for unknown thread&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">thandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.GetThreadContext&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">regPostProcess</span><span class="p">()</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">_rctx_Import</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
</div>
    <span class="nd">@v_base.threadwrap</span>
<div class="viewcode-block" id="WindowsMixin.platformSetRegCtx"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsMixin.platformSetRegCtx">[docs]</a>    <span class="k">def</span> <span class="nf">platformSetRegCtx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadid</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_winGetRegStruct</span><span class="p">()</span>

        <span class="n">thandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thandles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">threadid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thandle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Getting registers for unknown thread: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">threadid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">thandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.GetThreadContext (tid: </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">threadid</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">_rctx_Export</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">SetThreadContext</span><span class="p">(</span><span class="n">thandle</span><span class="p">,</span> <span class="n">addressof</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">raiseWin32Error</span><span class="p">(</span><span class="s">&quot;kernel32.SetThreadContext (tid: </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">threadid</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_getSvcList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Expose the getServicesList via the trace for remote...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">getServicesList</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getUacStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getTokenElevationType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">)</span>

<span class="c"># NOTE: The order of the constructors vs inheritance is very important...</span>
</div>
<div class="viewcode-block" id="Windowsi386Trace"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Windowsi386Trace">[docs]</a><span class="k">class</span> <span class="nc">Windowsi386Trace</span><span class="p">(</span>
            <span class="n">vtrace</span><span class="o">.</span><span class="n">Trace</span><span class="p">,</span>
            <span class="n">WindowsMixin</span><span class="p">,</span>
            <span class="n">v_i386</span><span class="o">.</span><span class="n">i386Mixin</span><span class="p">,</span>
            <span class="n">v_base</span><span class="o">.</span><span class="n">TracerBase</span><span class="p">,</span>
            <span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtrace</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v_base</span><span class="o">.</span><span class="n">TracerBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v_i386</span><span class="o">.</span><span class="n">i386Mixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">WindowsMixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_winGetRegStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">CONTEXTx86</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTEXT_i386</span> <span class="o">|</span> 
                          <span class="n">CONTEXT_FULL</span> <span class="o">|</span> 
                          <span class="n">CONTEXT_DEBUG_REGISTERS</span> <span class="o">|</span>
                          <span class="n">CONTEXT_EXTENDED_REGISTERS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="WindowsAmd64Trace"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.WindowsAmd64Trace">[docs]</a><span class="k">class</span> <span class="nc">WindowsAmd64Trace</span><span class="p">(</span>
            <span class="n">vtrace</span><span class="o">.</span><span class="n">Trace</span><span class="p">,</span>
            <span class="n">WindowsMixin</span><span class="p">,</span>
            <span class="n">v_amd64</span><span class="o">.</span><span class="n">Amd64Mixin</span><span class="p">,</span>
            <span class="n">v_base</span><span class="o">.</span><span class="n">TracerBase</span><span class="p">,</span>
            <span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtrace</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v_base</span><span class="o">.</span><span class="n">TracerBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">WindowsMixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v_amd64</span><span class="o">.</span><span class="n">Amd64Mixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_winGetRegStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">CONTEXTx64</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTEXT_AMD64</span> <span class="o">|</span> <span class="n">CONTEXT_FULL</span> <span class="o">|</span> <span class="n">CONTEXT_DEBUG_REGISTERS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>
</div>
<span class="n">reserved</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;None&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s">&#39;True&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s">&#39;False&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">VT_EMPTY</span>    <span class="o">=</span> <span class="mi">0</span> 
<span class="n">VT_NULL</span>     <span class="o">=</span> <span class="mi">1</span> 
<span class="n">VT_I2</span>       <span class="o">=</span> <span class="mi">2</span> 
<span class="n">VT_I4</span>       <span class="o">=</span> <span class="mi">3</span> 
<span class="n">VT_R4</span>       <span class="o">=</span> <span class="mi">4</span> 
<span class="n">VT_R8</span>       <span class="o">=</span> <span class="mi">5</span> 
<span class="n">VT_CY</span>       <span class="o">=</span> <span class="mi">6</span> 
<span class="n">VT_DATE</span>     <span class="o">=</span> <span class="mi">7</span> 
<span class="n">VT_BSTR</span>     <span class="o">=</span> <span class="mi">8</span> 
<span class="n">VT_DISPATCH</span> <span class="o">=</span> <span class="mi">9</span> 
<span class="n">VT_ERROR</span>    <span class="o">=</span> <span class="mi">10</span> 
<span class="n">VT_BOOL</span>     <span class="o">=</span> <span class="mi">11</span> 
<span class="n">VT_VARIANT</span>  <span class="o">=</span> <span class="mi">12</span> 
<span class="n">VT_UNKNOWN</span>  <span class="o">=</span> <span class="mi">13</span> 
<span class="n">VT_I1</span>       <span class="o">=</span> <span class="mi">16</span>
<span class="n">VT_UI1</span>      <span class="o">=</span> <span class="mi">17</span> 
<span class="n">VT_UI2</span>      <span class="o">=</span> <span class="mi">18</span>
<span class="n">VT_UI4</span>      <span class="o">=</span> <span class="mi">19</span>
<span class="n">VT_INT</span>      <span class="o">=</span> <span class="mi">20</span>
<span class="n">VT_UINT</span>     <span class="o">=</span> <span class="mi">21</span>

<div class="viewcode-block" id="VARIANT_guts"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.VARIANT_guts">[docs]</a><span class="k">class</span> <span class="nc">VARIANT_guts</span><span class="p">(</span><span class="n">Union</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;ui1&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ui2&#39;</span><span class="p">,</span> <span class="n">c_uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ui4&#39;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;i1&#39;</span><span class="p">,</span> <span class="n">c_int8</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;i2&#39;</span><span class="p">,</span> <span class="n">c_int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;i4&#39;</span><span class="p">,</span> <span class="n">c_int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;pad&#39;</span><span class="p">,</span> <span class="n">BYTE</span><span class="o">*</span><span class="mi">32</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<div class="viewcode-block" id="VARIANT"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.VARIANT">[docs]</a><span class="k">class</span> <span class="nc">VARIANT</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;vt&#39;</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;res1&#39;</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;res2&#39;</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;res3&#39;</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="n">VARIANT_guts</span><span class="p">),</span>
    <span class="p">]</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser">[docs]</a><span class="k">class</span> <span class="nc">Win32SymbolParser</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phandle</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">loadbase</span><span class="p">,</span> <span class="n">sympath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">phandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadbase</span> <span class="o">=</span> <span class="n">loadbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sympath</span> <span class="o">=</span> <span class="n">sympath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symopts</span> <span class="o">=</span> <span class="p">(</span><span class="n">SYMOPT_UNDNAME</span> <span class="o">|</span> <span class="n">SYMOPT_NO_PROMPTS</span> <span class="o">|</span> <span class="n">SYMOPT_NO_CPP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sym_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sym_enums</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sym_locals</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Win32SymbolParser.printSymbolInfo"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.printSymbolInfo">[docs]</a>    <span class="k">def</span> <span class="nf">printSymbolInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="c"># Just a helper function for &quot;reversing&quot; how dbghelp works</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_fields_</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">n</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeInfo"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeInfo">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tindex</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">tparam</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymGetTypeInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadbase</span><span class="p">,</span>
                                   <span class="n">tindex</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">tparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeName"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeName">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">c_wchar_p</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_SYMNAME</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">value</span>
        <span class="c"># Strip leading / trailing _&#39;s</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;&lt;unnamed-tag&gt;&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;unnamed&#39;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;_unnamed_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">typeid</span>
        <span class="c">#print repr(val)</span>
        <span class="k">return</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetUdtKind"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetUdtKind">[docs]</a>    <span class="k">def</span> <span class="nf">symGetUdtKind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_UDTKIND</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeOffset"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeOffset">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_OFFSET</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeLength"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeLength">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">c_ulonglong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_LENGTH</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">size</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetArrayIndexType"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetArrayIndexType">[docs]</a>    <span class="k">def</span> <span class="nf">symGetArrayIndexType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_ARRAYINDEXTYPEID</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeValue"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeValue">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="c">#size = c_ulonglong(0)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">VARIANT</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_VALUE</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">vt</span>

        <span class="c"># Messy, but gotta do it...</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_I1</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">i1</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_I2</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">i2</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_I4</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">i4</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_UI1</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ui1</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_UI2</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ui2</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">==</span> <span class="n">VT_UI4</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ui4</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unhandled Variant Type: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">vt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeBase"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeBase">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="n">typeid</span><span class="p">)</span>
        <span class="c"># Resolve the deepest base type</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeTag</span><span class="p">(</span><span class="n">btype</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">SymTagTypedef</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">btype</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">TI_GET_BASETYPE</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">btype</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">btype</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeType"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeType">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">ktype</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TI_GET_TYPE</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">ktype</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ktype</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symGetTypeTag"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symGetTypeTag">[docs]</a>    <span class="k">def</span> <span class="nf">symGetTypeTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeid</span><span class="p">):</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">TI_GET_SYMTAG</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">btype</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">btype</span><span class="o">.</span><span class="n">value</span>
</div>
    <span class="k">def</span> <span class="nf">_fixKidName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kidname</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">kidname</span> <span class="ow">and</span> <span class="n">kidname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">kidname</span> <span class="o">=</span> <span class="s">&#39;_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kidname</span>

        <span class="k">if</span> <span class="n">reserved</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kidname</span><span class="p">):</span>
            <span class="n">kidname</span> <span class="o">=</span> <span class="s">&#39;_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kidname</span>

        <span class="k">return</span> <span class="n">kidname</span>

    <span class="k">def</span> <span class="nf">_symTypeEnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tidx</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeLength</span><span class="p">(</span><span class="n">tidx</span><span class="p">)</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symGetChildren</span><span class="p">(</span><span class="n">tidx</span><span class="p">):</span>
            <span class="n">kidname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">kidval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeValue</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">kidname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixKidName</span><span class="p">(</span><span class="n">kidname</span><span class="p">)</span>
            <span class="n">kids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kidname</span><span class="p">,</span> <span class="n">kidval</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sym_enums</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">kids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_symTypeUserDefined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tidx</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeLength</span><span class="p">(</span><span class="n">tidx</span><span class="p">)</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symGetChildren</span><span class="p">(</span><span class="n">tidx</span><span class="p">):</span>
            <span class="n">kidname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">kidoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeOffset</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">ktype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeType</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">ksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeLength</span><span class="p">(</span><span class="n">ktype</span><span class="p">)</span>
            <span class="n">ktag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeTag</span><span class="p">(</span><span class="n">ktype</span><span class="p">)</span>

            <span class="n">kidname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixKidName</span><span class="p">(</span><span class="n">kidname</span><span class="p">)</span>
            <span class="n">kflags</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ktypename</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">kcount</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagPointerType</span><span class="p">:</span>
                <span class="n">kflags</span> <span class="o">|=</span> <span class="n">vs_builder</span><span class="o">.</span><span class="n">VSFF_POINTER</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeType</span><span class="p">(</span><span class="n">ktype</span><span class="p">)</span>
                <span class="n">ktypename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagArrayType</span><span class="p">:</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeType</span><span class="p">(</span><span class="n">ktype</span><span class="p">)</span>
                <span class="n">asize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeLength</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span>
                <span class="n">kcount</span> <span class="o">=</span> <span class="n">ksize</span> <span class="o">/</span> <span class="n">asize</span>

                <span class="c"># Now, we setup our *child* to be the type</span>
                <span class="n">ktypename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span>
                <span class="n">ksize</span> <span class="o">=</span> <span class="n">asize</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeTag</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span> <span class="o">==</span> <span class="n">SymTagPointerType</span><span class="p">:</span>
                    <span class="n">kflags</span> <span class="o">|=</span> <span class="n">vs_builder</span><span class="o">.</span><span class="n">VSFF_POINTER</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagEnum</span><span class="p">:</span>
                <span class="c">#ktypename = self.symGetTypeName(ktype)</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagUDT</span><span class="p">:</span>
                <span class="n">ktypename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">ktype</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagBaseType</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagFunctionType</span><span class="p">:</span>
                <span class="c"># Function pointer types...</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">ktag</span> <span class="o">==</span> <span class="n">SymTagNull</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> Unknown Type Tag: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kidname</span><span class="p">,</span> <span class="n">ktag</span><span class="p">)</span>

            <span class="n">kids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kidname</span><span class="p">,</span> <span class="n">kidoff</span><span class="p">,</span> <span class="n">ksize</span><span class="p">,</span> <span class="n">ktypename</span><span class="p">,</span> <span class="n">kflags</span><span class="p">,</span> <span class="n">kcount</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sym_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">kids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_symGetChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeIndex</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">c_ulong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeIndex</span><span class="p">,</span> <span class="n">TI_GET_CHILDRENCOUNT</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">tif</span> <span class="o">=</span> <span class="n">buildFindChildrenParams</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeInfo</span><span class="p">(</span><span class="n">typeIndex</span><span class="p">,</span> <span class="n">TI_FINDCHILDREN</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">tif</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">Children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">child</span>

<div class="viewcode-block" id="Win32SymbolParser.typeEnumCallback"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.typeEnumCallback">[docs]</a>    <span class="k">def</span> <span class="nf">typeEnumCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psym</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">sym</span> <span class="o">=</span> <span class="n">psym</span><span class="o">.</span><span class="n">contents</span>

        <span class="n">myname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeName</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">TypeIndex</span><span class="p">)</span>
        <span class="n">mytag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symGetTypeTag</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">TypeIndex</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mytag</span> <span class="o">==</span> <span class="n">SymTagUDT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_symTypeUserDefined</span><span class="p">(</span><span class="n">myname</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">TypeIndex</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">mytag</span> <span class="o">==</span> <span class="n">SymTagEnum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_symTypeEnum</span><span class="p">(</span><span class="n">myname</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">TypeIndex</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symEnumCallback"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symEnumCallback">[docs]</a>    <span class="k">def</span> <span class="nf">symEnumCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psym</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">sym</span> <span class="o">=</span> <span class="n">psym</span><span class="o">.</span><span class="n">contents</span>

        <span class="k">if</span> <span class="n">sym</span><span class="o">.</span><span class="n">Tag</span> <span class="o">==</span> <span class="n">SymTagFunction</span><span class="p">:</span>
            <span class="n">sym</span><span class="o">.</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">SYMFLAG_FUNCTION</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sym</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Address</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Size</span><span class="p">),</span> <span class="n">sym</span><span class="o">.</span><span class="n">Flags</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symFromAddr"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symFromAddr">[docs]</a>    <span class="k">def</span> <span class="nf">symFromAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">SYMBOL_INFO</span><span class="p">()</span>
        <span class="n">si</span><span class="o">.</span><span class="n">SizeOfStruct</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2000</span>
        <span class="n">si</span><span class="o">.</span><span class="n">MaxNameLen</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">QWORD</span><span class="p">()</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymFromAddr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">disp</span><span class="p">),</span> <span class="n">pointer</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">si</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symInit"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symInit">[docs]</a>    <span class="k">def</span> <span class="nf">symInit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymInitialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sympath</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetOptions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symopts</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymLoadModule64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                        <span class="bp">None</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loadbase</span><span class="p">,</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>


            <span class="c"># This is for debugging which pdb got loaded</span>
            <span class="c">#imghlp = IMAGEHLP_MODULE64()</span>
            <span class="c">#imghlp.SizeOfStruct = sizeof(imghlp)</span>
            <span class="c">#dbghelp.SymGetModuleInfo64(self.phandle, x, pointer(imghlp))</span>
            <span class="c">#print &quot;PDB&quot;,repr(imghlp.LoadedPdbName)</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symCleanup"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symCleanup">[docs]</a>    <span class="k">def</span> <span class="nf">symCleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.symLocalCallback"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.symLocalCallback">[docs]</a>    <span class="k">def</span> <span class="nf">symLocalCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psym</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">sym</span> <span class="o">=</span> <span class="n">psym</span><span class="o">.</span><span class="n">contents</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">c_int32</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">Flags</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.parseArgs"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.parseArgs">[docs]</a>    <span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>

            <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symFromAddr</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">Tag</span> <span class="o">!=</span> <span class="n">SymTagFunction</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cur_locs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">sframe</span> <span class="o">=</span> <span class="n">IMAGEHLP_STACK_FRAME</span><span class="p">()</span>
            <span class="n">sframe</span><span class="o">.</span><span class="n">InstructionOffset</span> <span class="o">=</span> <span class="n">addr</span>
            <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymSetContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span> <span class="n">pointer</span><span class="p">(</span><span class="n">sframe</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumSymbols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">None</span><span class="p">,</span>
                        <span class="n">SYMCALLBACK</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symLocalCallback</span><span class="p">),</span>
                        <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur_locs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sym_locals</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur_locs</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.parse"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">symInit</span><span class="p">()</span>

            <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumSymbols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loadbase</span><span class="p">,</span>
                        <span class="bp">None</span><span class="p">,</span>
                        <span class="n">SYMCALLBACK</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symEnumCallback</span><span class="p">),</span>
                        <span class="n">NULL</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parseTypes</span><span class="p">()</span>
            <span class="c">#self.parseArgs()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">symCleanup</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.parseTypes"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.parseTypes">[docs]</a>    <span class="k">def</span> <span class="nf">parseTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#self.symInit()</span>
        <span class="c"># This is how you enumerate type information</span>
        <span class="n">dbghelp</span><span class="o">.</span><span class="n">SymEnumTypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phandle</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loadbase</span><span class="p">,</span>
                    <span class="n">SYMCALLBACK</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typeEnumCallback</span><span class="p">),</span>
                    <span class="n">NULL</span><span class="p">)</span>

        <span class="c">#self.symCleanup()</span>
</div>
<div class="viewcode-block" id="Win32SymbolParser.loadSymsIntoTrace"><a class="viewcode-back" href="../../../vtrace.platforms.html#vtrace.platforms.win32.Win32SymbolParser.loadSymsIntoTrace">[docs]</a>    <span class="k">def</span> <span class="nf">loadSymsIntoTrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">normname</span><span class="p">):</span>

        <span class="n">funcflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">SYMFLAG_FUNCTION</span> <span class="o">|</span> <span class="n">SYMFLAG_EXPORT</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">symclass</span> <span class="o">=</span> <span class="n">e_resolv</span><span class="o">.</span><span class="n">Symbol</span>
            <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">funcflags</span><span class="p">:</span>
                <span class="n">symclass</span> <span class="o">=</span> <span class="n">e_resolv</span><span class="o">.</span><span class="n">FunctionSymbol</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="n">symclass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">normname</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">addSymbol</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_types</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_enums</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c"># Only add the namespace if we have values...</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">vs_builder</span><span class="o">.</span><span class="n">VStructBuilder</span><span class="p">(</span><span class="n">defs</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">enums</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">vsbuilder</span><span class="o">.</span><span class="n">addVStructNamespace</span><span class="p">(</span><span class="n">normname</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../vtrace.html" >vtrace</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, @invisig0th.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>