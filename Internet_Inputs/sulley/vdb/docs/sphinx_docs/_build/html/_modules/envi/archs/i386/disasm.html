

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>envi.archs.i386.disasm &mdash; Visi Debugger  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Visi Debugger  documentation" href="../../../../index.html" />
    <link rel="up" title="envi.archs.i386" href="../i386.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../envi.html" >envi</a> &raquo;</li>
          <li><a href="../i386.html" accesskey="U">envi.archs.i386</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for envi.archs.i386.disasm</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The guts for the i386 envi opcode disassembler.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">import</span> <span class="nn">envi</span>
<span class="kn">import</span> <span class="nn">envi.bits</span> <span class="kn">as</span> <span class="nn">e_bits</span>

<span class="kn">import</span> <span class="nn">opcode86</span>
<span class="n">all_tables</span> <span class="o">=</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">tables86</span>

<span class="c"># Grab our register enums etc...</span>
<span class="kn">from</span> <span class="nn">envi.archs.i386.regs</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Our instruction prefix masks</span>
<span class="c"># NOTE: table 3-4 (section 3.6) of intel 1 shows how REX/OP_SIZE</span>
<span class="c"># interact...</span>
<span class="n">INSTR_PREFIX</span><span class="o">=</span>      <span class="mh">0x0001</span>
<span class="n">PREFIX_LOCK</span> <span class="o">=</span>      <span class="mh">0x0002</span>
<span class="n">PREFIX_REPNZ</span><span class="o">=</span>      <span class="mh">0x0004</span>
<span class="n">PREFIX_REPZ</span> <span class="o">=</span>      <span class="mh">0x0008</span>
<span class="n">PREFIX_REP</span>  <span class="o">=</span>      <span class="mh">0x0010</span>
<span class="n">PREFIX_REP_SIMD</span><span class="o">=</span>   <span class="mh">0x0020</span>
<span class="n">PREFIX_OP_SIZE</span><span class="o">=</span>    <span class="mh">0x0040</span>
<span class="n">PREFIX_ADDR_SIZE</span><span class="o">=</span>  <span class="mh">0x0080</span>
<span class="n">PREFIX_SIMD</span><span class="o">=</span>       <span class="mh">0x0100</span>
<span class="n">PREFIX_CS</span>  <span class="o">=</span>       <span class="mh">0x0200</span>
<span class="n">PREFIX_SS</span>  <span class="o">=</span>       <span class="mh">0x0400</span>
<span class="n">PREFIX_DS</span>  <span class="o">=</span>       <span class="mh">0x0800</span>
<span class="n">PREFIX_ES</span>  <span class="o">=</span>       <span class="mh">0x1000</span>
<span class="n">PREFIX_FS</span>  <span class="o">=</span>       <span class="mh">0x2000</span>
<span class="n">PREFIX_GS</span>  <span class="o">=</span>       <span class="mh">0x4000</span>
<span class="n">PREFIX_REG_MASK</span><span class="o">=</span>   <span class="mh">0x8000</span>

<span class="c"># envi.registers meta offsets</span>
<span class="n">RMETA_LOW8</span>  <span class="o">=</span> <span class="mh">0x00080000</span>
<span class="n">RMETA_HIGH8</span> <span class="o">=</span> <span class="mh">0x08080000</span>
<span class="n">RMETA_LOW16</span> <span class="o">=</span> <span class="mh">0x00100000</span>

<span class="c"># Use a list here instead of a dict for speed (max 255 anyway)</span>
<span class="n">i386_prefixes</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="p">]</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0xF0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_LOCK</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0xF2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_REPNZ</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0xF3</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_REP</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x2E</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_CS</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x36</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_SS</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x3E</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_DS</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x26</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_ES</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x64</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_FS</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x65</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_GS</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x66</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_OP_SIZE</span>
<span class="n">i386_prefixes</span><span class="p">[</span><span class="mh">0x67</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREFIX_ADDR_SIZE</span>

<span class="c"># The scale byte index into this for multiplier imm</span>
<span class="n">scale_lookup</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="c"># A set of instructions that are considered privileged (mark with IF_PRIV)</span>
<span class="c"># FIXME this should be part of the opcdode tables!</span>
<span class="n">priv_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;int&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;in&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;out&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;insb&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;outsb&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;insd&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;outsd&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmcall&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmlaunch&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmresume&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmxoff&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmread&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmwrite&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;rsm&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;lar&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;lsl&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;clts&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;invd&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;wbinvd&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;wrmsr&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;rdmsr&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;sysexit&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;lgdt&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;lidt&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;lmsw&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;monitor&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;mwait&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmclear&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmptrld&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmptrst&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;vmxon&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># Map of codes to their respective envi flags</span>
<span class="n">iflag_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_RET</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_NOFALL</span><span class="o">|</span><span class="n">envi</span><span class="o">.</span><span class="n">IF_RET</span><span class="p">,</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_CALL</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_CALL</span><span class="p">,</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_HALT</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_NOFALL</span><span class="p">,</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_CALLCC</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_CALL</span><span class="p">,</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_BRANCH</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_NOFALL</span> <span class="o">|</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_BRANCH</span><span class="p">,</span>
    <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_BRANCHCC</span><span class="p">:</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_BRANCH</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">sizenames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">)]</span>
<span class="n">sizenames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;byte&quot;</span>
<span class="n">sizenames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;word&quot;</span>
<span class="n">sizenames</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;dword&quot;</span>
<span class="n">sizenames</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;qword&quot;</span>
<span class="n">sizenames</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;oword&quot;</span>

<span class="k">def</span> <span class="nf">addrToName</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="n">va</span><span class="p">):</span>
<div class="viewcode-block" id="addrToName"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.addrToName">[docs]</a>    <span class="n">sym</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymByAddr</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sym</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">va</span>

<span class="c">###########################################################################</span>
<span class="c">#</span>
<span class="c"># Operand objects for the i386 architecture</span>
<span class="c">#</span>


<span class="k">class</span> <span class="nc">i386RegOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">RegisterOper</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegOper">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<div class="viewcode-block" id="i386RegOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegOper.repr">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegOper.getOperValue">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>
        <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegOper.setOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegOper.setOperValue">[docs]</a>        <span class="n">emu</span><span class="o">.</span><span class="n">setRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegOper.render">[docs]</a>        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;registers&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;registers&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></div>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">i386ImmOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">ImmedOper</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmOper">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An operand representing an immediate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<div class="viewcode-block" id="i386ImmOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmOper.repr">[docs]</a>        <span class="n">ival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>
        <span class="k">if</span> <span class="n">ival</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ival</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmOper.getOperValue">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmOper.render">[docs]</a>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>
        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">isValidPointer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">isValidPointer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">addrToName</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></div>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386ImmOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">i386PcRelOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">Operand</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386PcRelOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386PcRelOper">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the operand used for EIP relative offsets</span>
<span class="sd">    for operands on instructions like jmp/call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<div class="viewcode-block" id="i386PcRelOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386PcRelOper.repr">[docs]</a>        <span class="k">return</span> <span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isImmed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386PcRelOper.isImmed"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386PcRelOper.isImmed">[docs]</a>        <span class="k">return</span> <span class="bp">True</span> <span class="c"># FIXME trying this out....</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386PcRelOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386PcRelOper.getOperValue">[docs]</a>        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386PcRelOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386PcRelOper.render">[docs]</a>        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">addrToName</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></div>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386PcRelOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">i386RegMemOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">DerefOper</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An operand which represents the result of reading/writting memory from the</span>
<span class="sd">    dereference (with possible displacement) from a given register.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<div class="viewcode-block" id="i386RegMemOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.repr">[docs]</a>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [</span><span class="si">%s</span><span class="s"> + </span><span class="si">%d</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">],</span><span class="n">r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [</span><span class="si">%s</span><span class="s"> - </span><span class="si">%d</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">],</span><span class="n">r</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">],</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.getOperValue">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>
        <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">readMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper.setOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.setOperValue">[docs]</a>        <span class="n">emu</span><span class="o">.</span><span class="n">writeMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper.getOperAddr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.getOperAddr">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">getSegmentInfo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">rval</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span>

    <span class="k">def</span> <span class="nf">isDeref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper.isDeref"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.isDeref">[docs]</a>        <span class="c"># The disassembler may reach in and set this (if lea...)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386RegMemOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386RegMemOper.render">[docs]</a>        <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">])</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; [&quot;</span><span class="p">)</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">),</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;registers&quot;</span><span class="p">)</span>
        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; + &quot;</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; + &quot;</span><span class="p">)</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">)</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">)))</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></div>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">disp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">i386ImmMemOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">DerefOper</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An operand which represents the dereference (memory read/write) of</span>
<span class="sd">    a memory location associated with an immediate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">isDeref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="i386ImmMemOper.isDeref"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.isDeref">[docs]</a>        <span class="c"># The disassembler may reach in and set this (if lea...)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.repr">[docs]</a>        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [0x</span><span class="si">%.8x</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.getOperValue">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>
        <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">readMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper.setOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.setOperValue">[docs]</a>        <span class="n">emu</span><span class="o">.</span><span class="n">writeMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper.getOperAddr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.getOperAddr">[docs]</a>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>
        <span class="k">if</span> <span class="n">emu</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">getSegmentInfo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="n">base</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386ImmMemOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386ImmMemOper.render">[docs]</a>        <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">])</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; [&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>

        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">addrToName</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></div>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386ImmMemOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">i386SibOper</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">DerefOper</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386SibOper"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An operand which represents the result of reading/writting memory from the</span>
<span class="sd">    dereference (with possible displacement) from a given register.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">imm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">tsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">i386SibOper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">disp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tsize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">isDeref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="i386SibOper.isDeref"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.isDeref">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_deref</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386SibOper.repr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.repr">[docs]</a>
        <span class="n">r</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [&quot;</span> <span class="o">%</span> <span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot; + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot; * </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot; + </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot; - </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">+=</span> <span class="s">&quot;]&quot;</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386SibOper.getOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.getOperValue">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>
        <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">readMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386SibOper.setOperValue"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.setOperValue">[docs]</a>        <span class="n">emu</span><span class="o">.</span><span class="n">writeMemValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386SibOper.getOperAddr"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.getOperAddr">[docs]</a>        <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># This operand type requires an emulator</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="n">emu</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="c"># Handle x86 segmentation</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">getSegmentInfo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">base</span>

        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span>

    <span class="k">def</span> <span class="nf">_getOperBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
        <span class="c"># Special SIB only method for getting the SIB base value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span>
        <span class="k">if</span> <span class="n">emu</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<div class="viewcode-block" id="i386SibOper.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386SibOper.render">[docs]</a>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">sizenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tsize</span><span class="p">])</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; [&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">addrToName</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;registers&quot;</span><span class="p">)</span>

        <span class="c"># Does our SIB have a scale</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; + &quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span><span class="o">.</span><span class="n">getRegisterName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;registers&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; * &quot;</span><span class="p">)</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>

        <span class="n">hint</span> <span class="o">=</span> <span class="n">mcanv</span><span class="o">.</span><span class="n">syms</span><span class="o">.</span><span class="n">getSymHint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">va</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; + &quot;</span><span class="p">)</span>
            <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If we have a displacement, add it.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; + &quot;</span><span class="p">)</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">))</span>

        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">i386Opcode</span><span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">Opcode</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="i386Opcode"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Opcode">[docs]</a>
    <span class="c"># Printable prefix names</span>
    <span class="n">prefix_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">PREFIX_LOCK</span><span class="p">,</span> <span class="s">&quot;lock&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_REPNZ</span><span class="p">,</span> <span class="s">&quot;repnz&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_REP</span><span class="p">,</span> <span class="s">&quot;rep&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_CS</span><span class="p">,</span> <span class="s">&quot;cs&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_SS</span><span class="p">,</span> <span class="s">&quot;ss&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_DS</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_ES</span><span class="p">,</span> <span class="s">&quot;es&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_FS</span><span class="p">,</span> <span class="s">&quot;fs&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PREFIX_GS</span><span class="p">,</span> <span class="s">&quot;gs&quot;</span><span class="p">),</span>
    <span class="p">]</span>


    <span class="k">def</span> <span class="nf">getBranches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<div class="viewcode-block" id="i386Opcode.getBranches"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Opcode.getBranches">[docs]</a>        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># To start with we have no flags.</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">addb</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># If we are a conditional branch, even our fallthrough</span>
        <span class="c"># case is conditional...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_BRANCHCC</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_COND</span>
            <span class="n">addb</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># If we can fall through, reflect that...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_NOFALL</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">va</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="o">|</span><span class="n">envi</span><span class="o">.</span><span class="n">BR_FALL</span><span class="p">))</span>

        <span class="c"># In intel, if we have no operands, it has no</span>
        <span class="c"># further branches...</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="c"># Check for a call...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_CALL</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_PROC</span>
            <span class="n">addb</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># A conditional call?  really?  what compiler did you use? ;)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_CALLCC</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">envi</span><span class="o">.</span><span class="n">BR_PROC</span> <span class="o">|</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_COND</span><span class="p">)</span>
            <span class="n">addb</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_BRANCH</span><span class="p">:</span>
            <span class="n">oper0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oper0</span><span class="p">,</span> <span class="n">i386SibOper</span><span class="p">)</span> <span class="ow">and</span> <span class="n">oper0</span><span class="o">.</span><span class="n">scale</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c"># In the case with no emulator, note that our deref is</span>
                <span class="c"># from the base of a table. If we have one, parse out all the</span>
                <span class="c"># valid pointers from our base</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">oper0</span><span class="o">.</span><span class="n">_getOperBase</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">emu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_DEREF</span> <span class="o">|</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_TABLE</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Since we&#39;re parsing this out, lets just resolve the derefs</span>
                    <span class="c"># for our caller...</span>
                    <span class="n">dest</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">readMemValue</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">oper0</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>
                    <span class="k">while</span> <span class="n">emu</span><span class="o">.</span><span class="n">isValidPointer</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dest</span><span class="p">,</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_COND</span><span class="p">))</span>
                        <span class="n">base</span> <span class="o">+=</span> <span class="n">oper0</span><span class="o">.</span><span class="n">tsize</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">readMemValue</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">oper0</span><span class="o">.</span><span class="n">tsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addb</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">addb</span><span class="p">:</span>
            <span class="n">oper0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">oper0</span><span class="o">.</span><span class="n">isDeref</span><span class="p">():</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_DEREF</span>
                <span class="n">tova</span> <span class="o">=</span> <span class="n">oper0</span><span class="o">.</span><span class="n">getOperAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="n">emu</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tova</span> <span class="o">=</span> <span class="n">oper0</span><span class="o">.</span><span class="n">getOperValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="n">emu</span><span class="p">)</span>

            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tova</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcanv</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Opcode.render"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Opcode.render">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render this opcode to the specified memory canvas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">:</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPrefixName</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pfx</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">pfx</span><span class="p">)</span>

        <span class="n">mcanv</span><span class="o">.</span><span class="n">addNameText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mnem</span><span class="p">,</span> <span class="n">typename</span><span class="o">=</span><span class="s">&quot;mnemonic&quot;</span><span class="p">)</span>
        <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>

        <span class="c"># Allow each of our operands to render</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opers</span><span class="p">)</span>
        <span class="n">lasti</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">imax</span><span class="p">):</span>
            <span class="n">oper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">oper</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mcanv</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lasti</span><span class="p">:</span>
                <span class="n">mcanv</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>

<span class="n">operand_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span></div></div>

<span class="n">MODE_16</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MODE_32</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MODE_64</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span> <span class="nc">i386Disasm</span><span class="p">:</span>
<div class="viewcode-block" id="i386Disasm"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">MODE_32</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_mode</span> <span class="o">=</span> <span class="n">MODE_32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_prefixes</span> <span class="o">=</span> <span class="n">i386_prefixes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span> <span class="o">=</span> <span class="n">i386RegisterContext</span><span class="p">()</span>

        <span class="c"># This will make function lookups nice and quick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_A</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_C</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_D</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_E</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_M</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_N</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_Q</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_R</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_W</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_I</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_J</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_j</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_O</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_G</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_P</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_S</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_U</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_V</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_X</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_Y</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_y</span>

        <span class="c"># Offsets used to add in addressing method parsers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETMMX</span>   <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;mm0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETSIMD</span>  <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;xmm0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETDEBUG</span> <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;debug0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETCTRL</span>  <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;ctrl0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETTEST</span>  <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;test0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETSEG</span>   <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;es&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETFPU</span>   <span class="o">=</span> <span class="n">getRegOffset</span><span class="p">(</span><span class="n">i386regs</span><span class="p">,</span> <span class="s">&quot;st0&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_modrm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">byte</span><span class="p">):</span>
<div class="viewcode-block" id="i386Disasm.parse_modrm"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.parse_modrm">[docs]</a>        <span class="c"># Pass in a string with an offset for speed rather than a new string</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x7</span>
        <span class="c">#print &quot;MOD/RM&quot;,hex(byte),mod,reg,rm</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">byteRegOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.byteRegOffset"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.byteRegOffset">[docs]</a>        <span class="c"># NOTE: This is used for high byte metas in 32 bit mode only</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span> <span class="o">+</span> <span class="n">RMETA_LOW8</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">RMETA_HIGH8</span>

    <span class="c"># Parse modrm as though addr mode might not be just a reg</span>
    <span class="k">def</span> <span class="nf">extended_parse_modrm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">opersize</span><span class="p">,</span> <span class="n">regbase</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.extended_parse_modrm"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.extended_parse_modrm">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tuple of (size, Operand)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>

        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c">#print &quot;EXTENDED MOD REG RM&quot;,mod,reg,rm</span>

        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c"># Easy one, just a reg</span>
            <span class="c"># FIXME only use self.byteRegOffset in 32 bit mode, NOT 64 bit...</span>
            <span class="k">if</span> <span class="n">opersize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">byteRegOffset</span><span class="p">(</span><span class="n">rm</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opersize</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">rm</span> <span class="o">+=</span> <span class="n">RMETA_LOW16</span>
            <span class="c">#print &quot;OPERSIZE&quot;,opersize,rm</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">rm</span><span class="o">+</span><span class="n">regbase</span><span class="p">,</span> <span class="n">opersize</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># means we are [reg] unless rm == 4 (SIB) or rm == 5 ([imm32])</span>
            <span class="k">if</span> <span class="n">rm</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span>
                <span class="c"># NOTE: in 64 bit mode, *this* is where we differ, (This case is RIP relative)</span>
                <span class="k">return</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i386ImmMemOper</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">opersize</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">rm</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sibsize</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">imm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_sib</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="n">sibsize</span>
                <span class="k">if</span> <span class="n">base</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">base</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">index</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="n">oper</span> <span class="o">=</span> <span class="n">i386SibOper</span><span class="p">(</span><span class="n">opersize</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">imm</span><span class="o">=</span><span class="n">imm</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale_lookup</span><span class="p">[</span><span class="n">scale</span><span class="p">])</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">oper</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">(</span><span class="n">regbase</span><span class="o">+</span><span class="n">rm</span><span class="p">,</span> <span class="n">opersize</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># mod 1 means we are [ reg + disp8 ] (unless rm == 4 which means sib + disp8)</span>
            <span class="k">if</span> <span class="n">rm</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sibsize</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">imm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_sib</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="n">sibsize</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">base</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">base</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">index</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="n">oper</span> <span class="o">=</span> <span class="n">i386SibOper</span><span class="p">(</span><span class="n">opersize</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale_lookup</span><span class="p">[</span><span class="n">scale</span><span class="p">],</span> <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">oper</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">signed</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">(</span><span class="n">regbase</span><span class="o">+</span><span class="n">rm</span><span class="p">,</span> <span class="n">opersize</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># Means we are [ reg + disp32 ] (unless rm == 4  which means SIB + disp32)</span>
            <span class="k">if</span> <span class="n">rm</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sibsize</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">imm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_sib</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span><span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span><span class="n">mod</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="n">sibsize</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">base</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">base</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="n">index</span> <span class="o">+=</span> <span class="n">regbase</span>    <span class="c"># Adjust for different register addressing modes</span>
                <span class="n">oper</span> <span class="o">=</span> <span class="n">i386SibOper</span><span class="p">(</span><span class="n">opersize</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">imm</span><span class="o">=</span><span class="n">imm</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale_lookup</span><span class="p">[</span><span class="n">scale</span><span class="p">],</span> <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">oper</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># NOTE: Immediate displacements in SIB are still 4 bytes in 64 bit mode</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span>
                <span class="k">return</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">(</span><span class="n">regbase</span><span class="o">+</span><span class="n">rm</span><span class="p">,</span> <span class="n">opersize</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;How does mod == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_sib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.parse_sib"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.parse_sib">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tuple of (size, scale, index, base, imm)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span>
        <span class="n">base</span>  <span class="o">=</span> <span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x7</span>
        <span class="n">imm</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># Special SIB case with no index reg</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Special SIB case with possible immediate</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># [ imm32 + index * scale ]</span>
                <span class="n">base</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="c"># FIXME is there special stuff needed here?</span>
            <span class="k">elif</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c">#raise &quot;OMG MOD 1&quot;</span>
            <span class="k">elif</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c">#raise &quot;OMG MOD 2&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">imm</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_dis_calc_tsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opertype</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the oper type and prefixes to decide on the tsize for</span>
<span class="sd">        the operand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_32</span>

        <span class="c">#print &quot;OPERTYPE&quot;,hex(opertype)</span>
        <span class="n">sizelist</span> <span class="o">=</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">OPERSIZE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opertype</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sizelist</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="s">&quot;OPERSIZE FAIL: </span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">opertype</span>

        <span class="k">if</span> <span class="n">prefixes</span> <span class="o">&amp;</span> <span class="n">PREFIX_OP_SIZE</span><span class="p">:</span>

            <span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_16</span>

        <span class="c">#print &quot;OPERTYPE&quot;,hex(opertype)</span>
        <span class="c">#print &quot;SIZELIST&quot;,repr(sizelist)</span>
        <span class="k">return</span> <span class="n">sizelist</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">disasm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">va</span><span class="p">):</span>
<div class="viewcode-block" id="i386Disasm.disasm"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.disasm">[docs]</a>
        <span class="c"># Stuff for opcode parsing</span>
        <span class="n">tabdesc</span> <span class="o">=</span> <span class="n">all_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># A tuple (optable, shiftbits, mask byte, sub, max)</span>
        <span class="n">startoff</span> <span class="o">=</span> <span class="n">offset</span> <span class="c"># Use startoff as a size knob if needed</span>

        <span class="c"># Stuff we&#39;ll be putting in the opcode object</span>
        <span class="n">optype</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># This gets set if we successfully decode below</span>
        <span class="n">mnem</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="n">operands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">prefixes</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

            <span class="n">obyte</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span>

            <span class="c"># This line changes in 64 bit mode</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_prefixes</span><span class="p">[</span><span class="n">obyte</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">obyte</span> <span class="o">==</span> <span class="mh">0x66</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">prefixes</span> <span class="o">|=</span> <span class="n">p</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c">#pdone = False</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

            <span class="n">obyte</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span>

            <span class="c">#print &quot;OBYTE&quot;,hex(obyte)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">obyte</span> <span class="o">&gt;</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                <span class="c">#print &quot;Jumping To Overflow Table:&quot;, tabdesc[5]</span>
                <span class="n">tabdesc</span> <span class="o">=</span> <span class="n">all_tables</span><span class="p">[</span><span class="n">tabdesc</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>

            <span class="n">tabidx</span> <span class="o">=</span> <span class="p">((</span><span class="n">obyte</span> <span class="o">-</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c">#print &quot;TABIDX: %d&quot; % tabidx</span>
            <span class="n">opdesc</span> <span class="o">=</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">tabidx</span><span class="p">]</span>
            <span class="c">#print &#39;OPDESC: %s&#39; % repr(opdesc)</span>

            <span class="c"># Hunt down multi-byte opcodes</span>
            <span class="n">nexttable</span> <span class="o">=</span> <span class="n">opdesc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c">#print &quot;NEXT&quot;,nexttable,hex(obyte)</span>
            <span class="k">if</span> <span class="n">nexttable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># If we have a sub-table specified, use it.</span>
                <span class="c">#print &quot;Multi-Byte Next Hop For&quot;,hex(obyte),opdesc[0]</span>
                <span class="n">tabdesc</span> <span class="o">=</span> <span class="n">all_tables</span><span class="p">[</span><span class="n">nexttable</span><span class="p">]</span>

                <span class="c"># In the case of 66 0f, the next table is *already* assuming we ate</span>
                <span class="c"># the 66 *and* the 0f...  oblidge them.</span>
                <span class="k">if</span> <span class="n">obyte</span> <span class="o">==</span> <span class="mh">0x66</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c"># Account for the table jump we made</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">continue</span>

            <span class="c"># We are now on the final table...</span>
            <span class="c">#print repr(opdesc)</span>
            <span class="n">mnem</span> <span class="o">=</span> <span class="n">opdesc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">optype</span> <span class="o">=</span> <span class="n">opdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tabdesc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># For our final opcode byte</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#print tabidx</span>
            <span class="c">#print opdesc</span>
            <span class="c">#print &quot;OPTTYPE 0&quot;</span>
            <span class="k">raise</span> <span class="n">envi</span><span class="o">.</span><span class="n">InvalidInstruction</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">[</span><span class="n">startoff</span><span class="p">:</span><span class="n">startoff</span><span class="o">+</span><span class="mi">16</span><span class="p">])</span>

        <span class="n">operoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># Begin parsing operands based off address method</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">operand_range</span><span class="p">:</span>

            <span class="n">oper</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Set this if we end up with an operand</span>
            <span class="n">osize</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c"># Pull out the operand description from the table</span>
            <span class="n">operflags</span> <span class="o">=</span> <span class="n">opdesc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">opertype</span> <span class="o">=</span> <span class="n">operflags</span> <span class="o">&amp;</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">OPTYPE_MASK</span>
            <span class="n">addrmeth</span> <span class="o">=</span> <span class="n">operflags</span> <span class="o">&amp;</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_MASK</span>

            <span class="c"># If there are no more operands, break out of the loop!</span>
            <span class="k">if</span> <span class="n">operflags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c">#print &quot;ADDRTYPE: %.8x OPERTYPE: %.8x&quot; % (addrmeth, opertype)</span>

            <span class="n">tsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_calc_tsize</span><span class="p">(</span><span class="n">opertype</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span>

            <span class="c">#print hex(opertype),hex(addrmeth)</span>


            <span class="c"># If addrmeth is zero, we have operands embedded in the opcode</span>
            <span class="k">if</span> <span class="n">addrmeth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">osize</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">oper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ameth_0</span><span class="p">(</span><span class="n">operflags</span><span class="p">,</span> <span class="n">opdesc</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">],</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c">#print &quot;ADDRTYPE&quot;,hex(addrmeth)</span>
                <span class="n">ameth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_amethods</span><span class="p">[</span><span class="n">addrmeth</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">]</span>
                <span class="c">#print &quot;AMETH&quot;,ameth</span>
                <span class="k">if</span> <span class="n">ameth</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Implement Addressing Method 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">addrmeth</span><span class="p">)</span>

                <span class="c"># NOTE: Depending on your addrmethod you may get beginning of operands, or offset</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">addrmeth</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_I</span> <span class="ow">or</span> <span class="n">addrmeth</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">ADDRMETH_J</span><span class="p">:</span>
                        <span class="n">osize</span><span class="p">,</span> <span class="n">oper</span> <span class="o">=</span> <span class="n">ameth</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">operoffset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span>

                        <span class="c"># If we are a sign extended immediate and not the same as the other operand,</span>
                        <span class="c"># do the sign extension during disassembly so nothing else has to worry about it..</span>
                        <span class="k">if</span> <span class="n">operflags</span> <span class="o">&amp;</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">OP_SIGNED</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">operands</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tsize</span> <span class="o">!=</span> <span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tsize</span><span class="p">:</span>
                            <span class="n">otsize</span> <span class="o">=</span> <span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tsize</span>
                            <span class="n">oper</span><span class="o">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">sign_extend</span><span class="p">(</span><span class="n">oper</span><span class="o">.</span><span class="n">imm</span><span class="p">,</span> <span class="n">oper</span><span class="o">.</span><span class="n">tsize</span><span class="p">,</span> <span class="n">otsize</span><span class="p">)</span>
                            <span class="n">oper</span><span class="o">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">otsize</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">osize</span><span class="p">,</span> <span class="n">oper</span> <span class="o">=</span> <span class="n">ameth</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c"># Catch struct unpack errors due to insufficient data length</span>
                    <span class="k">raise</span> <span class="n">envi</span><span class="o">.</span><span class="n">InvalidInstruction</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">[</span><span class="n">startoff</span><span class="p">:</span><span class="n">startoff</span><span class="o">+</span><span class="mi">16</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">oper</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># This is a filty hack for now...</span>
                <span class="n">oper</span><span class="o">.</span><span class="n">_dis_regctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dis_regctx</span>
                <span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oper</span><span class="p">)</span>
            <span class="n">operoffset</span> <span class="o">+=</span> <span class="n">osize</span>

        <span class="c"># Pull in the envi generic instruction flags</span>
        <span class="n">iflags</span> <span class="o">=</span> <span class="n">iflag_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">optype</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">priv_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mnem</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">iflags</span> <span class="o">|=</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_PRIV</span>

        <span class="c"># Lea will have a reg-mem/sib operand with _is_deref True, but should be false</span>
        <span class="k">if</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">INS_LEA</span><span class="p">:</span>
            <span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_is_deref</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">i386Opcode</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">optype</span><span class="p">,</span> <span class="n">mnem</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">-</span><span class="n">startoff</span><span class="p">)</span><span class="o">+</span><span class="n">operoffset</span><span class="p">,</span> <span class="n">operands</span><span class="p">,</span> <span class="n">iflags</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="c"># Declare all the address method parsers here!</span>

    <span class="k">def</span> <span class="nf">ameth_0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operflags</span><span class="p">,</span> <span class="n">operval</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_0"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_0">[docs]</a>        <span class="c"># Special address method for opcodes with embedded operands</span>
        <span class="k">if</span> <span class="n">operflags</span> <span class="o">&amp;</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">OP_REG</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">operval</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operflags</span> <span class="o">&amp;</span> <span class="n">opcode86</span><span class="o">.</span><span class="n">OP_IMM</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i386ImmOper</span><span class="p">(</span><span class="n">operval</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unknown ameth_0! operflags: 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">operflags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ameth_a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_a"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_a">[docs]</a>        <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">tsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c"># THIS BEING GHETTORIGGED ONLY EFFECTS callf jmpf</span>
        <span class="c">#print &quot;FIXME: envi.intel.ameth_a skipping seg prefix %d&quot; % seg</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tsize</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">i386ImmOper</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_e"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_e">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_parse_modrm</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ameth_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_n"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_n">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">rm</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETMMX</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_q"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_q">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">rm</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETMMX</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_parse_modrm</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ameth_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_w"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_w">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">rm</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETSIMD</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_parse_modrm</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ameth_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_i"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_i">[docs]</a>        <span class="c"># FIXME sign extend here if opflags has OP_SIGNED</span>
        <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tsize</span><span class="p">,</span> <span class="n">i386ImmOper</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_j</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_j"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_j">[docs]</a>        <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tsize</span><span class="p">,</span> <span class="n">i386PcRelOper</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_o</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_o"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_o">[docs]</a>        <span class="c"># NOTE: displacement *stays* 32 bit even with REX</span>
        <span class="c"># (but 16 bit should probably be supported)</span>
        <span class="n">imm</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">i386ImmMemOper</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_g"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_g">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">tsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">byteRegOffset</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tsize</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">reg</span> <span class="o">+=</span> <span class="n">RMETA_LOW16</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_c"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_c">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETCTRL</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_d"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_d">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETDEBUG</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_p"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_p">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETMMX</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_s"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_s">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETSEG</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_u"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_u">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETTEST</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_v"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_v">[docs]</a>        <span class="n">mod</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_modrm</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">offset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegOper</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ROFFSETSIMD</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_x"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_x">[docs]</a>        <span class="c">#FIXME this needs the DS over-ride, but is only for outsb which we don&#39;t support</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">(</span><span class="n">REG_ESI</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ameth_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span></div>
<div class="viewcode-block" id="i386Disasm.ameth_y"><a class="viewcode-back" href="../../../../envi.archs.i386.html#envi.archs.i386.disasm.i386Disasm.ameth_y">[docs]</a>        <span class="c">#FIXME this needs the ES over-ride, but is only for insb which we don&#39;t support</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i386RegMemOper</span><span class="p">(</span><span class="n">REG_ESI</span><span class="p">,</span> <span class="n">tsize</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span></div></div>

    <span class="c"># A little helper to make testing easier</span>

    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">i386Disasm</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">va</span> <span class="o">=</span> <span class="mh">0x41414141</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">va</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">va</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="p">)]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../envi.html" >envi</a> &raquo;</li>
          <li><a href="../i386.html" >envi.archs.i386</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, @invisig0th.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>