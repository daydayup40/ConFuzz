

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vdb &mdash; Visi Debugger  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Visi Debugger  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for vdb</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">cmd</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">getopt</span> <span class="kn">import</span> <span class="n">getopt</span>
<span class="kn">from</span> <span class="nn">UserDict</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">vtrace</span>
<span class="kn">import</span> <span class="nn">vtrace.util</span> <span class="kn">as</span> <span class="nn">v_util</span>
<span class="kn">import</span> <span class="nn">vtrace.snapshot</span> <span class="kn">as</span> <span class="nn">vs_snap</span>
<span class="kn">import</span> <span class="nn">vtrace.notifiers</span> <span class="kn">as</span> <span class="nn">v_notif</span>

<span class="kn">import</span> <span class="nn">vdb</span>
<span class="kn">import</span> <span class="nn">vdb.stalker</span> <span class="kn">as</span> <span class="nn">v_stalker</span>
<span class="kn">import</span> <span class="nn">vdb.extensions</span> <span class="kn">as</span> <span class="nn">v_ext</span>

<span class="kn">import</span> <span class="nn">envi</span>
<span class="kn">import</span> <span class="nn">envi.cli</span> <span class="kn">as</span> <span class="nn">e_cli</span>
<span class="kn">import</span> <span class="nn">envi.bits</span> <span class="kn">as</span> <span class="nn">e_bits</span>
<span class="kn">import</span> <span class="nn">envi.memory</span> <span class="kn">as</span> <span class="nn">e_mem</span>
<span class="kn">import</span> <span class="nn">envi.config</span> <span class="kn">as</span> <span class="nn">e_config</span>
<span class="kn">import</span> <span class="nn">envi.resolver</span> <span class="kn">as</span> <span class="nn">e_resolv</span>
<span class="kn">import</span> <span class="nn">envi.memcanvas</span> <span class="kn">as</span> <span class="nn">e_canvas</span>

<span class="kn">import</span> <span class="nn">vstruct</span>
<span class="kn">import</span> <span class="nn">vstruct.primitives</span> <span class="kn">as</span> <span class="nn">vs_prims</span>

<span class="n">vdb</span><span class="o">.</span><span class="n">basepath</span> <span class="o">=</span> <span class="n">vdb</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>

<div class="viewcode-block" id="VdbLookup"><a class="viewcode-back" href="../vdb.html#vdb.VdbLookup">[docs]</a><span class="k">class</span> <span class="nc">VdbLookup</span><span class="p">(</span><span class="n">UserDict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initdict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">UserDict</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">initdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">UserDict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">UserDict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ScriptThread"><a class="viewcode-back" href="../vdb.html#vdb.ScriptThread">[docs]</a><span class="k">class</span> <span class="nc">ScriptThread</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cobj</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cobj</span> <span class="o">=</span> <span class="n">cobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="nb">locals</span>

<div class="viewcode-block" id="ScriptThread.run"><a class="viewcode-back" href="../vdb.html#vdb.ScriptThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Script Error: &quot;</span><span class="p">,</span><span class="n">e</span>
</div></div>
<div class="viewcode-block" id="VdbTrace"><a class="viewcode-back" href="../vdb.html#vdb.VdbTrace">[docs]</a><span class="k">class</span> <span class="nc">VdbTrace</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to hand thing that need a persistant reference to a trace</span>
<span class="sd">    when using vdb to manage tracers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

<div class="viewcode-block" id="VdbTrace.attach"><a class="viewcode-back" href="../vdb.html#vdb.VdbTrace.attach">[docs]</a>    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="c"># Create a new tracer for the debugger and attach.</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">newTrace</span><span class="p">()</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="c"># Take over all notifier registration</span></div>
<div class="viewcode-block" id="VdbTrace.registerNotifier"><a class="viewcode-back" href="../vdb.html#vdb.VdbTrace.registerNotifier">[docs]</a>    <span class="k">def</span> <span class="nf">registerNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">notif</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">registerNotifier</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">notif</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="VdbTrace.deregisterNotifier"><a class="viewcode-back" href="../vdb.html#vdb.VdbTrace.deregisterNotifier">[docs]</a>    <span class="k">def</span> <span class="nf">deregisterNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">notif</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deregisterNotifier</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">notif</span><span class="p">)</span>

    <span class="c">#FIXME should we add modes to this?</span>
</div>
<div class="viewcode-block" id="VdbTrace.selectThread"><a class="viewcode-back" href="../vdb.html#vdb.VdbTrace.selectThread">[docs]</a>    <span class="k">def</span> <span class="nf">selectThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadid</span><span class="p">):</span>
        <span class="c">#FIXME perhaps a thread selected LOCAL event?</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getTrace</span><span class="p">()</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">selectThread</span><span class="p">(</span><span class="n">threadid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fireLocalNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_BREAK</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getTrace</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
</div>
<span class="n">defconfig</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">[Vdb]</span>

<span class="s">[RegisterView]</span>
<span class="s">i386=eax,ebx,ecx,edx,esi,edi,eip,esp,ebp,eflags,ds,es,cs,fs,gs,ss</span>
<span class="s">x64=rax,rbx,rcx,rdx,rsi,rdi,rip,rsp,rbp,r8,r9,r10,r11,r12,r13,r14,r15</span>

<span class="s">[Aliases]</span>
<span class="s">&lt;f1&gt;=stepi</span>
<span class="s">&lt;f2&gt;=go -I 1</span>
<span class="s">&lt;f5&gt;=go</span>
<span class="s">&quot;&quot;&quot;</span>
        
<div class="viewcode-block" id="Vdb"><a class="viewcode-back" href="../vdb.html#vdb.Vdb">[docs]</a><span class="k">class</span> <span class="nc">Vdb</span><span class="p">(</span><span class="n">e_cli</span><span class="o">.</span><span class="n">EnviMutableCli</span><span class="p">,</span> <span class="n">v_notif</span><span class="o">.</span><span class="n">Notifier</span><span class="p">,</span> <span class="n">v_util</span><span class="o">.</span><span class="n">TraceManager</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A VDB object is a debugger object which may be used to embed full</span>
<span class="sd">    debugger like functionality into a python application.  The</span>
<span class="sd">    Vdb object contains a CLI impelementation which extends envi.cli&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">v_notif</span><span class="o">.</span><span class="n">Notifier</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v_util</span><span class="o">.</span><span class="n">TraceManager</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">getTrace</span><span class="p">()</span>

        <span class="n">arch</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;Architecture&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">envi</span><span class="o">.</span><span class="n">getArchModule</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runagain</span> <span class="o">=</span> <span class="bp">False</span>           <span class="c"># A one-time thing for the cli</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windows_jit_event</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># We hangn on to an opcode renderer instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opcoderend</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># If a VdbGui instance is present it will set this.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&quot;NonBlocking&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manageTrace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerNotifier</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_ALL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c"># FIXME if config verbose</span>
        <span class="c">#self.registerNotifier(vtrace.NOTIFY_ALL, vtrace.VerboseNotifier())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vdbhome</span> <span class="o">=</span> <span class="n">e_config</span><span class="o">.</span><span class="n">gethomedir</span><span class="p">(</span><span class="s">&quot;.vdb&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setupSignalLookups</span><span class="p">()</span>

        <span class="c"># Ok... from here down we&#39;re handing everybody the crazy</span>
        <span class="c"># on-demand-resolved trace object.</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">vdb</span><span class="o">.</span><span class="n">VdbTrace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">e_cli</span><span class="o">.</span><span class="n">EnviMutableCli</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">symobj</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="s">&quot;vdb &gt; &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">banner</span> <span class="o">=</span> <span class="s">&quot;Welcome To VDB!</span><span class="se">\n</span><span class="s">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadDefaultRenderers</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadExtensions</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

<div class="viewcode-block" id="Vdb.loadConfig"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.loadConfig">[docs]</a>    <span class="k">def</span> <span class="nf">loadConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cfgfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdbhome</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdbhome</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdbhome</span><span class="p">)</span>
            <span class="n">cfgfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdbhome</span><span class="p">,</span> <span class="s">&quot;vdb.conf&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">e_config</span><span class="o">.</span><span class="n">EnviConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">cfgfile</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defconfig</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.loadDefaultRenderers"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.loadDefaultRenderers">[docs]</a>    <span class="k">def</span> <span class="nf">loadDefaultRenderers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">envi.memcanvas.renderers</span> <span class="kn">as</span> <span class="nn">e_render</span>
        <span class="kn">import</span> <span class="nn">vdb.renderers</span> <span class="kn">as</span> <span class="nn">v_rend</span>
        <span class="c"># FIXME check endianness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;bytes&quot;</span><span class="p">,</span> <span class="n">e_render</span><span class="o">.</span><span class="n">ByteRend</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;u_int_16&quot;</span><span class="p">,</span> <span class="n">e_render</span><span class="o">.</span><span class="n">ShortRend</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;u_int_32&quot;</span><span class="p">,</span> <span class="n">e_render</span><span class="o">.</span><span class="n">LongRend</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;u_int_64&quot;</span><span class="p">,</span> <span class="n">e_render</span><span class="o">.</span><span class="n">QuadRend</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opcoderend</span> <span class="o">=</span> <span class="n">v_rend</span><span class="o">.</span><span class="n">OpcodeRenderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;disasm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcoderend</span><span class="p">)</span>
        <span class="n">drend</span> <span class="o">=</span> <span class="n">v_rend</span><span class="o">.</span><span class="n">DerefRenderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&quot;Deref View&quot;</span><span class="p">,</span> <span class="n">drend</span><span class="p">)</span>
        <span class="n">srend</span> <span class="o">=</span> <span class="n">v_rend</span><span class="o">.</span><span class="n">SymbolRenderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addRenderer</span><span class="p">(</span><span class="s">&#39;Symbols View&#39;</span><span class="p">,</span> <span class="n">srend</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.verror"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.verror">[docs]</a>    <span class="k">def</span> <span class="nf">verror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">addnl</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">addnl</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.loadExtensions"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.loadExtensions">[docs]</a>    <span class="k">def</span> <span class="nf">loadExtensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load up any extensions which are relevant for the current tracer&#39;s</span>
<span class="sd">        platform/arch/etc...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_ext</span><span class="o">.</span><span class="n">loadExtensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.getTrace"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.getTrace">[docs]</a>    <span class="k">def</span> <span class="nf">getTrace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
</div>
<div class="viewcode-block" id="Vdb.newTrace"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.newTrace">[docs]</a>    <span class="k">def</span> <span class="nf">newTrace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a new trace for this vdb instance.  This fixes many of</span>
<span class="sd">        the new attach/exec data munging issues because tracer re-use is</span>
<span class="sd">        *very* sketchy...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oldtrace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTrace</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">oldtrace</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
            <span class="n">oldtrace</span><span class="o">.</span><span class="n">sendBreak</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">oldtrace</span><span class="o">.</span><span class="n">isAttached</span><span class="p">():</span>
            <span class="n">oldtrace</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">oldtrace</span><span class="o">.</span><span class="n">buildNewTrace</span><span class="p">()</span>
        <span class="n">oldtrace</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manageTrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
</div>
<div class="viewcode-block" id="Vdb.setupSignalLookups"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.setupSignalLookups">[docs]</a>    <span class="k">def</span> <span class="nf">setupSignalLookups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siglookup</span> <span class="o">=</span> <span class="n">VdbLookup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">siglookup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;SIG&quot;</span> <span class="ow">and</span> <span class="s">&quot;_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">siglookup</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Vdb.getSignal"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.getSignal">[docs]</a>    <span class="k">def</span> <span class="nf">getSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If given an int, return the name, for a name, return the int ;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">siglookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.parseExpression"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.parseExpression">[docs]</a>    <span class="k">def</span> <span class="nf">parseExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exprstr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">exprstr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.getExpressionLocals"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.getExpressionLocals">[docs]</a>    <span class="k">def</span> <span class="nf">getExpressionLocals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">VtraceExpressionLocals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">r</span><span class="p">[</span><span class="s">&#39;vprint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span>
        <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="Vdb.reprPointer"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.reprPointer">[docs]</a>    <span class="k">def</span> <span class="nf">reprPointer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing the best known name for</span>
<span class="sd">        the given address</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;NULL&quot;</span>

        <span class="c"># Do we have a symbol?</span>
        <span class="n">sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getSymByAddr</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> + </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span><span class="n">address</span><span class="o">-</span><span class="nb">long</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>

        <span class="c"># Check if it&#39;s a thread&#39;s stack</span>
        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span><span class="n">tinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getThreads</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getRegisterContext</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getStackCounter</span><span class="p">()</span>
            <span class="n">stack</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">perms</span><span class="p">,</span><span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMemoryMap</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">address</span> <span class="o">&gt;=</span> <span class="n">stack</span> <span class="ow">and</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="n">size</span><span class="p">):</span>
                <span class="n">off</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="n">sp</span>
                <span class="n">op</span> <span class="o">=</span> <span class="s">&quot;+&quot;</span>
                <span class="k">if</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span>
                <span class="n">off</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&quot;tid:</span><span class="si">%d</span><span class="s"> sp</span><span class="si">%s%s</span><span class="s"> (stack)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">off</span><span class="p">)</span>

        <span class="nb">map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMemoryMap</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">map</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="s">&quot;Who knows?!?!!?&quot;</span>
</div>
<div class="viewcode-block" id="Vdb.script"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.script">[docs]</a>    <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a vdb script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptstring</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.scriptstring"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.scriptstring">[docs]</a>    <span class="k">def</span> <span class="nf">scriptstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the actual compile and execute for the script data</span>
<span class="sd">        contained in script which was read from filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExpressionLocals</span><span class="p">()</span>
        <span class="n">cobj</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
        <span class="n">sthr</span> <span class="o">=</span> <span class="n">ScriptThread</span><span class="p">(</span><span class="n">cobj</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
        <span class="n">sthr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Vdb.notify"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.notify">[docs]</a>    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getPid</span><span class="p">()</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getCurrentThread</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_ATTACH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Attached to : </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows_jit_event</span><span class="p">:</span>
                <span class="n">trace</span><span class="o">.</span><span class="n">_winJitEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows_jit_event</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windows_jit_event</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_CONTINUE</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_DETACH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Detached from </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_SIGNAL</span><span class="p">:</span>

            <span class="c"># FIXME move all this code into a bolt on notifier!</span>
            <span class="n">thr</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getCurrentThread</span><span class="p">()</span>
            <span class="n">signo</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getCurrentSignal</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Process Recieved Signal </span><span class="si">%d</span><span class="s"> (0x</span><span class="si">%.8x</span><span class="s">) (Thread: </span><span class="si">%d</span><span class="s"> (0x</span><span class="si">%.8x</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signo</span><span class="p">,</span> <span class="n">signo</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">thr</span><span class="p">))</span>

            <span class="n">faddr</span><span class="p">,</span><span class="n">fperm</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMemoryFault</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">faddr</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">accstr</span> <span class="o">=</span> <span class="n">e_mem</span><span class="o">.</span><span class="n">getPermName</span><span class="p">(</span><span class="n">fperm</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Memory Fault: addr: 0x</span><span class="si">%.8x</span><span class="s"> perm: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">faddr</span><span class="p">,</span> <span class="n">accstr</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_BREAK</span><span class="p">:</span>

            <span class="n">trace</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;PendingBreak&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getCurrentBreakpoint</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Thread: </span><span class="si">%d</span><span class="s"> Hit Break: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
                <span class="n">cmdstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmdstr</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">onecmd</span><span class="p">(</span><span class="n">cmdstr</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Thread: </span><span class="si">%d</span><span class="s"> NOTIFY_BREAK&quot;</span> <span class="o">%</span> <span class="n">tid</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runagain</span><span class="p">:</span> <span class="c"># One-time run-again behavior (for cli option)</span>
                    <span class="n">trace</span><span class="o">.</span><span class="n">runAgain</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runagain</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_EXIT</span><span class="p">:</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;ExitCode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;PID </span><span class="si">%d</span><span class="s"> exited: </span><span class="si">%d</span><span class="s"> (0x</span><span class="si">%.8x</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">ecode</span><span class="p">,</span><span class="n">ecode</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_LOAD_LIBRARY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Loading Binary: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;LatestLibrary&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">normname</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;LatestLibraryNorm&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">==</span> <span class="n">normname</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">trace</span><span class="o">.</span><span class="n">runAgain</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_UNLOAD_LIBRARY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Unloading Binary: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;LatestLibrary&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_CREATE_THREAD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;New Thread: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tid</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_EXIT_THREAD</span><span class="p">:</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;ExitCode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Exit Thread: </span><span class="si">%d</span><span class="s"> (ecode: 0x</span><span class="si">%.8x</span><span class="s"> (</span><span class="si">%d</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="n">ecode</span><span class="p">,</span><span class="n">ecode</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_DEBUG_PRINT</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span>
            <span class="n">win32</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;Win32Event&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">win32</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">win32</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;DebugString&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;DEBUG PRINT: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

    <span class="c">###################################################################</span>
    <span class="c">#</span>
    <span class="c"># All CLI extension commands start here</span>
    <span class="c">#</span>
</div>
<div class="viewcode-block" id="Vdb.do_vstruct"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_vstruct">[docs]</a>    <span class="k">def</span> <span class="nf">do_vstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the available structure modules and optionally</span>
<span class="sd">        structure definitions from a particular module in the</span>
<span class="sd">        current vstruct.</span>

<span class="sd">        Usage: vstruct [modname]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">VStruct Namespaces:&quot;</span><span class="p">)</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getStructNames</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Known Structures (from </span><span class="si">%s</span><span class="s">):&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getStructNames</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_dis"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_dis">[docs]</a>    <span class="k">def</span> <span class="nf">do_dis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print out the opcodes for a given address expression</span>

<span class="sd">        Usage: dis &lt;address expression&gt; [&lt;size expression&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">argc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getProgramCounter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Dissassembly:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">renderMemory</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opcoderend</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_var"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_var">[docs]</a>    <span class="k">def</span> <span class="nf">do_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a variable in the expression parsing context.  This allows</span>
<span class="sd">        for scratchspace names (python compatable names) to be used in</span>
<span class="sd">        expressions.</span>

<span class="sd">        Usage: var &lt;name&gt; &lt;addr_expression&gt;</span>

<span class="sd">        NOTE: The address expression *must* resolve at the time you set it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;var&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>

        <span class="nb">vars</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getVariables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Current Variables:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;None.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">vnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%20s</span><span class="s"> = 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rstr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                        <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;...&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%20s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">rstr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_alloc"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_alloc">[docs]</a>    <span class="k">def</span> <span class="nf">do_alloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c">#&quot;&quot;&quot;</span>
        <span class="c">#Allocate a chunk of memory in the target process.  You may</span>
        <span class="c">#optionally specify permissions and a suggested base address.</span>

        <span class="c">#Usage: alloc [-p rwx] [-s &lt;base&gt;] &lt;size&gt;</span>
        <span class="c">#&quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate a chunk of memory in the target process.  It will be</span>
<span class="sd">        allocated with rwx permissions.</span>

<span class="sd">        Usage: alloc &lt;size expr&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;alloc&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="c">#argv = e_cli.splitargs(args)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">allocateMemory</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Allocated </span><span class="si">%d</span><span class="s"> bytes at: 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">base</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Allocation Error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_memload"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_memload">[docs]</a>    <span class="k">def</span> <span class="nf">do_memload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a file into memory. (straight mapping, no parsing)</span>

<span class="sd">        Usage: memload &lt;filename&gt;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;memload&#39;</span><span class="p">)</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Invalid File: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">fbytes</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">memva</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">allocateMemory</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fbytes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">writeMemory</span><span class="p">(</span><span class="n">memva</span><span class="p">,</span> <span class="n">fbytes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Loaded At: 0x</span><span class="si">%.8x</span><span class="s"> (</span><span class="si">%d</span><span class="s"> bytes)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">memva</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fbytes</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Vdb.do_struct"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_struct">[docs]</a>    <span class="k">def</span> <span class="nf">do_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Break out a strcuture from memory.  You may use the command</span>
<span class="sd">        &quot;vstruct&quot; to show the known structures in vstruct.</span>

<span class="sd">        Usage: struct &lt;StructName&gt; &lt;vtrace expression&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clsname</span><span class="p">,</span> <span class="n">vexpr</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;struct&quot;</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>

        <span class="n">addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">vexpr</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getStruct</span><span class="p">(</span><span class="n">clsname</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">tree</span><span class="p">(</span><span class="n">va</span><span class="o">=</span><span class="n">addr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_signal"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_signal">[docs]</a>    <span class="k">def</span> <span class="nf">do_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the current pending signal/exception code.</span>

<span class="sd">        Usage: signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># FIXME -i do NOT pass the signal on to the target process.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">t</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="n">cursig</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getCurrentSignal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cursig</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;No Pending Signals/Exceptions!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Current signal: </span><span class="si">%d</span><span class="s"> (0x</span><span class="si">%.8x</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cursig</span><span class="p">,</span> <span class="n">cursig</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_snapshot"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">do_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a process snapshot of the current (stopped) trace and</span>
<span class="sd">        save it to the specified file.</span>

<span class="sd">        Usage: snapshot &lt;filename&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;snapshot&quot;</span><span class="p">)</span>
        <span class="n">alist</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alist</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;snapshot&quot;</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">t</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Taking Snapshot...&quot;</span><span class="p">)</span>
        <span class="n">snap</span> <span class="o">=</span> <span class="n">vs_snap</span><span class="o">.</span><span class="n">takeSnapshot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Saving To File&quot;</span><span class="p">)</span>
        <span class="n">snap</span><span class="o">.</span><span class="n">saveToFile</span><span class="p">(</span><span class="n">alist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">)</span>
        <span class="n">snap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Vdb.do_ignore"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_ignore">[docs]</a>    <span class="k">def</span> <span class="nf">do_ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the specified signal id (exception id for windows) to the ignored</span>
<span class="sd">        signals list for the current trace.  This will make the smallest possible</span>
<span class="sd">        performance impact for that particular signal but will also not alert</span>
<span class="sd">        you that it has occured.</span>

<span class="sd">        Usage: ignore [options] [-c | &lt;sigcode&gt;...]</span>
<span class="sd">        -d - Remove the specified signal codes.</span>
<span class="sd">        -c - Include the *current* signal in the sigcode list</span>
<span class="sd">        -C - Clear the list of ignored signals</span>

<span class="sd">        Example: ignore -c # Ignore the currently posted signal</span>
<span class="sd">                 ignore -d 0x80000001 # Remove 0x80000001 from the ignores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&#39;Ccd&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="n">remove</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sigs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-c&#39;</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getCurrentSignal</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;No current signal to ignore!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-C&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Clearing ignore list...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;IgnoredSignals&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-d&#39;</span><span class="p">:</span>
                <span class="n">remove</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">sigs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Removing: 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sig</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">delIgnoreSignal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Adding: 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sig</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">addIgnoreSignal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

        <span class="n">ilist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;IgnoredSignals&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Currently Ignored Signals/Exceptions:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ilist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_exec"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_exec">[docs]</a>    <span class="k">def</span> <span class="nf">do_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a program with the given command line and</span>
<span class="sd">        attach to it.</span>
<span class="sd">        Usage: exec &lt;/some/where and some args&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newTrace</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_threads"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_threads">[docs]</a>    <span class="k">def</span> <span class="nf">do_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the current threads in the target process or select</span>
<span class="sd">        the current thread context for the target tracer.</span>
<span class="sd">        Usage: threads [thread id]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireNotRunning</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Can&#39;t list threads while running!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thrid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">selectThread</span><span class="p">(</span><span class="n">thrid</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">setTraceWindowsActive</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Current Threads:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;[thrid] [thrinfo]  [pc]&quot;</span><span class="p">)</span>

        <span class="n">curtid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;ThreadId&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span><span class="n">tinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getThreads</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s">&quot; &quot;</span>
            <span class="k">if</span> <span class="n">tid</span> <span class="o">==</span> <span class="n">curtid</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>

            <span class="n">sus</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">isThreadSuspended</span><span class="p">(</span><span class="n">tid</span><span class="p">):</span>
                <span class="n">sus</span> <span class="o">=</span> <span class="s">&quot;(suspended)&quot;</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getRegisterContext</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getProgramCounter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%6d</span><span class="s"> 0x</span><span class="si">%.8x</span><span class="s"> 0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">sus</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_suspend"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_suspend">[docs]</a>    <span class="k">def</span> <span class="nf">do_suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Suspend a thread.</span>

<span class="sd">        Usage: suspend &lt;-A | &lt;tid&gt;[ &lt;tid&gt;...]&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;suspend&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-A&quot;</span><span class="p">:</span>
                <span class="c"># hehe...</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getThreads</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;suspend&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">suspendThread</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Suspended Thread: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_restart"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_restart">[docs]</a>    <span class="k">def</span> <span class="nf">do_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Restart the current process.</span>

<span class="sd">        Usage: restart</span>

<span class="sd">        NOTE: This only works if the process was exec&#39;d to begin</span>
<span class="sd">        with!</span>

<span class="sd">        TODO: Plumb options for persisting bp&#39;s etc...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;ExecCommand&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmdline</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;This trace was not fired with exec! (cannot restart)&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&quot;RunForever&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">sendBreak</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isAttached</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newTrace</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_resume"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_resume">[docs]</a>    <span class="k">def</span> <span class="nf">do_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resume a thread.</span>

<span class="sd">        Usage: resume &lt;-A | &lt;tid&gt;[ &lt;tid&gt;...]&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;suspend&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-A&quot;</span><span class="p">:</span>
                <span class="c"># hehe...</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getThreads</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">resumeThread</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Resumed Thread: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tid</span><span class="p">)</span>

    <span class="c">#def do_inject(self, line):</span>
</div>
<div class="viewcode-block" id="Vdb.do_mode"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_mode">[docs]</a>    <span class="k">def</span> <span class="nf">do_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set modes in the tracers...</span>
<span class="sd">        mode Foo=True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
            <span class="n">newmode</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">newmode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_reg"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_reg">[docs]</a>    <span class="k">def</span> <span class="nf">do_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the current register values.  Additionally, you may specify</span>
<span class="sd">        name=&lt;expression&gt; to set a register</span>

<span class="sd">        Usage: reg [regname=vtrace_expression]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;reg&quot;</span><span class="p">)</span>
            <span class="n">regname</span><span class="p">,</span><span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setRegisterByName</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">regs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getRegisters</span><span class="p">()</span>
        <span class="n">rnames</span> <span class="o">=</span> <span class="n">regs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">rnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rnames</span><span class="p">:</span>
            <span class="c"># Capitol names are used for reg vals that we don&#39;t want to see</span>
            <span class="c"># (by default)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">vstr</span> <span class="o">=</span> <span class="n">e_bits</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;</span><span class="si">%12s</span><span class="s">:0x</span><span class="si">%.8x</span><span class="s"> (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">val</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columnize</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_stepi"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_stepi">[docs]</a>    <span class="k">def</span> <span class="nf">do_stepi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Single step the target tracer.</span>
<span class="sd">        Usage: stepi [ options ]</span>

<span class="sd">        -A &lt;addr&gt;  - Step to &lt;addr&gt;</span>
<span class="sd">        -B         - Step past the next branch instruction</span>
<span class="sd">        -C &lt;count&gt; - Step &lt;count&gt; instructions</span>
<span class="sd">        -R         - Step to return from this function</span>
<span class="sd">        -V         - Show operand values during single step (verbose!)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;A:BC:RV&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;stepi&quot;</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">taddr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">toret</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">tobrn</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">showop</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-A&#39;</span><span class="p">:</span>
                <span class="n">taddr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-B&#39;</span><span class="p">:</span>
                <span class="n">tobrn</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-C&#39;</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-R&#39;</span><span class="p">:</span>
                <span class="n">toret</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-V&#39;</span><span class="p">:</span>
                <span class="n">showop</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">count</span> <span class="o">==</span> <span class="bp">None</span> 
             <span class="ow">and</span> <span class="n">taddr</span> <span class="o">==</span> <span class="bp">None</span>
             <span class="ow">and</span> <span class="n">toret</span> <span class="o">==</span> <span class="bp">False</span> 
             <span class="ow">and</span> <span class="n">tobrn</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">oldmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMode</span><span class="p">(</span><span class="s">&#39;FastStep&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&#39;FastStep&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

                <span class="n">pc</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getProgramCounter</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">pc</span> <span class="o">==</span> <span class="n">taddr</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">op</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parseOpcode</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>

                <span class="n">sym</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getSymByAddr</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sym</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="n">pc</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39;:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39;  &#39;</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addVaText</span><span class="p">(</span><span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39;:  &#39;</span><span class="p">)</span>
                <span class="n">op</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">showop</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39; ; &#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">oper</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">opers</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">oper</span><span class="o">.</span><span class="n">getOperValue</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">emu</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">addText</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_CALL</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_RET</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="n">tid</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getCurrentThread</span><span class="p">()</span>

                <span class="n">t</span><span class="o">.</span><span class="n">stepi</span><span class="p">()</span>

                <span class="c"># If we get an event from a different thread, get out!</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">getCurrentThread</span><span class="p">()</span> <span class="o">!=</span> <span class="n">tid</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c"># Break out if we have returned from the current function</span>
                <span class="k">if</span> <span class="n">toret</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c"># If we have passed a conditional branch...</span>
                <span class="k">if</span> <span class="n">tobrn</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">hits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_CALL</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">IF_RET</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="n">getout</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">bva</span><span class="p">,</span> <span class="n">bflags</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">getBranches</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">bflags</span> <span class="o">&amp;</span> <span class="n">envi</span><span class="o">.</span><span class="n">BR_COND</span><span class="p">:</span>
                            <span class="n">getout</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">getout</span><span class="p">:</span>
                        <span class="k">break</span>


                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">hits</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">getCurrentSignal</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;PendingSignal&#39;</span><span class="p">):</span>
                    <span class="k">break</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&#39;FastStep&#39;</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">)</span>
            <span class="c"># We ate all the events, tell things we have updated...</span>
            <span class="n">t</span><span class="o">.</span><span class="n">fireNotifiers</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_STEP</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_go"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_go">[docs]</a>    <span class="k">def</span> <span class="nf">do_go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continue the target tracer.</span>
<span class="sd">        -I go icount linear instructions forward (step over style)</span>
<span class="sd">        -U go *out* of fcount frames (step out style)</span>
<span class="sd">        &lt;until addr&gt; go until explicit address</span>

<span class="sd">        Usage: go [-U &lt;fcount&gt; | -I &lt;icount&gt; | &lt;until addr expression&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">until</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">icount</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">fcount</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;U:I:&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;go&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-U&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;go&quot;</span><span class="p">)</span>
                <span class="n">fcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-I&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;go&quot;</span><span class="p">)</span>
                <span class="n">icount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">icount</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getProgramCounter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">icount</span><span class="p">):</span>
                <span class="n">addr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">makeOpcode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span>
            <span class="n">until</span> <span class="o">=</span> <span class="n">addr</span>

        <span class="k">elif</span> <span class="n">fcount</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">until</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getStackTrace</span><span class="p">()[</span><span class="n">fcount</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">until</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">until</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Running Tracer (use &#39;break&#39; to stop it)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_gui"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_gui">[docs]</a>    <span class="k">def</span> <span class="nf">do_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Attempt to spawn the VDB gui.  Assuming GTK etc are all installed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Gui already running!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="kn">import</span> <span class="nn">vdb.gui</span>
        <span class="n">vdb</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_waitlib"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_waitlib">[docs]</a>    <span class="k">def</span> <span class="nf">do_waitlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run the target process until the specified library</span>
<span class="sd">        (by normalized name such as &#39;kernel32&#39; or &#39;libc&#39;)</span>
<span class="sd">        is loaded.  Disable waiting with -D.</span>

<span class="sd">        Usage: waitlib [ -D | &lt;libname&gt; ]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getPid</span><span class="p">()</span>

        <span class="n">t</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;waitlib&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-D&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Disabling Wait On: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;waitlib&#39;</span><span class="p">)</span>

        <span class="n">libname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;LibraryBases&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">libname</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Library Already Loaded: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Setting Waitlib: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waitlib</span> <span class="o">=</span> <span class="n">libname</span>
</div>
<div class="viewcode-block" id="Vdb.do_server"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_server">[docs]</a>    <span class="k">def</span> <span class="nf">do_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a vtrace server on the local box.  If the server</span>
<span class="sd">        is already running, show which processes are being remotely</span>
<span class="sd">        debugged.</span>

<span class="sd">        Usage: server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
            <span class="n">vtrace</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Starting vtrace server!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">startVtraceServer</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Displaying remotely debugged traces:&#39;</span><span class="p">)</span>
        <span class="n">shared</span> <span class="o">=</span> <span class="p">[</span> <span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">getSharedObjects</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">Trace</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;None.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">shared</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isAttached</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">runmsg</span> <span class="o">=</span> <span class="s">&#39;stopped&#39;</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="n">runmsg</span> <span class="o">=</span> <span class="s">&#39;running&#39;</span>

            <span class="n">pid</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getPid</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;ExeName&#39;</span><span class="p">,</span> <span class="s">&#39;Unknown&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6d</span><span class="s"> </span><span class="si">%.8s</span><span class="s"> - </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">runmsg</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_syms"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_syms">[docs]</a>    <span class="k">def</span> <span class="nf">do_syms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List symbols and by file.</span>

<span class="sd">        Usage: syms [-s &lt;pattern&gt;] [filename]</span>

<span class="sd">        With no arguments, syms will self.vprint(the possible</span>
<span class="sd">        libraries with symbol resolvers.  Specify a library</span>
<span class="sd">        to see all the symbols for it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;s:&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;syms&quot;</span><span class="p">)</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-s&quot;</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">libs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getNormalizedLibNames</span><span class="p">()</span>
        <span class="n">libs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Current Library Symbol Resolvers:&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">libname</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">libname</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getSymsForFile</span><span class="p">(</span><span class="n">libname</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">libname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">libname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Unknown libname: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Matching Symbols From </span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Symbols From </span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">libname</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getSymsForFile</span><span class="p">(</span><span class="n">libname</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_call"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_call">[docs]</a>    <span class="k">def</span> <span class="nf">do_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows a C-like syntax for calling functions inside</span>
<span class="sd">        the target process (from his context).</span>
<span class="sd">        Example: call printf(&quot;yermom %d&quot;, 10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR - call wants c-style syntax: ie call printf(&quot;yermom&quot;)&#39;</span><span class="p">)</span>
        <span class="n">funcaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">ind</span><span class="p">:])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR - call wants c-style syntax: ie call printf(&quot;yermom&quot;)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;calling </span><span class="si">%s</span><span class="s"> -&gt; 0x</span><span class="si">%.8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">ind</span><span class="p">],</span> <span class="n">funcaddr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">funcaddr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_bestname"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_bestname">[docs]</a>    <span class="k">def</span> <span class="nf">do_bestname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the &quot;best name&quot; string for an address.</span>

<span class="sd">        Usage: bestname &lt;vtrace expression&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;bestname&quot;</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reprPointer</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_EOF"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_EOF">[docs]</a>    <span class="k">def</span> <span class="nf">do_EOF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;No.. this is NOT a python interpreter... use quit ;)&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_quit"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_quit">[docs]</a>    <span class="k">def</span> <span class="nf">do_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quit VDB</span>

<span class="sd">        use &quot;quit force&quot; to hard-force a quit regardless of everything.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="s">&#39;force&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Quitting by force!&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&quot;RunForever&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">sendBreak</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">isAttached</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Detaching...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Exiting...&quot;</span><span class="p">)</span>
            <span class="n">e_cli</span><span class="o">.</span><span class="n">EnviMutableCli</span><span class="o">.</span><span class="n">do_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Exception during quit (may need: quite force): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_detach"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_detach">[docs]</a>    <span class="k">def</span> <span class="nf">do_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detach from the current tracer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&quot;RunForever&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">sendBreak</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Vdb.do_attach"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_attach">[docs]</a>    <span class="k">def</span> <span class="nf">do_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach to a process by PID or by process name.  In</span>
<span class="sd">        the event of more than one process by a given name,</span>
<span class="sd">        attach to the last (most recently created) one in</span>
<span class="sd">        the list.</span>

<span class="sd">        Usage: attach [&lt;pid&gt;,&lt;name&gt;]</span>

<span class="sd">        NOTE: This is *not* a regular expression.  The given</span>
<span class="sd">        string must be found as a substring of the process</span>
<span class="sd">        name...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">mypid</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">ps</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">mypid</span>

        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;attach&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Attaching to </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newTrace</span><span class="p">()</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_autocont"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_autocont">[docs]</a>    <span class="k">def</span> <span class="nf">do_autocont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manipulate the auto-continue behavior for the trace.  This</span>
<span class="sd">        will cause particular event types to automagically continue</span>
<span class="sd">        execution.</span>

<span class="sd">        Usage: autocont [event name]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">acnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;attach&quot;</span><span class="p">,</span>
                   <span class="s">&quot;signal&quot;</span><span class="p">,</span>
                   <span class="s">&quot;break&quot;</span><span class="p">,</span>
                   <span class="s">&quot;loadlib&quot;</span><span class="p">,</span>
                   <span class="s">&quot;unloadlib&quot;</span><span class="p">,</span>
                   <span class="s">&quot;createthread&quot;</span><span class="p">,</span>
                   <span class="s">&quot;exitthread&quot;</span><span class="p">,</span>
                   <span class="s">&quot;dbgprint&quot;</span><span class="p">]</span>

        <span class="n">acvals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_ATTACH</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_SIGNAL</span><span class="p">,</span> 
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_BREAK</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_LOAD_LIBRARY</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_UNLOAD_LIBRARY</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_CREATE_THREAD</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_EXIT_THREAD</span><span class="p">,</span>
                   <span class="n">vtrace</span><span class="o">.</span><span class="n">NOTIFY_DEBUG_PRINT</span><span class="p">]</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getAutoContinueList</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">acnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Unknown event name: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">acvals</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">disableAutoContinue</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">enableAutoContinue</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Auto Continue Status:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acnames</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">acnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">acvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">acont</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">acont</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">acont</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Vdb.emptyline"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.emptyline">[docs]</a>    <span class="k">def</span> <span class="nf">emptyline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_bt"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_bt">[docs]</a>    <span class="k">def</span> <span class="nf">do_bt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show a stack backtrace for the currently selected thread.</span>

<span class="sd">        Usage: bt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;      [   PC   ] [ Frame  ] [ Location ]&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pc</span><span class="p">,</span><span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getStackTrace</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%3d</span><span class="s">] 0x</span><span class="si">%.8x</span><span class="s"> 0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">pc</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reprPointer</span><span class="p">(</span><span class="n">pc</span><span class="p">)))</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Vdb.do_lm"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_lm">[docs]</a>    <span class="k">def</span> <span class="nf">do_lm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the loaded libraries and their base addresses.</span>

<span class="sd">        Usage: lm [libname]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;LibraryBases&quot;</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&quot;LibraryPaths&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">bases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Library </span><span class="si">%s</span><span class="s"> is not found!&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> - </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Loaded Libraries:&quot;</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getNormalizedLibNames</span><span class="p">()</span>
            <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">columnstr</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">libname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">bases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">libname</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> - </span><span class="si">%.30s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">libname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_guid"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_guid">[docs]</a>    <span class="k">def</span> <span class="nf">do_guid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse and display a Global Unique Identifier (GUID) from memory</span>
<span class="sd">        (eventually, use GUID db to lookup the name/meaning of the GUID).</span>

<span class="sd">        Usage: guid &lt;addr_exp&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireNotRunning</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;guid&quot;</span><span class="p">)</span>

        <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">guid</span> <span class="o">=</span> <span class="n">vs_prims</span><span class="o">.</span><span class="n">GUID</span><span class="p">()</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">guid</span><span class="p">))</span>
        <span class="n">guid</span><span class="o">.</span><span class="n">vsSetValue</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;GUID 0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">guid</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Vdb.do_bpfile"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_bpfile">[docs]</a>    <span class="k">def</span> <span class="nf">do_bpfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the python code for a breakpoint from the contents</span>
<span class="sd">        of a file.</span>

<span class="sd">        Usage: bpfile &lt;bpid&gt; &lt;filename&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;bpfile&quot;</span><span class="p">)</span>

        <span class="n">bpid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pycode</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;rU&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setBreakpointCode</span><span class="p">(</span><span class="n">bpid</span><span class="p">,</span> <span class="n">pycode</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_bpedit"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_bpedit">[docs]</a>    <span class="k">def</span> <span class="nf">do_bpedit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manipulcate the python code that will be run for a given</span>
<span class="sd">        breakpoint by ID.  (Also the way to view the code).</span>

<span class="sd">        Usage: bpedit &lt;id&gt; [&quot;optionally new code&quot;]</span>

<span class="sd">        NOTE: Your code must be surrounded by &quot;s and may not</span>
<span class="sd">        contain any &quot;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&quot;bpedit&quot;</span><span class="p">)</span>
        <span class="n">bpid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setBreakpointCode</span><span class="p">(</span><span class="n">bpid</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">pystr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getBreakpointCode</span><span class="p">(</span><span class="n">bpid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%d</span><span class="s">] Breakpoint code: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bpid</span><span class="p">,</span><span class="n">pystr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_bp"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_bp">[docs]</a>    <span class="k">def</span> <span class="nf">do_bp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show, add,  and enable/disable breakpoints</span>
<span class="sd">        USAGE: bp [-d &lt;addr&gt;] [-a &lt;addr&gt;] [-o &lt;addr&gt;] [[-c pycode] &lt;address&gt; [vdb cmds]]</span>
<span class="sd">        -C - Clear All Breakpoints</span>
<span class="sd">        -c &quot;py code&quot; - Set the breakpoint code to the given python string</span>
<span class="sd">        -d &lt;id&gt; - Disable Breakpoint</span>
<span class="sd">        -e &lt;id&gt; - Enable Breakpoint</span>
<span class="sd">        -r &lt;id&gt; - Remove Breakpoint</span>
<span class="sd">        -o &lt;addr&gt; - Create a OneTimeBreak</span>
<span class="sd">        -L &lt;libname&gt; - Add bp&#39;s to all functions in &lt;libname&gt;</span>
<span class="sd">        -F &lt;filename&gt; - Load bpcode from file</span>
<span class="sd">        -W perms:size - Set a hardware Watchpoint with perms/size (ie -W rw:4)</span>
<span class="sd">        -f - Make added breakpoints from this command into &quot;fastbreaks&quot;</span>
<span class="sd">        -S &lt;libname&gt;:&lt;regex&gt; - Add bp&#39;s to all matching funcs in &lt;libname&gt;</span>

<span class="sd">        &lt;address&gt;... - Create Breakpoint</span>

<span class="sd">        [vdb cmds].. - (optional) vdb cli comand to run on BP hit (seperate</span>
<span class="sd">                       multiple commands with ;; )</span>

<span class="sd">        NOTE: -c adds python code to the breakpoint.  The python code will</span>
<span class="sd">            be run with the following objects mapped into it&#39;s namespace</span>
<span class="sd">            automagically:</span>
<span class="sd">                vtrace  - the vtrace package</span>
<span class="sd">                trace   - the tracer</span>
<span class="sd">                bp      - the breakpoint object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireNotRunning</span><span class="p">()</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;fF:e:d:o:r:L:Cc:S:W:&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;bp&#39;</span><span class="p">)</span>

        <span class="n">pycode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">wpargs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">fastbreak</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">libsearch</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-e&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setBreakpointEnabled</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">optarg</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-c&quot;</span><span class="p">:</span>
                <span class="n">pycode</span> <span class="o">=</span> <span class="n">optarg</span>
                <span class="n">test</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">pycode</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span><span class="s">&quot;exec&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-F&quot;</span><span class="p">:</span>
                <span class="n">pycode</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;rU&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-f&#39;</span><span class="p">:</span>
                <span class="n">fastbreak</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-r&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">optarg</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">removeBreakpoint</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">optarg</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-C&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getBreakpoints</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">removeBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-d&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setBreakpointEnabled</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">optarg</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-o&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="n">vtrace</span><span class="o">.</span><span class="n">OneTimeBreak</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">optarg</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-L&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getSymsForFile</span><span class="p">(</span><span class="n">optarg</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">e_resolv</span><span class="o">.</span><span class="n">FunctionSymbol</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bp</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">Breakpoint</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
                        <span class="n">bp</span><span class="o">.</span><span class="n">setBreakpointCode</span><span class="p">(</span><span class="n">pycode</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Added: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;WARNING: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-W&quot;</span><span class="p">:</span>
                <span class="n">wpargs</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-S&#39;</span><span class="p">:</span>
                <span class="n">libname</span><span class="p">,</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">searchSymbols</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">libname</span><span class="o">=</span><span class="n">libname</span><span class="p">):</span>

                        <span class="n">symstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                        <span class="n">symval</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getBreakpointByAddr</span><span class="p">(</span><span class="n">symval</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Duplicate (0x</span><span class="si">%.8x</span><span class="s">) </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symval</span><span class="p">,</span> <span class="n">symstr</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="n">bp</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">Breakpoint</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">symstr</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Added: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">symstr</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Invalid Regular Expression: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">regex</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="n">cmdstr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmdstr</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">wpargs</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wpargs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bp</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">Watchpoint</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="o">=</span><span class="n">wpargs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bp</span> <span class="o">=</span> <span class="n">vtrace</span><span class="o">.</span><span class="n">Breakpoint</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">arg</span><span class="p">)</span>

            <span class="n">bp</span><span class="o">.</span><span class="n">setBreakpointCode</span><span class="p">(</span><span class="n">pycode</span><span class="p">)</span>
            <span class="n">bp</span><span class="o">.</span><span class="n">fastbreak</span> <span class="o">=</span> <span class="n">fastbreak</span>
            <span class="n">bpid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmdstr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span><span class="p">[</span><span class="n">bpid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;;;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;&amp;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot; [ Breakpoints ]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getBreakpoints</span><span class="p">():</span>
            <span class="n">cmdstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpcmds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> enabled: </span><span class="si">%s</span><span class="s"> fast: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">(),</span> <span class="n">bp</span><span class="o">.</span><span class="n">fastbreak</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_fds"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_fds">[docs]</a>    <span class="k">def</span> <span class="nf">do_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show all the open Handles/FileDescriptors for the target process.</span>
<span class="sd">        The &quot;typecode&quot; shown in []&#39;s is the vtrace typecode for that kind of</span>
<span class="sd">        fd/handle.</span>

<span class="sd">        Usage: fds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireAttached</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">fdtype</span><span class="p">,</span><span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getFds</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;0x</span><span class="si">%.8x</span><span class="s"> [</span><span class="si">%d</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">fdtype</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.do_ps"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_ps">[docs]</a>    <span class="k">def</span> <span class="nf">do_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the current process list.</span>

<span class="sd">        Usage: ps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;[Pid]</span><span class="se">\t</span><span class="s">[ Name ]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">ps</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="Vdb.do_break"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_break">[docs]</a>    <span class="k">def</span> <span class="nf">do_break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send the break signal to the target tracer to stop</span>
<span class="sd">        it&#39;s execution.</span>

<span class="sd">        Usage: break</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;PendingBreak&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Break already sent...&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;PendingBreak&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s">&quot;RunForever&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">sendBreak</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Vdb.do_meta"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_meta">[docs]</a>    <span class="k">def</span> <span class="nf">do_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the metadata for the current trace.</span>

<span class="sd">        Usage: meta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">argv</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">:</span>
                <span class="n">mval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_memdiff"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_memdiff">[docs]</a>    <span class="k">def</span> <span class="nf">do_memdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save and compare snapshots of memory to enumerate changes.</span>

<span class="sd">        Usage: memdiff [options]</span>
<span class="sd">        -C             Clear all current memory diff snapshots.</span>
<span class="sd">        -A &lt;va:size&gt;   Add the given virtual address to the list.</span>
<span class="sd">        -M &lt;va&gt;        Add the entire memory map which contains VA to the list.</span>
<span class="sd">        -D             Compare currently tracked memory with the target process</span>
<span class="sd">                       and show any differences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;A:CDM:&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;memdiff&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">requireNotRunning</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&quot;-A&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">optarg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;memdiff&#39;</span><span class="p">)</span>

                <span class="n">vastr</span><span class="p">,</span><span class="n">sizestr</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">va</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">vastr</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">sizestr</span><span class="p">)</span>
                <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span><span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-C&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-D&#39;</span><span class="p">:</span>
                <span class="n">difs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDiffs</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">difs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;No Differences!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">va</span><span class="p">,</span><span class="n">thenbytes</span><span class="p">,</span><span class="n">nowbytes</span> <span class="ow">in</span> <span class="n">difs</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                    <span class="p">(</span><span class="n">va</span><span class="p">,</span>
                                     <span class="n">thenbytes</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">),</span>
                                     <span class="n">nowbytes</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-M&#39;</span><span class="p">:</span>
                <span class="n">va</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>
                <span class="nb">map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMemoryMap</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">map</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;No Memory Map At: 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">va</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">mva</span><span class="p">,</span><span class="n">msize</span><span class="p">,</span><span class="n">mperm</span><span class="p">,</span><span class="n">mfile</span> <span class="o">=</span> <span class="nb">map</span>
                <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">mva</span><span class="p">,</span> <span class="n">msize</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span><span class="p">[</span><span class="n">mva</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span>

</div>
    <span class="k">def</span> <span class="nf">_getDiffs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">va</span><span class="p">,</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">difftracks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nowbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">readMemory</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">))</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
                <span class="n">thendiff</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">nowdiff</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">iva</span> <span class="o">=</span> <span class="n">va</span><span class="o">+</span><span class="n">i</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="nb">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nowbytes</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">thendiff</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">nowdiff</span> <span class="o">+=</span> <span class="n">nowbytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">thendiff</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iva</span><span class="p">,</span> <span class="n">thendiff</span><span class="p">,</span> <span class="n">nowdiff</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="Vdb.do_dope"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_dope">[docs]</a>    <span class="k">def</span> <span class="nf">do_dope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Cli interface to the &quot;stack doping&quot; api inside recon.  *BETA*</span>

<span class="sd">        (Basically, set all un-initialized stack memory to V&#39;s to tease</span>
<span class="sd">        out uninitialized stack bugs)</span>

<span class="sd">        Usage: dope [ options ]</span>
<span class="sd">        -E  Enable automagic thread stack doping on all continue events</span>
<span class="sd">        -D  Disable automagic thread stack doping on all continue events</span>
<span class="sd">        -A  Dope all current thread stacks</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">vdb.recon.dopestack</span> <span class="kn">as</span> <span class="nn">vr_dopestack</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;dope&#39;</span><span class="p">)</span>

        <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&#39;ADE&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;dope&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-A&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Doping all thread stacks...&#39;</span><span class="p">)</span>
                <span class="n">vr_dopestack</span><span class="o">.</span><span class="n">dopeAllThreadStacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;...complete!&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-D&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Disabling thread doping...&#39;</span><span class="p">)</span>
                <span class="n">vr_dopestack</span><span class="o">.</span><span class="n">disableEventDoping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;...complete!&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-E&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Enabling thread doping on CONTINUE events...&#39;</span><span class="p">)</span>
                <span class="n">vr_dopestack</span><span class="o">.</span><span class="n">enableEventDoping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;...complete!&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Vdb.do_recon"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_recon">[docs]</a>    <span class="k">def</span> <span class="nf">do_recon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Cli front end to the vdb recon subsystem which allows runtime</span>
<span class="sd">        analysis of known API calls.</span>

<span class="sd">        Usage: recon [options]</span>
<span class="sd">        -A &lt;sym_expr&gt;:&lt;recon_fmt&gt; - Add a recon breakpoint with the given format</span>
<span class="sd">        -C - Clear the current list of recon breakpoint hits.</span>
<span class="sd">        -H - Print the current list of recon breakpoint hits.</span>
<span class="sd">        -Q - Toggle &quot;quiet&quot; mode which prints nothing on bp hits.</span>
<span class="sd">        -S &lt;sym_expr&gt;:&lt;argidx&gt; - Add a sniper break for arg index</span>

<span class="sd">        NOTE: A &quot;recon format&quot; is a special format sequence which tells the</span>
<span class="sd">              recon subsystem how to present the argument data for a given</span>
<span class="sd">              breakpoint hit.</span>

<span class="sd">        Recon Format:</span>
<span class="sd">        C - A character</span>
<span class="sd">        I - A decimal integer</span>
<span class="sd">        P - A pointer (display symbol if possible)</span>
<span class="sd">        S - An ascii string (up to 260 chars)</span>
<span class="sd">        U - A unicode string (up to 260 chars)</span>
<span class="sd">        X - A hex number</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">vdb.recon</span> <span class="kn">as</span> <span class="nn">v_recon</span>
        <span class="kn">import</span> <span class="nn">vdb.recon.sniper</span> <span class="kn">as</span> <span class="nn">v_sniper</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;recon&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;Architecture&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;i386&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;FIXME: recon only works on i386 right now...&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&#39;A:CHQS:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-A&#39;</span><span class="p">:</span>
                <span class="n">symname</span><span class="p">,</span> <span class="n">reconfmt</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">v_recon</span><span class="o">.</span><span class="n">addReconBreak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span> <span class="n">reconfmt</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-C&#39;</span><span class="p">:</span>
                <span class="n">v_recon</span><span class="o">.</span><span class="n">clearReconHits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-H&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Recon Hits:&#39;</span><span class="p">)</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="n">v_recon</span><span class="o">.</span><span class="n">getReconHits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
                    <span class="n">thrid</span><span class="p">,</span> <span class="n">savedeip</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argrep</span> <span class="o">=</span> <span class="n">hit</span>
                    <span class="n">argstr</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argrep</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%6d</span><span class="s">] 0x</span><span class="si">%.8x</span><span class="s"> </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thrid</span><span class="p">,</span> <span class="n">savedeip</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span> <span class="n">argstr</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> total hits&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-Q&#39;</span><span class="p">:</span>
                <span class="n">newval</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">getMeta</span><span class="p">(</span><span class="s">&#39;recon_quiet&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s">&#39;recon_quiet&#39;</span><span class="p">,</span> <span class="n">newval</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Recon Quiet: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">newval</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-S&#39;</span><span class="p">:</span>
                <span class="n">symname</span><span class="p">,</span> <span class="n">idxstr</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">argidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">idxstr</span><span class="p">)</span>
                <span class="n">v_sniper</span><span class="o">.</span><span class="n">snipeDynArg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span> <span class="n">argidx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_stalker"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_stalker">[docs]</a>    <span class="k">def</span> <span class="nf">do_stalker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Cli front end to the VDB code coverage subsystem. FIXME MORE DOCS!</span>

<span class="sd">        Usage: stalker [options]</span>
<span class="sd">        -C                  - Cleanup stalker breaks and hit info</span>
<span class="sd">        -c                  - Clear the current hits (so you can make more ;)</span>
<span class="sd">        -E &lt;addr_expr&gt;      - Add the specified entry point for tracking</span>
<span class="sd">        -H                  - Show the current hits</span>
<span class="sd">        -L &lt;lib&gt;:&lt;regex&gt;    - Add stalker breaks to all matching library symbols</span>
<span class="sd">        -R                  - Reset all breakpoints to enabled and clear hit info</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">argv</span> <span class="o">=</span> <span class="n">e_cli</span><span class="o">.</span><span class="n">splitargs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;stalker&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&#39;cCE:HIL:R&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">(</span><span class="s">&#39;stalker&#39;</span><span class="p">)</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optarg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-c&#39;</span><span class="p">:</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">clearStalkerHits</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Clearing Stalker Hits...&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-C&#39;</span><span class="p">:</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">clearStalkerBreaks</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">clearStalkerHits</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Cleaning up stalker breaks and hits&#39;</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-E&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">parseExpression</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">addStalkerEntry</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Added 0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-H&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Current Stalker Hits:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">hitva</span> <span class="ow">in</span> <span class="n">v_stalker</span><span class="o">.</span><span class="n">getStalkerHits</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;0x</span><span class="si">%.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">hitva</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-L&#39;</span><span class="p">:</span>
                <span class="n">libname</span><span class="p">,</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">optarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">searchSymbols</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">libname</span><span class="o">=</span><span class="n">libname</span><span class="p">):</span>
                    <span class="n">v_stalker</span><span class="o">.</span><span class="n">addStalkerEntry</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">long</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Stalking </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-R&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Resetting all breaks and hit info&#39;</span><span class="p">)</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">clearStalkerHits</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">v_stalker</span><span class="o">.</span><span class="n">resetStalkerBreaks</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Vdb.do_status"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.do_status">[docs]</a>    <span class="k">def</span> <span class="nf">do_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Print out the status of the debugger / trace...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTrace</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isAttached</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Trace Not Attached...&#39;</span><span class="p">)</span>

        <span class="n">running</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">()</span>
        <span class="n">runmsg</span> <span class="o">=</span> <span class="s">&#39;stopped&#39;</span>
        <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">runmsg</span> <span class="o">=</span> <span class="s">&#39;running&#39;</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getPid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&#39;Attached to pid: </span><span class="si">%d</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">runmsg</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Vdb.FIXME_do_remote"><a class="viewcode-back" href="../vdb.html#vdb.Vdb.FIXME_do_remote">[docs]</a>    <span class="k">def</span> <span class="nf">FIXME_do_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Act as a remote debugging client to the server running on</span>
<span class="sd">        the specified host/ip.</span>

<span class="sd">        Usage: remote &lt;host&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vtrace</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">line</span>
        <span class="c"># FIXME how do we re-init the debugger?</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Visi Debugger  documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, @invisig0th.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>